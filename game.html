<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>æ”¿æ²»ã‚²ãƒ¼ãƒ </title>
    <style>
        body {
            font-family: 'serif';
            background: #2c3e50;
            color: #ecf0f1;
            margin: 0;
            padding: 20px;
        }

        .dashboard {
            max-width: 800px;
            margin: 0 auto;
            background: #34495e;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #bdc3c7;
        }

        .header {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #7f8c8d;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .leader-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid #f1c40f;
            margin-right: 20px;
            object-fit: cover;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .stat-card {
            background: #2c3e50;
            padding: 15px;
            border-radius: 5px;
        }

        .cabinet-card {
            background: #9b9b9b;
            padding: 15px;
            border-radius: 5px;
        }

        .cabinet-card text {
            color: #f1c40f;
        }

        .stat-val {
            font-size: 1.2em;
            font-weight: bold;
            color: #f1c40f;
        }

        .ideology-tag {
            display: inline-block;
            padding: 5px 10px;
            background: #e67e22;
            border-radius: 4px;
            font-size: 0.8em;
            margin-top: 5px;
        }

        /* NPCãƒªã‚¹ãƒˆå°‚ç”¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼è¨­å®š */
        #npc-list::-webkit-scrollbar {
            width: 6px;
        }

        #npc-list::-webkit-scrollbar-track {
            background: #2c3e50;
            border-radius: 10px;
        }

        #npc-list::-webkit-scrollbar-thumb {
            background: #7f8c8d;
            border-radius: 10px;
        }

        #npc-list::-webkit-scrollbar-thumb:hover {
            background: #4ecca3;
        }

        /* é€šçŸ¥ã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆå³å´ã«å›ºå®šï¼‰ */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            /* ä¸‹ã®è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ */
        }

        /* é€šçŸ¥æœ¬ä½“ */
        .toast-card {
            pointer-events: auto;
            /* ã‚«ãƒ¼ãƒ‰å†…ã¯ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã« */
            width: 280px;
            background: rgba(44, 62, 80, 0.95);
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-left: 5px solid #3498db;
            position: relative;
            animation: slideInRight 0.3s ease-out;
            font-size: 0.9em;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-close {
            position: absolute;
            top: 5px;
            right: 8px;
            cursor: pointer;
            font-size: 1.2em;
            opacity: 0.7;
        }

        .toast-close:hover {
            opacity: 1;
        }
    </style>
</head>

<body>

    <div class="dashboard">
        <div>
            <span id="display-date" style="font-size: 1.5em; font-weight: bold; color: #4ecca3;">2026å¹´ 1æœˆ 1æ—¥</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="setGameSpeed(0)" id="btn-pause"
                style="background: #e74c3c; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">ä¸€æ™‚åœæ­¢</button>
            <button onclick="setGameSpeed(1)" id="btn-play"
                style="background: #4ecca3; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">å†ç”Ÿ</button>
            <button onclick="setGameSpeed(3)" id="btn-fast"
                style="background: #f1c40f; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">æ—©é€ã‚Š</button>
            <button onclick="setGameSpeed(50)" id="btn-skip"
                style="background: hsl(113, 89%, 50%); border: none; padding: 10px; border-radius: 5px; cursor: pointer;">ã‚¹ã‚­ãƒƒãƒ—</button>
        </div>
        <div class="stat-card" style="margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>ğŸ—³ï¸ æ¬¡ã®å¤§çµ±é ˜é¸æŒ™ã¾ã§: <strong id="election-days-left">1460</strong> æ—¥</span>
                <button onclick="openElectionHistory()"
                    style="background: #3498db; border: none; padding: 5px 10px; color: white; border-radius: 4px; cursor: pointer; font-size: 0.8em;">é¸æŒ™å±¥æ­´ãƒ»åˆ†æ</button>
                <button onclick="openPartyMenu()"
                    style="background: #3498db; border: none; padding: 5px 10px; color: white; border-radius: 4px; cursor: pointer; font-size: 0.8em;">å…šãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
            </div>
            <div style="width: 100%; background: #2c3e50; height: 10px; border-radius: 5px; margin-top: 5px;">
                <div id="election-progress"
                    style="width: 0%; background: #f1c40f; height: 100%; border-radius: 5px; transition: width 0.3s;">
                </div>
            </div>
        </div>

        <div class="cabinet-card" style="margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="color:#f1c40f; text-align:center;">ğŸ—³ï¸å¤§çµ±é ˜ã®çŠ¶æ³:</h2>
                <button onclick="showMilitaryModal();">è»ã®çŠ¶æ³</button>
                <button onclick="showCabinetAnnouncement();">å¤§çµ±é ˜ã®éƒ¨ä¸‹</button>
            </div>
        </div>

        <div id="voting-modal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2500; justify-content:center; align-items:center;">
            <div class="dashboard" style="width:90%; max-width:500px; text-align:center;">
                <h2 id="voting-title">æŠ•ç¥¨å…ˆã‚’é¸ã‚“ã§ãã ã•ã„</h2>
                <div id="candidate-options"
                    style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:20px 0;">
                </div>
            </div>
        </div>

        <div id="universal-modal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; justify-content:center; align-items:center; overflow-y: auto;">
            <div class="dashboard" style="width:90%; max-width:600px; position:relative; animation: modalFadeIn 0.3s;">
                <h2 id="modal-title"
                    style="color:#f1c40f; text-align:center; border-bottom: 2px solid #f1c40f; padding-bottom:10px;">
                    ã‚¿ã‚¤ãƒˆãƒ«</h2>

                <div id="modal-body" style="margin:20px 0; max-height: 70vh; overflow-y: auto;">
                </div>

                <div id="modal-footer" style="display:flex; gap:10px; justify-content:center;">
                </div>
            </div>
        </div>

        <style>
            @keyframes modalFadeIn {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        </style>

        <div id="election-result-modal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:2000; overflow-y: auto; padding: 20px; box-sizing: border-box;">
            <div id="election-content" style="max-width: 800px; margin: 0 auto; color: white;">
            </div>
            <button onclick="closeElectionModal()" id="election-close"
                style="display:block; margin: 20px auto; padding: 10px 40px; background: #e74c3c; border: none; color: white; border-radius: 5px; cursor: pointer;">é–‰ã˜ã‚‹</button>
        </div>
        <div class="header">
            <img id="display-icon" class="leader-icon" src="" alt="æŒ‡å°è€…ã‚¢ã‚¤ã‚³ãƒ³">
            <div>
                <h1 id="display-name" style="margin: 0;">æ°å</h1>
                <div id="ideology-label" class="ideology-tag">æ€æƒ³ï¼šè§£æä¸­...</div>
            </div>
        </div>

        <div class="status-grid">
            <div class="stat-card">
                <label>çµŒæ¸ˆè»¸</label>
                <div id="val-econ" class="stat-val">--</div>
                <small id="desc-econ"></small>
            </div>
            <div class="stat-card">
                <label>çµ±æ²»è»¸</label>
                <div id="val-gov" class="stat-val">--</div>
                <small id="desc-gov"></small>
            </div>
            <div class="stat-card">
                <label>å¤–äº¤è»¸</label>
                <div id="val-diplomatic" class="stat-val">--</div>
                <small id="desc-diplomatic"></small>
            </div>
        </div>
        <div class="dashboard" style="margin-top: 20px;">
            <h2>äººç‰©ãŸã¡</h2>

            <div style="margin-bottom: 15px;">
                <input type="text" id="npc-search" placeholder="åå‰ã‚„æ€æƒ³ã§æ¤œç´¢..."
                    style="width: 100%; padding: 10px; border-radius: 5px; border: none;">
            </div>
            <button onclick="addNewNPC()"
                style="width: 100%; background: #4ecca3; border: none; padding: 10px; border-radius: 5px; cursor: pointer; color: #1a1a2e; font-weight: bold; margin-bottom: 15px;">
                ï¼‹ æ–°ã—ã„äººç‰©ã‚’è¿½åŠ 
            </button>

            <div id="npc-list" style="
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 10px; 
    max-height: 400px; 
    overflow-y: auto; 
    padding-right: 5px;
"></div>
            <div id="npc-modal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center;">
                <div class="dashboard" style="width:90%; max-width:400px;">
                    <h3>äººç‰©ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</h3>
                    <label>åå‰</label>
                    <input type="text" id="edit-npc-name"
                        style="width:100%; padding:8px; box-sizing:border-box; margin-bottom:10px;">

                    <label>ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š</label>
                    <div style="display: flex; gap: 5px; margin-bottom:10px;">
                        <input type="text" id="edit-npc-seed" placeholder="ã‚·ãƒ¼ãƒ‰å€¤" style="flex: 2; padding:8px;">
                        <label
                            style="flex: 1; background: #3498db; padding: 8px; border-radius: 4px; text-align: center; cursor: pointer; font-size: 0.8em; color: white;">
                            ç”»åƒé¸æŠ
                            <input type="file" id="npc-image-upload" accept="image/*" style="display: none;">
                        </label>
                    </div>

                    <div style="text-align:center; margin:10px;">
                        <img id="edit-npc-preview" src=""
                            style="width:80px; height:80px; border-radius:50%; background:#2c3e50; border: 2px solid #bdc3c7;">
                    </div>

                    <div style="display:flex; gap:10px;">
                        <button id="save-npc-btn"
                            style="flex:1; background:#4ecca3; border:none; padding:10px; border-radius:5px; cursor:pointer;">ä¿å­˜</button>
                        <button onclick="closeModal()"
                            style="flex:1; background:#e74c3c; border:none; padding:10px; border-radius:5px; cursor:pointer; color:white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </div>
            </div>

        </div>
</body>


<script>
    let president = null;

    let currentCabinet = {
        vicePresident: null,    // å‰¯å¤§çµ±é ˜
        stateSecretary: null,   // å›½å‹™é•·å®˜
        justiceSecretary: null, // å¸æ³•é•·å®˜
        defenseSecretary: null, // å›½é˜²é•·å®˜
        commerceSecretary: null,// å•†å‹™é•·å®˜
        homelandSecretary: null // å›½åœŸé–‹ç™ºé•·å®˜
    };

    // å½¹è·åã¨èª¬æ˜ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const CABINET_ROLES = {
        vicePresident: "å‰¯å¤§çµ±é ˜",
        stateSecretary: "å›½å‹™é•·å®˜",
        justiceSecretary: "å¸æ³•é•·å®˜",
        defenseSecretary: "å›½é˜²é•·å®˜",
        commerceSecretary: "å•†å‹™é•·å®˜",
        homelandSecretary: "å›½åœŸé–‹ç™ºé•·å®˜"
    };
    let presidentElect = null; // æ¬¡æœŸå½“é¸è€…
    let presidenttermcount = null;
    let gameDate = new Date(2026, 0, 1); // é–‹å§‹æ—¥

    const lastNames = ["ä½è—¤", "éˆ´æœ¨", "é«˜æ©‹", "ç”°ä¸­", "ä¼Šè—¤", "æ¸¡è¾º", "å±±æœ¬", "ä¸­æ‘", "å°æ—", "åŠ è—¤", "å‰ç”°", "å±±ç”°", "ä½ã€…æœ¨", "å±±å£", "æ¾æœ¬",
        "ã‚¸ãƒ§ãƒ³", "ã‚¢ãƒ«", "ãƒãƒ¼ãƒãƒ¼ãƒ‰", "ãƒãƒ¼ãƒãƒ¼ãƒˆ", "ãƒ‰ãƒŠãƒ«ãƒ‰", "ã‚¸ãƒ§ãƒ¼", "ã‚¸ãƒ§ã‚»ãƒ•", "ã‚¸ãƒ§ãƒ¼ã‚¸", "ã‚²ã‚ªãƒ«ã‚¯", "ã‚¢ãƒ‰ãƒ«ãƒ•", "ã‚¢ãƒ­ã‚¤ã‚¹", "ãƒãƒ¼ãƒ†ã‚£ãƒ³", "ã‚¦ã‚£ãƒªã‚¢ãƒ ", "ãƒ•ãƒ©ãƒ³ã‚¯",
        "ãƒ•ãƒ©ãƒ³ã‚¯ãƒªãƒ³", "ã‚«ãƒ«ãƒ´ã‚£ãƒ³", "ã‚«ãƒ«ãƒ“ãƒ³", "ãƒ¦ã‚¹ãƒ•", "ãƒ¨ã‚»ãƒ•", "ãƒ¨ã‚»ãƒ¼ãƒ—", "ãƒ¬ã‚·ãƒ—", "ãƒ¬ã‚·ãƒƒãƒ—", "ã‚¸ã‚§ãƒ¼ãƒ ã‚º", "ã‚¸ã‚§ãƒ¼ãƒ ã‚¹", "ã‚¸ã‚§ã‚¤ãƒ ã‚º", "ã‚¢ãƒ¼ã‚µãƒ¼",
        "ãƒãƒ£ãƒ¼ãƒ«ã‚º", "ã‚¦ã‚£ãƒ³ã‚¹ãƒˆãƒ³", "ã‚¦ã‚£ãƒ³ãƒˆãƒ³", "ãƒŸãƒ©ãƒ¼ãƒ‰", "ã‚¶ã‚«ãƒªãƒ¼", "ã‚¢ãƒ³ãƒ‰ãƒªãƒ¥ãƒ¼", "ã‚¢ãƒ³ãƒ‰ãƒ«ãƒ¼", "æ", "ã‚­ã‚¢", "ãƒªã‚·", "ãƒœãƒªã‚¹", "ãƒœãƒ–", "ãƒ“ãƒ«", "ã‚°ãƒ­ãƒãƒ¼", "ã‚°ãƒ­ãƒ´ã‚¡ãƒ¼"
        , "ãƒãƒªãƒ¼", "ã‚¸ãƒ§ãƒ³ã‚½ãƒ³", "ã‚¸ãƒ§ãƒ¼ãƒ³", "ã‚·ãƒ§ãƒ¼ãƒ³", "ã‚·ãƒ§ãƒ³", "ãƒ•ãƒ©ãƒ³ã‚­ãƒ³", "ã‚¢ãƒ«ãƒ•ãƒ¬ãƒƒãƒ‰", "çŸ³äº•", "çŸ³ç”°", "çŸ³å·", "ãƒ˜ãƒ³ãƒªãƒ¼", "ãƒ’ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆ", "ãƒ‹ã‚³ãƒ©ã‚¹",
        "ã‚¸ãƒ§ãƒ©ã‚¤", "ã‚·ãƒ§ãƒ©ã‚¤", "ãƒ›ãƒ¬ã‚¤ã‚·ãƒ§", "ãƒ›ãƒ¼ãƒ¬ã‚¤", "ãƒ›ãƒ¬ã‚¤", "å²©äº•", "å²©å´", "å²©ç”°", "æ–è—¤", "é½‹è—¤", "æ¸•ä¸Š", "æ·µä¸Š", "ç”°å±±"
    ];
    const firstNames = ["å¤ªéƒ", "æ¬¡éƒ", "å¥ä¸€", "æ˜­å¤«", "å’Œä¹Ÿ", "æµ©å¸", "æ‚Ÿ", "ç›´æ¨¹", "ä¸€éƒ", "é€²", "é“å¤«", "æ­£", "ç§€æ¨¹", "è‹±äºŒ", "é›„å¤ª",
        "ã‚¢ãƒ€ãƒ ", "ã‚¢ãƒ€ãƒ ã‚º", "ã‚¢ãƒ€ãƒ ã‚¹", "ã‚¸ã‚§ãƒ•ã‚¡ãƒ¼ã‚½ãƒ³", "ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼", "ãƒ‘ãƒ¯ãƒ¼ãƒ‰", "ãƒ‘ãƒ¼ãƒˆ", "ã‚¹ãƒŸã‚¹", "ãƒ¯ã‚¤ãƒ«ãƒ‰", "ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰", "ãƒ‰ã‚¥ãƒ¼ã‚¤", "ãƒ‰ãƒ¼ã‚¤", "ã‚¹ã‚³ãƒƒãƒˆ", "ã„ã£ãºã„", "ã‚¹ã‚«ãƒƒãƒˆ",
        "ãƒœã‚½ãƒ³", "ãƒã‚ºãƒ³", "æ˜å¤«", "ã‚ããŠ", "ã‚¯ãƒ¼ãƒªãƒƒã‚¸", "ã‚¯ãƒ¼ãƒªãƒ¼", "æ —å³¶", "ã‚·ã‚²ãƒ«", "èŒ‚", "ã—ã’ãŠ", "ã—ã’ãŸ", "ã‚¸ãƒ£ã‚¯ã‚½ãƒ³", "ã‚¸ãƒ£ãƒƒã‚¯ã‚½ãƒ³",
        "ã‚¢ãƒ‡ãƒ ", "ã‚¸ãƒ§ãƒ¼ã‚¤", "ãƒ˜ãƒ³ãƒ•ãƒªãƒ¼", "ãƒ˜ãƒ•ãƒªãƒ¼", "ãƒã‚¯ã‚«ãƒãƒ³", "ãƒã‚¯ã‚¬ãƒãƒ³", "ãƒã‚¯ãƒãƒ³", "ãƒãƒƒã‚¯", "ãƒ€ãƒŠã‚¹", "ã‚¬ãƒŠã‚¹", "ãƒãƒŠã‚¹", "ãƒ©ãƒŠã‚¹",
        "ãƒ©ãƒšã‚¹", "ã‚¸ãƒ§ãƒ³ã‚½ãƒ³", "ã‚¸ãƒ§ãƒ³", "ãƒãƒ¼ãƒŠãƒ¼", "ãƒãƒ¼ãƒŠãƒ¼ãƒ‰", "ãƒãƒ¼ãƒŠãƒ¼ã‚º"
    ];
    const specialMiddles = ["ãƒ»Dãƒ»", "ãƒ»ãƒ•ã‚©ãƒ³ãƒ»", "ãƒ»ãƒ‡ãƒ»", "ãƒ»ãƒ´ã‚¡ãƒ³ãƒ»"];

    // A(65)ã‹ã‚‰Z(90)ã¾ã§ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦è‡ªå‹•ç”Ÿæˆ
    const alphabetMiddles = Array.from({ length: 26 }, (_, i) => `ãƒ»${String.fromCharCode(65 + i)}ãƒ»`);

    // äºŒã¤ã‚’åˆä½“ã•ã›ã¦æœ€å¼·ã®ãƒŸãƒ‰ãƒ«ãƒãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’ä½œã‚‹
    const middleNames = [...specialMiddles, ...alphabetMiddles];
    let electionCountdown = 1;
    let profile = null;
    window.onload = function () {
        // 1. LocalStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const savedData = localStorage.getItem('political_game_data');

        if (!savedData) {
            alert("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
            location.href = 'index.html'; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯æˆ»ã™
            return;
        }

        profile = JSON.parse(savedData);

        npcs = []; // é…åˆ—ã‚’åˆæœŸåŒ–

        gameDate = profile.startYear || 2024;
        gameDate = new Date(gameDate, 0, 1); // æœˆã¯0ã‹ã‚‰å§‹ã¾ã‚‹ã®ã§0=1æœˆ

        // 1. ã¾ãšã‚«ã‚¹ã‚¿ãƒ NPCã‚’ãƒªã‚¹ãƒˆã«å…¥ã‚Œã‚‹
        if (profile.customNPCs && profile.customNPCs.length > 0) {
            profile.customNPCs.forEach(c => {
                npcs.push({
                    id: "custom-" + Math.random().toString(36).substr(2, 9),
                    name: c.name,
                    icon: c.icon,
                    isPlayer: false,
                    termCount: 0,
                    military: null,
                    ideology: {
                        economy: parseInt(c.ideology.economy),
                        government: parseInt(c.ideology.government),
                        diplomacy: parseInt(c.ideology.diplomacy)
                    },
                    isCustom: true // ã‚«ã‚¹ã‚¿ãƒ NPCãƒ•ãƒ©ã‚°
                });
            });
        }

        // 2. HTMLè¦ç´ ã«åæ˜ 
        document.getElementById('display-name').innerText = profile.name;
        document.getElementById('display-icon').src = profile.icon;

        // æ€æƒ³æ•°å€¤ã®åæ˜ 
        const econ = profile.ideology.economy;
        const gov = profile.ideology.government;
        const diplo = profile.ideology.diplomacy;

        document.getElementById('val-econ').innerText = econ;
        document.getElementById('val-gov').innerText = gov;
        document.getElementById('val-diplomatic').innerText = diplo;

        // 3. æ•°å€¤ã«åŸºã¥ã„ãŸç°¡æ˜“èª¬æ˜ã®è¡¨ç¤º
        document.getElementById('desc-econ').innerText = econ > 60 ? "å¸‚å ´çµŒæ¸ˆé‡è¦–" : (econ < 40 ? "è¨ˆç”»çµŒæ¸ˆé‡è¦–" : "æ··åˆçµŒæ¸ˆ");
        document.getElementById('desc-gov').innerText = gov > 60 ? "ç§©åºã¨æ¨©å¨" : (gov < 40 ? "å€‹äººã®è‡ªç”±" : "ä¸­åº¸ãªçµ±æ²»");
        document.getElementById('desc-diplomatic').innerText = gov > 60 ? "å›½å®¶ã«é›†ä¸­" : (gov < 40 ? "è‡ªç”±å¤–äº¤" : "æ™®é€šå¤–äº¤");

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã§è¨­å®šã—ãŸäººæ•°åˆ†ã ã‘ä½œæˆ
        const count = profile.initialNpcCount || 5;
        for (let i = 0; i < count; i++) {
            const uniqueName = generateComplexName(); // é€²åŒ–ã—ãŸåå‰ã‚’ç”Ÿæˆ
            npcs.push(createRandomNPC(uniqueName));
        }
        // åˆå›ç”Ÿæˆåˆ†ã‚’ä¿å­˜

        // 4. ç§°å·ã®åˆ¤å®šï¼ˆãŠã¾ã‘ï¼‰
        let title = "ä¸­é“";
        if (gov > 70 && econ > 70) title = "é‡‘ã˜ã‚ƒã‚“ã˜ã‚ƒã‚“ä¸»ç¾©";
        if (gov < 30 && econ < 30) title = "å¹³ç­‰ä¸»ç¾©ã®éæ¿€æ´¾";
        if (gov > 70 && econ < 30) title = "ç‹¬è£è€…";
        if (gov < 30 && econ > 70) title = "è‡ªç”±ä¸»ç¾©è€…";

        renderNPCs("", profile.ideology);


        document.getElementById('ideology-label').innerText = "ç·åˆçš„ãªæ€æƒ³: " + title;

        document.getElementById('edit-npc-seed').addEventListener('input', (e) => {
            const seed = e.target.value || "default";
            document.getElementById('edit-npc-preview').src = `https://api.dicebear.com/9.x/personas/svg?seed=${seed}`;
        });
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        document.getElementById('npc-image-upload').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('edit-npc-preview').src = event.target.result;
                    document.getElementById('edit-npc-seed').value = ""; // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã¯ã‚·ãƒ¼ãƒ‰ã‚’ç©ºã«
                };
                reader.readAsDataURL(file);
            }
        });
    };

    let annualPoliticsLog = {
        invited: [],
        expelled: []
    };

    function resetAnnualLog() {
        annualPoliticsLog = {
            invited: [],
            expelled: []
        };
    }
    /**
 * æ”¿å…šã®æ—¥å¸¸çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ‹›å¾…ãƒ»é™¤åãƒ»çµ±åˆï¼‰ã‚’å‡¦ç†ã™ã‚‹
 */
    function processDailyPartyAction() {
        if (Math.random() > 0.01) return;

        const activeParties = parties.filter(p => p.active);
        if (activeParties.length === 0) return;

        const party = activeParties[Math.floor(Math.random() * activeParties.length)];
        const rand = Math.random();

        if (rand < 0.50) { // æ‹›å¾… (60%â†’50%ã«å¾®æ¸›)
            const target = npcs[Math.floor(Math.random() * npcs.length)];

            // ä¿®æ­£ï¼šæ—¢ã«åŒã˜å…šãªã‚‰ä½•ã‚‚ã—ãªã„
            if (target.partyId === party.id) return;

            // ä¿®æ­£ï¼šç§»ç±å‡¦ç†ï¼ˆå‰ã®å…šã‹ã‚‰è„±é€€ã•ã›ã‚‹ï¼‰
            if (target.partyId) {
                const oldParty = parties.find(p => p.id === target.partyId);
                if (oldParty) oldParty.members = oldParty.members.filter(m => m.id !== target.id);
            }

            target.partyId = party.id;
            if (!party.members.some(m => m.id === target.id)) {
                party.members.push(target);
            }
            showToast(`ğŸ¤ æ”¿å…šç§»ç±: ${party.name}`, `${target.name} æ°ãŒå…šã«åŠ ã‚ã‚Šã¾ã—ãŸã€‚`, party.color);
            annualPoliticsLog.invited.push({ partyName: party.name, personName: target.name });

        } else if (rand < 0.80) { // é™¤å (30%)
            // ä¿®æ­£ï¼šãƒ¡ãƒ³ãƒãƒ¼ãŒ3äººä»¥ä¸Šã€ã‹ã¤ã€Œä»£è¡¨ï¼ˆparty.leaderï¼‰ä»¥å¤–ã€ã‹ã‚‰é¸ã¶
            const candidatesForExpulsion = party.members.filter(m => m.id !== party.leader.id);

            if (candidatesForExpulsion.length > 0) {
                const target = candidatesForExpulsion[Math.floor(Math.random() * candidatesForExpulsion.length)];

                // å…šã®ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                party.members = party.members.filter(m => m.id !== target.id);
                if (!target.isPlayer) target.partyId = null;

                showToast(`ğŸš« æ”¿å…šé™¤å: ${party.name}`, `${target.name} æ°ãŒå…šã‹ã‚‰è¿½æ”¾ã•ã‚Œã¾ã—ãŸã€‚`, "#e74c3c");
                annualPoliticsLog.expelled.push({ partyName: party.name, personName: target.name });
            }

        } else if (rand < 0.90) { // çµ±åˆ (10%ã«ã‚¢ãƒƒãƒ—)
            const otherParty = activeParties.find(p => p.id !== party.id);
            if (otherParty) {
                const aff = calculateAffinity(party.leader.ideology, otherParty.leader.ideology);
                const mergeChance = 0.1 + (aff / 500); // ç¢ºç‡ã‚’åº•ä¸Šã’

                if (Math.random() < mergeChance) {
                    const oldName = otherParty.name;
                    // äºŒé‡ç™»éŒ²ã‚’é˜²ãã¤ã¤åˆæµ
                    otherParty.members.forEach(m => {
                        if (!party.members.some(pm => pm.id === m.id)) {
                            party.members.push(m);
                            if (!m.isPlayer) m.partyId = party.id;
                        }
                    });
                    otherParty.active = false;
                    otherParty.members = [];
                    showToast(`ğŸ† æ”¿å…šçµ±åˆï¼`, `${oldName} ãŒ ${party.name} ã¸åˆæµã—ã¾ã—ãŸã€‚`, "#f1c40f");
                }
            }

        } else { // è§£æ•£ (10%ã«ã‚¢ãƒƒãƒ—)
            if (party.active && !party.leader.isPlayer) {
                // è§£æ•£ã—ã‚„ã™ã•ã‚’ã‚¢ãƒƒãƒ—ï¼š5äººæœªæº€ãªã‚‰30%ã€å¤šãã¦ã‚‚10%ã§è§£æ•£
                const dissolveChance = party.members.length < 5 ? 0.30 : 0.10;

                if (Math.random() < dissolveChance) {
                    const oldName = party.name;
                    const oldColor = party.color;
                    const memberCount = party.members.length;

                    party.members.forEach(m => { if (!m.isPlayer) m.partyId = null; });
                    party.active = false;
                    party.dissolvedDate = new Date(gameDate);
                    party.members = [];

                    setGameSpeed(0);
                    const dissolveHtml = `

                    <div style="text-align:center;">

                        <div style="margin: 20px auto; width: 80px; height: 80px; background: ${oldColor}; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid #ccc; position: relative;">

                            <span style="font-size: 50px; color: white; position: absolute;">âœ•</span>

                        </div>

                        <h2 style="color: #e74c3c;">${oldName} è§£æ•£</h2>

                        <p>æœ¬æ—¥ã€<strong>${oldName}</strong> ã¯ãã®æ­´å²ã«å¹•ã‚’é–‰ã˜ã¾ã—ãŸã€‚</p>

                        <p style="font-size: 0.9em; color: #666;">æ‰€å±ã—ã¦ã„ãŸ ${memberCount} åã®è­°å“¡ã¯å…¨å“¡ç„¡æ‰€å±ã¨ãªã‚Šã¾ã—ãŸã€‚</p>

                    </div>

                `;

                    openUniversalModal("ğŸ›ï¸ æ”¿å…šè§£æ•£ã®ãŠçŸ¥ã‚‰ã›", dissolveHtml, [

                        { text: "ç¢ºèª", cb: () => { closeUniversalModal(); setGameSpeed(1); }, color: "#34495e" }

                    ]);

                    annualPoliticsLog.expelled.push({ partyName: oldName, personName: `ã€å…šè‡ªä½“ãŒè§£æ•£ã€‘` });
                }
            }
        }
    }

    function getContrastYIQ(hexcolor) {
        if (!hexcolor) return 'white';
        hexcolor = hexcolor.replace("#", "");
        const r = parseInt(hexcolor.substr(0, 2), 16);
        const g = parseInt(hexcolor.substr(2, 2), 16);
        const b = parseInt(hexcolor.substr(4, 2), 16);
        const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        return (yiq >= 128) ? 'black' : 'white';
    }
    // é€šçŸ¥ã‚’è¡¨ç¤ºã™ã‚‹æ±ç”¨é–¢æ•°
    function showToast(title, message, color = "#3498db") {
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            document.body.appendChild(container);
        }

        const toast = document.createElement('div');
        toast.className = 'toast-card';
        // èƒŒæ™¯è‰²ã¨ã€æ–‡å­—ã®èª­ã¿ã‚„ã™ã•ã‚’è‡ªå‹•èª¿æ•´
        toast.style.backgroundColor = color;
        toast.style.color = getContrastYIQ(color);
        toast.style.borderLeft = "none"; // è‰²ã¤ãã‚«ãƒ¼ãƒ‰ã«ã™ã‚‹ã®ã§ãƒœãƒ¼ãƒ€ãƒ¼ã¯ä¸è¦

        toast.innerHTML = `
        <span class="toast-close" style="color:${getContrastYIQ(color)}">&times;</span>
        <div style="font-weight: bold; margin-bottom: 3px; font-size: 1em;">${title}</div>
        <div style="font-size: 0.85em; opacity: 0.9;">${message}</div>
    `;

        const closeBtn = toast.querySelector('.toast-close');
        closeBtn.onclick = () => {
            toast.style.animation = "slideInRight 0.3s ease-in reverse forwards";
            setTimeout(() => toast.remove(), 300);
        };

        setTimeout(() => { if (toast.parentElement) closeBtn.click(); }, 5000);
        container.appendChild(toast);
    }

    // æ±ç”¨ç³» //
    /**
     * @param {string} title - ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«
     * @param {string} htmlContent - ä¸­èº«ã®HTMLï¼ˆæ–‡å­—åˆ—ã§OKï¼‰
     * @param {Array} buttons - ãƒœã‚¿ãƒ³ã®é…åˆ— [{text: "æ–‡å­—", cb: é–¢æ•°, color: "è‰²"}]
     */
    function openUniversalModal(title, htmlContent, buttons = []) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-body').innerHTML = htmlContent;

        const footer = document.getElementById('modal-footer');
        footer.innerHTML = ""; // ä»¥å‰ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªã‚¢

        buttons.forEach(btnInfo => {
            const btn = document.createElement('button');
            btn.innerText = btnInfo.text;
            btn.style.cssText = `padding:10px 20px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; background:${btnInfo.color || '#4ecca3'}; color:white;`;
            btn.onclick = () => {
                btnInfo.cb(); // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
            };
            footer.appendChild(btn);
        });

        document.getElementById('universal-modal').style.display = 'flex';
    }

    function closeUniversalModal() {
        document.getElementById('universal-modal').style.display = 'none';
    }
    // æ±ç”¨ã‚·ãƒªãƒ¼ã‚ºçµ‚ã‚ã‚Š //

    function generateComplexName() {
        const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
        const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
        const rand = Math.random(); // 0.0 ã€œ 1.0

        if (rand < 0.10) {
            // 10%ã®ç¢ºç‡ã§ã€Œã€‡ã€‡2ä¸–ã€
            const suffixes = ["2ä¸–", "Jr.", "3ä¸–", "å¿"];
            const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
            return `${lastName}ãƒ»${firstName}${suffix}`;
        } else if (rand < 0.20) {
            // æ¬¡ã®10%ã®ç¢ºç‡ã§ã€ŒãƒŸãƒ‰ãƒ«ãƒãƒ¼ãƒ ã€
            const middle = middleNames[Math.floor(Math.random() * middleNames.length)];
            return `${lastName}${middle}${firstName}`;
        } else {
            // æ®‹ã‚Š80%ã¯é€šå¸¸ã®ã€Œè‹—å­— åå‰ã€
            return `${lastName}ãƒ»${firstName}`;
        }
    }


    function createRandomNPC(name) {
        // ãƒ©ãƒ³ãƒ€ãƒ ãªã‚·ãƒ¼ãƒ‰æ–‡å­—åˆ—ã‚’ç”Ÿæˆ
        const randomSeed = Math.random().toString(36).substring(7);
        const icons = ["adventurer", "adventurer-neutral", "avataaars", "avataaars-neutral", "big-ears", "big-ears-neutral", "personas", "thumbs", "toon-head", "fun-emoji", "pixel-art", "pixel-art-neutral"];
        const icons1 = icons[Math.floor(Math.random() * icons.length)];

        return {
            id: Date.now() + Math.random(), // ğŸ’¥ å›ºæœ‰ã®IDã‚’è¿½åŠ 
            name: name,
            termCount: 0,
            // DiceBear APIã‚’ä½¿ç”¨ (seedã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«)
            icon: `https://api.dicebear.com/9.x/${icons1}/svg?seed=${randomSeed}`,
            ideology: {
                economy: Math.floor(Math.random() * 101),
                government: Math.floor(Math.random() * 101),
                diplomacy: Math.floor(Math.random() * 101)
            }
        };
    }

    // NPCã®ãƒ‡ãƒ¼ã‚¿é…åˆ—
    let npcs = [
    ];

    // æ€æƒ³ã®è¿‘ã•ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼ˆè¦ªå¯†åº¦ï¼‰
    function calculateAffinity(ideology1, ideology2) {
        // å„è»¸ã®å·®ã®çµ¶å¯¾å€¤ã‚’åˆè¨ˆã—ã€100ã‹ã‚‰å¼•ãï¼ˆå˜ç´”ãªè·é›¢è¨ˆç®—ï¼‰
        const diffEcon = Math.abs(ideology1.economy - ideology2.economy);
        const diffGov = Math.abs(ideology1.government - ideology2.government);
        const diffDipl = Math.abs(ideology1.diplomacy - ideology2.diplomacy);

        const avgDiff = (diffEcon + diffGov + diffDipl) / 3;
        return Math.round(100 - avgDiff); // 100ã«è¿‘ã„ã»ã©ä»²è‰¯ã—
    }
    let currentEditingIndex = null;

    function renderNPCs(filterText = "", playerIdeology) {
        const listElement = document.getElementById('npc-list');
        listElement.innerHTML = "";

        npcs.forEach((npc) => {
            if (!npc.name.includes(filterText)) return;

            const affinity = calculateAffinity(playerIdeology, npc.ideology);
            const title = getIdeologyTitle(npc.ideology); // ç§°å·ã‚’å–å¾—

            const card = document.createElement('div');
            card.className = "stat-card";
            card.style.cursor = "pointer";

            // ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼šindexã§ã¯ãªãnpc.idã‚’ä½¿ã£ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            card.onclick = () => openNpcModal(npc.id);

            card.innerHTML = `
            <div style="display:flex; align-items:center; margin-bottom:5px;">
                <img src="${npc.icon}" style="width:40px; height:40px; border-radius:50%; margin-right:10px; background:#2c3e50;">
                <div>
                    <div style="font-weight:bold;">${npc.name}</div>
                    <div style="font-size:0.7em; color:${affinity > 55 ? '#4ecca3' : '#e74c3c'}">
                        é–¢ä¿‚: ${affinity}%
                    </div>
                </div>
            </div>
            <div class="ideology-tag" style="font-size: 0.65em; margin-top: 2px; background: #3498db;">
                ${title}
            </div>
        `;
            listElement.appendChild(card);
        });
    }

    // --- æ–°ã—ã„NPCã‚’è¿½åŠ ã™ã‚‹é–¢æ•° ---
    function addNewNPC() {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§æ–°ã—ã„NPCã‚’ä½œæˆ
        const newNpc = createRandomNPC("æ–°ã—ã„äººç‰©");
        // é…åˆ—ã®å…ˆé ­ã«è¿½åŠ 
        npcs.unshift(newNpc);

        // ãã®ã¾ã¾ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        const playerIdeology = JSON.parse(localStorage.getItem('political_game_data')).ideology;
        renderNPCs("", playerIdeology);
    }

    // ã‚¤ãƒ‡ã‚ªãƒ­ã‚®ãƒ¼å–å¾—
    // æ€æƒ³ã‚¹ã‚³ã‚¢ã‹ã‚‰ç§°å·ï¼ˆæ€æƒ³åï¼‰ã‚’è¿”ã™å…±é€šé–¢æ•°
    function getIdeologyTitle(ideology) {
        const { economy: econ, government: gov } = ideology;
        let title = "ä¸­é“";
        if (gov < 30 && econ < 30) title = "å¹³ç­‰ä¸»ç¾©ã®éæ¿€æ´¾"; // å…ƒï¼šå¹³ç­‰ä¸»ç¾©ã®éæ¿€æ´¾
        if (gov > 70 && econ < 30) title = "ç‹¬è£è€…";   // å…ƒï¼šç‹¬è£è€…
        if (gov < 30 && econ > 70) title = "è‡ªç”±ä¸»ç¾©"; // å…ƒï¼šè‡ªç”±ä¸»ç¾©è€…

        // ã•ã‚‰ã«ç´°ã‹ãåˆ†å²ã•ã›ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™
        return title;
    }

    // --- ä¿å­˜å‡¦ç†ã®ä¿®æ­£ (ä¿å­˜ãƒœã‚¿ãƒ³ã®onclickå†…) ---
    // --- 1. ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ¶å¾¡ (DiceBear & ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰) ---

    // ã‚·ãƒ¼ãƒ‰å€¤å…¥åŠ›

    // --- 2. ä¿å­˜å‡¦ç† (ä¸€ç®‡æ‰€ã«çµ±åˆ) ---
    // --- ä¿å­˜å‡¦ç†ï¼ˆã“ã‚Œ1ã¤ã ã‘ã«ã—ã¦ãã ã•ã„ï¼ï¼‰ ---
    document.getElementById('save-npc-btn').onclick = () => {
        // currentEditingIdã‚’ä½¿ã£ã¦ã€å…ƒã®é…åˆ—ã‹ã‚‰è©²å½“è€…ã‚’æ¢ã™
        const targetNpc = npcs.find(n => n.id === currentEditingId);
        if (!targetNpc) return;

        targetNpc.name = document.getElementById('edit-npc-name').value;
        targetNpc.icon = document.getElementById('edit-npc-preview').src;

        closeModal();
        const profile = JSON.parse(localStorage.getItem('political_game_data'));
        renderNPCs(document.getElementById('npc-search').value, profile.ideology);
    };

    // --- 3. æ¤œç´¢ã‚¤ãƒ™ãƒ³ãƒˆ ---
    document.getElementById('npc-search').addEventListener('input', (e) => {
        const profile = JSON.parse(localStorage.getItem('political_game_data'));
        renderNPCs(e.target.value, profile.ideology);
    });

    function closeModal() {
        document.getElementById('npc-modal').style.display = 'none';
    }
    // NPCã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

    // 1. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openNpcModal(targetId) {
        // IDãŒä¸€è‡´ã™ã‚‹äººã‚’ä¸€äººæ¢ã™
        const npc = npcs.find(n => n.id === targetId);
        if (!npc) return;

        currentEditingId = targetId; // currentEditingIndexã®ä»£ã‚ã‚Šã«Idã‚’ä½¿ã†

        document.getElementById('edit-npc-name').value = npc.name;
        const seedMatch = npc.icon.match(/seed=([^&]+)/);
        document.getElementById('edit-npc-seed').value = seedMatch ? seedMatch[1] : "";
        document.getElementById('edit-npc-preview').src = npc.icon;
        document.getElementById('npc-modal').style.display = 'flex';
    }

    // 2. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeModal() {
        document.getElementById('npc-modal').style.display = 'none';
    }

    // 3. ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    document.getElementById('edit-npc-seed').addEventListener('input', (e) => {
        const newSeed = e.target.value || "default";
        document.getElementById('edit-npc-preview').src = `https://api.dicebear.com/9.x/personas/svg?seed=${newSeed}`;
    });

    let gameTimer = null;
    let gameSpeed = 0; // 0: åœæ­¢, 1: é€šå¸¸, 3: æ—©é€ã‚Š

    // æ—¥ä»˜ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function updateDateDisplay() {
        const year = gameDate.getFullYear();
        const month = gameDate.getMonth() + 1;
        const day = gameDate.getDate();
        document.getElementById('display-date').innerText = `${year}å¹´ ${month}æœˆ ${day}æ—¥`;
    }
    let dayCounter = 0

    // ã‚²ãƒ¼ãƒ ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹é–¢æ•°
    function setGameSpeed(speed) {
        gameSpeed = speed;

        // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
        if (gameTimer) clearInterval(gameTimer);

        // ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒ0ã‚ˆã‚Šå¤§ãã„ãªã‚‰ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        if (gameSpeed > 0) {
            // é€šå¸¸ã¯1ç§’(1000ms)ã”ã¨ã«1æ—¥é€²ã‚€ã€‚ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒ3ãªã‚‰1/3ã®é€Ÿã•ã§é€²ã‚€
            gameTimer = setInterval(() => {
                gameDate.setDate(gameDate.getDate() + 1);
                updateDateDisplay();
                dayCounter++;

                // --- ã€100æ—¥å‘¨æœŸã€‘è»ã®å…¥é€€éšŠï¼ˆã“ã‚Œã¯é‡ã„ï¼†è¨­å®šé€šã‚Š200æ—¥åˆ¤å®šãŒã‚ã‚‹ã®ã§100æ—¥æ¯ã§OKï¼‰ ---
                if (dayCounter % 100 === 0) {
                    processMilitaryLifeCycle();
                }

                // --- ã€æ¯æ—¥åˆ¤å®šã€‘æ”¿å…šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå†…éƒ¨ã«1%ãªã©ã®ç¢ºç‡ãŒã‚ã‚‹ãŸã‚ã€æ¯æ—¥ãƒãƒ£ãƒ³ã‚¹ã‚’ä¸ãˆã‚‹ï¼‰ ---
                processDailyPartyAction();

                // --- ã€æ¯æ—¥åˆ¤å®šã€‘æ–°å…šçµæˆï¼ˆã“ã‚Œã‚‚å†…éƒ¨ã«ç¢ºç‡ã‚„æ¡ä»¶ãŒã‚ã‚‹ãªã‚‰æ¯æ—¥ã§OKï¼‰ ---
                checkPartyCreationEvent();

                // --- ã€æ¯æ—¥åˆ¤å®šã€‘é¸æŒ™ç®¡ç† ---
                updateElectionStatus();

                // æ¯æœˆ1æ—¥ã«ä½•ã‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’èµ·ã“ã™ãªã‚‰ã“ã“
                if (gameDate.getDate() === 1) {
                    console.log("æœˆã®å§‹ã¾ã‚Šï¼äºˆç®—ã®æ›´æ–°ãªã©...");
                }
            }, 1000 / gameSpeed);
        }

        // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’å¤‰ãˆã‚‹ï¼ˆä»»æ„ï¼‰
        document.getElementById('btn-pause').style.opacity = speed === 0 ? "1" : "0.5";
        document.getElementById('btn-play').style.opacity = speed === 1 ? "1" : "0.5";
        document.getElementById('btn-fast').style.opacity = speed === 3 ? "1" : "0.5";
        document.getElementById('btn-skip').style.opacity = speed === 50 ? "1" : "0.5";

    }
    // é¸æŒ™
    // window.onloadã®å¤–ã‹ã€é©åˆ‡ãªå ´æ‰€ã«è¿½åŠ 
    let electionHistory = []; // æ­´ä»£ã®çµæœã‚’ä¿å­˜

    function updateElectionStatus() {
        // 1. ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®é€²è¡Œï¼ˆé¸æŒ™å‰ã®ã¿æ¸›ã‚‰ã™ï¼‰
        if (electionCountdown > 0) {
            electionCountdown--;
        }

        // 2. é¸æŒ™ã®ç™ºç«ï¼ˆ0ã«ãªã£ãŸç¬é–“ï¼‰
        if (electionCountdown === 0) {
            runElection();
            electionCountdown = -1; // å°±ä»»å¼ã¾ã§ã€Œå¾…æ©Ÿãƒ¢ãƒ¼ãƒ‰ã€ã¸
        }

        // 3. UIæ›´æ–°ï¼ˆãƒã‚¤ãƒŠã‚¹ã‚’è¡¨ç¤ºã•ã›ãªã„ã€100%ã§æ­¢ã‚ã‚‹ï¼‰
        const displayDays = Math.max(0, electionCountdown);
        document.getElementById('election-days-left').innerText = displayDays;

        // é¸æŒ™å¾Œã¯ãƒãƒ¼ã‚’100%ã§å›ºå®šã€é¸æŒ™å‰ã¯è¨ˆç®—
        let progress;
        if (electionCountdown <= 0) {
            progress = 100;
        } else {
            progress = ((1460 - electionCountdown) / 1460) * 100;
        }
        document.getElementById('election-progress').style.width = Math.min(100, progress) + "%";

        // 4. å°±ä»»å¼ã®ãƒã‚§ãƒƒã‚¯ (1æœˆ20æ—¥)
        if (gameDate.getMonth() === 0 && gameDate.getDate() === 20 && presidentElect) {
            holdInauguration();
            // â€»ã“ã®ä¸­ã®å‡¦ç†ã§ electionCountdown = 1460 ã«æˆ»ã‚‹
        }
    }

    // é–£åƒš
    function appointCabinet(newPresident) {
        // 1. å…¨NPCã¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å€™è£œè€…ã¨ã—ã¦ãƒªã‚¹ãƒˆåŒ–ï¼ˆå¤§çµ±é ˜æœ¬äººã¯é™¤ãï¼‰
        let candidates = [...npcs];
        if (typeof player !== 'undefined') {
            candidates.push({ ...player, isPlayer: true, id: "player" });
        }
        candidates = candidates.filter(c => c.id !== newPresident.id);

        // 2. å†…é–£ã‚’ä¸€åº¦ãƒªã‚»ãƒƒãƒˆ
        Object.keys(currentCabinet).forEach(key => currentCabinet[key] = null);

        // 3. ç›¸æ€§ãŒè‰¯ã„é †ã«ã‚½ãƒ¼ãƒˆ
        candidates.sort((a, b) => {
            const affA = calculateAffinity(newPresident.ideology, a.ideology);
            const affB = calculateAffinity(newPresident.ideology, b.ideology);
            return affB - affA;
        });

        // 4. å„ãƒã‚¹ãƒˆã«å‰²ã‚Šå½“ã¦
        let assignedCount = 0;
        const roles = Object.keys(currentCabinet);

        roles.forEach(role => {
            if (candidates.length > 0) {
                // å›½é˜²é•·å®˜ (defenseSecretary) ã®ç‰¹æ®Šãƒ«ãƒ¼ãƒ«
                if (role === "defenseSecretary") {
                    // è»äº‹çš„ãªæ€æƒ³(gov > 70)ã‚’æŒã¤äººã‚’å„ªå…ˆçš„ã«æ¢ã™
                    const militaryIndex = candidates.findIndex(c => c.ideology.gov > 70);
                    if (militaryIndex !== -1) {
                        currentCabinet[role] = candidates.splice(militaryIndex, 1)[0];
                        return;
                    }
                }

                // é€šå¸¸ã®ä»»å‘½ï¼ˆç›¸æ€§é †ï¼‰
                // ç›¸æ€§ãŒä¸€å®šä»¥ä¸‹ï¼ˆä¾‹: 30æœªæº€ï¼‰ãªã‚‰ã€Œç©ºå¸­ã€ã«ã™ã‚‹
                const topCandidate = candidates[0];
                if (calculateAffinity(newPresident.ideology, topCandidate.ideology) >= 30) {
                    currentCabinet[role] = candidates.shift();
                }
            }
        });
    }

    function holdInauguration() {
        setGameSpeed(0); // æ™‚é–“ã‚’æ­¢ã‚ã‚‹

        let farewellMessage = "";
        let isReelection = false;

        // å‰ä»»è€…ãŒå­˜åœ¨ã—ã€ã‹ã¤ä»Šå›ã®å½“é¸è€…ã¨åŒã˜äººç‰©ãªã‚‰ã€Œå†é¸ã€
        if (president && president.name === presidentElect.name) {
            isReelection = true;
            presidenttermcount += 1;
        } else {
            presidenttermcount = 1;
        };

        if (president) {
            // å‰å¤§çµ±é ˜ã¨æ–°å¤§çµ±é ˜ã®æ€æƒ³ç›¸æ€§ã‚’è¨ˆç®—
            const affinity = calculateAffinity(president.ideology, presidentElect.ideology);

            // ç›¸æ€§ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åˆ†å²
            if (affinity >= 80) {
                farewellMessage = `ã€Œ${presidentElect.name}ã€ã‚ãªãŸã¯ã€å¤§çµ±é ˜ã¨ã—ã¦è·å‹™ã‚’é ‘å¼µã£ã¦ãã ã•ã„ã€å¿œæ´ã—ã¦ã„ã¾ã™ã€‚ã€`;
            } else if (affinity >= 50) {
                farewellMessage = `ã€Œ${presidentElect.name}ã€ã“ã‚Œã‹ã‚‰ã¯ã‚ãªãŸã®æ™‚ä»£ã§ã™ã€é ‘å¼µã£ã¦ãã ã•ã„ã€å¿œæ´ã—ã¦ã¾ã™ã€‚ã€`;
            } else if (affinity >= 30) {
                farewellMessage = `ã€Œ${presidentElect.name}ã€ã‚ãªãŸãŒå¤§çµ±é ˜ã«ãªã‚‹ã¨ã¯æ€ã‚ãªã‹ã£ãŸã€ã“ã‚Œã‹ã‚‰ã®æ™‚ä»£ãŒã©ã†ãªã‚‹ã‹ã‚ã‹ã‚Šã¾ã›ã‚“ãŒã€é ‘å¼µã£ã¦ãã ã•ã„ã€‚ã€`;
            } else {
                farewellMessage = `ã€Œ${presidentElect.name}ã€ã‚ãªãŸãŒå¤§çµ±é ˜ã«ãªã‚‹ã¨ã¯ã ã‚Œã‚‚äºˆæƒ³ã—ã¦ã„ãªã‹ã£ãŸã€æ­£ç›´è¨€ã£ã¦ã“ã‚ŒãŒç¾å®Ÿã ã¨ã¯æ€ã„ãŸããªã„ã€‚ã€`;
            }
        }

        const isPlayer = presidentElect.isPlayer; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå½“é¸ã—ãŸã‹
        const title = isPlayer ? "ã‚ãªãŸã®å°±ä»»å¼" : `${presidentElect.name}å¤§çµ±é ˜å°±ä»»å¼`;
        let html
        if (isReelection) {
            html = `
        <div style="background:#1a2a6c; color:white; padding:30px; border-radius:10px; text-align:center; border: 5px solid #f1c40f;">
            <h1 style="margin-bottom:20px;">ğŸ›ï¸${presidenttermcount}æœŸç›®ã®é–‹å§‹ã¨å°±ä»»å¼</h1>
            <img src="${presidentElect.icon}" style="width:120px; height:120px; border-radius:50%; border:5px solid white; background:white;">
            <h2 style="margin-top:20px;">${presidentElect.name}</h2>
            <p style="font-style:italic; font-size:1.1em; margin:20px 0;">
                ç§ã¯å¤§çµ±é ˜ã¨ã—ã¦ã€å…¨åŠ›ã‚’å°½ãã™ã“ã¨ã‚’èª“ã„ã¾ã™ã€‚
            </p>
            <div style="font-size:0.9em; color:#bdc3c7;">
                ${gameDate.getFullYear()}å¹´1æœˆ20æ—¥ æ­£åˆ
            </div>
        </div>
    `;
        } else {
            html = `
        <div style="background:#1a2a6c; color:white; padding:30px; border-radius:10px; text-align:center; border: 5px solid #f1c40f;">
            <h1 style="margin-bottom:20px;">ğŸ›ï¸å°±ä»»å¼ã®æ—¥</h1>
            <img src="${presidentElect.icon}" style="width:120px; height:120px; border-radius:50%; border:5px solid white; background:white;">
            <h2 style="margin-top:20px;">${presidentElect.name}</h2>
            <p style="font-style:italic; font-size:1.1em; margin:20px 0;">
                "ç§ã¯å¤§çµ±é ˜ã«å°±ä»»ã—ã¾ã™ã€‚"
            </p>
            <div style="font-size:0.9em; color:#bdc3c7;">
                ${gameDate.getFullYear()}å¹´1æœˆ20æ—¥ æ­£åˆ
            </div>
        </div>
    `;
        }
        if (president && !isReelection) {
            html += `<div style="background:#1a2a6c; color:white; padding:30px; border-radius:10px; text-align:center; border: 5px solid #f1c40f;">
            <h1 style="margin-bottom:20px; font-size:1.5em;">ğŸ›ï¸å°±ä»»å¼ã®æ—¥</h1>
            
                        <img src="${president.icon}" style="width:120px; height:120px; border-radius:50%; border:5px solid white; background:white;">
            <h2 style="margin-top:20px;">${president.name}</h2>
                <div style="margin-bottom:20px; padding:10px; background:rgba(0,0,0,0.3); border-radius:5px;">
                    <small>å‰å¤§çµ±é ˜${president.name}ã®é€€ä»»:</small>
                    <p style="font-size:1.1em; color:#ecf0f1;">${farewellMessage}</p>
                </div>
            </div >`;
        }
        president = presidentElect

        openUniversalModal(title, html, [
            {
                text: "ãŠã‚ã§ã¨ã†ã€‚",
                cb: () => {
                    presidentElect = null;
                    appointCabinet(president); // å†…é–£ä»»å‘½å®Ÿè¡Œ
                    showCabinetAnnouncement(); // å†…é–£ç™ºè¡¨ç”»é¢ã¸
                },
                color: "#f1c40f"
            }
        ]);
    }
    function showCabinetAnnouncement() {
        if (!president) {
            openUniversalModal("ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚", "ã¾ã æ­£å¼ãªéƒ¨ä¸‹ã®ç™ºè¡¨ã¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", [
                {
                    text: "æ—©ãã—ã‚ï¼",
                    cb: () => {
                        closeUniversalModal();
                    },
                }
            ]);
            return
        }
        const stats = getMilitaryStats(); // è»äº‹æƒ…å ±ï¼ˆå›½é˜²é•·å®˜ã®åˆ¤å®šç”¨ãªã©ï¼‰

        // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼
        const getPersonUI = (person, roleName, size = "normal") => {
            const isVacant = !person;
            const isPlayer = person?.isPlayer || person?.id === "player";
            const name = isVacant ? "ï¼ˆç©ºå¸­ï¼‰" : person.name;
            const icon = isVacant ? "https://via.placeholder.com/100?text=?" : person.icon;

            // ã‚µã‚¤ã‚ºè¨­å®š
            const dim = size === "large" ? 120 : (size === "medium" ? 80 : 60);
            const fontSize = size === "large" ? "1.5em" : (size === "medium" ? "1.1em" : "0.9em");
            const borderColor = isPlayer ? "#f1c40f" : "#fff";

            return `
            <div style="text-align:center; padding:10px; transition: transform 0.3s;">
                <div style="position:relative; display:inline-block;">
                    <img src="${icon}" style="width:${dim}px; height:${dim}px; border-radius:50%; border:3px solid ${borderColor}; box-shadow: 0 4px 15px rgba(0,0,0,0.5); background:#2c3e50;">
                    ${isPlayer ? `<div style="position:absolute; bottom:0; right:0; background:#f1c40f; color:#000; font-size:10px; padding:2px 6px; border-radius:10px; font-weight:bold;">YOU</div>` : ''}
                </div>
                <div style="margin-top:8px;">
                    <div style="font-size:0.7em; color:#bdc3c7; text-transform:uppercase; letter-spacing:1px;">${roleName}</div>
                    <div style="font-size:${fontSize}; font-weight:bold; color:${isVacant ? '#e74c3c' : '#fff'};">${name}</div>
                </div>
            </div>
        `;
        };

        const html = `
    <div style="background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); padding:2px; border-radius:15px;">
        <div style="background:#1a1a2e; color:white; padding:30px; border-radius:13px; font-family:'Segoe UI', sans-serif;">
            
            <h2 style="text-align:center; margin-bottom:30px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">æ–°æ”¿æ¨©ãƒ»é–£åƒšåç°¿</h2>

            <div style="display:flex; justify-content:center; margin-bottom:20px;">
                ${getPersonUI(president, "å¤§çµ±é ˜", "large")}
            </div>

            <div style="display:flex; justify-content:center; margin-bottom:40px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:20px;">
                ${getPersonUI(currentCabinet.vicePresident, "å‰¯å¤§çµ±é ˜", "medium")}
            </div>

            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:20px; justify-items:center;">
                ${getPersonUI(currentCabinet.stateSecretary, "å›½å‹™é•·å®˜")}
                ${getPersonUI(currentCabinet.defenseSecretary, "å›½é˜²é•·å®˜")}
                ${getPersonUI(currentCabinet.justiceSecretary, "å¸æ³•é•·å®˜")}
                ${getPersonUI(currentCabinet.commerceSecretary, "å•†å‹™é•·å®˜")}
                ${getPersonUI(currentCabinet.homelandSecretary, "å›½åœŸé–‹ç™ºé•·å®˜")}
            </div>

            <div style="margin-top:30px; padding:15px; background:rgba(255,255,255,0.05); border-radius:8px; font-size:0.85em; line-height:1.6; border-left:4px solid #f1c40f;">
                <strong>ğŸ“œã‚¢ãƒ‰ãƒã‚¤ã‚¹:</strong><br>
                ${currentCabinet.stateSecretary.name}ã€Œ${generateCabinetAnalysis()}ã€
            </div>
        </div>
    </div>
    `;

        openUniversalModal("é–£åƒšãŸã¡", html, [
            { text: "äº†è§£", cb: () => { closeUniversalModal(); setGameSpeed(1); }, color: "#4ecca3" }
        ]);
    }

    // å†…é–£ã®æ§‹æˆã«åŸºã¥ã„ãŸåˆ†æãƒ†ã‚­ã‚¹ãƒˆï¼ˆãŠã¾ã‘ï¼‰
    function generateCabinetAnalysis() {
        const emptyCount = Object.values(currentCabinet).filter(v => !v).length;
        if (emptyCount >= 3) return "ç©ºå¸­ãŒç›®ç«‹ã¤ç•°å¸¸äº‹æ…‹ã§ã™ã€‚æ”¿æ¨©é‹å–¶ã®éº»ç—ºãŒæ‡¸å¿µã•ã‚Œã¾ã™ã€‚";

        const isDefenseMilitary = currentCabinet.defenseSecretary?.ideology.gov > 70;
        if (isDefenseMilitary) return "å›½é˜²é•·å®˜ãŒå¼·ã„ã§ã™ã€è»éƒ¨ã¨ã®é€£æºã‚’é‡è¦–ã—ã¦ã„ã¾ã™ã€‚";

        return "ãƒãƒ©ãƒ³ã‚¹ãŒå–ã‚Œã¦ã„ã¾ã™ã€æ€æƒ³ã®è¿‘ã„é–£åƒšãŸã¡ãŒå¤§çµ±é ˜ã‚’æ”¯ãˆã¾ã™ã€‚";
    }

    function runElection() {
        setGameSpeed(0); // æ™‚é–“ã‚’æ­¢ã‚ã‚‹
        const profile = JSON.parse(localStorage.getItem('political_game_data'));

        // ç«‹å€™è£œç¢ºèªç”¨ã®HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„
        const htmlContent = `
            <div style = "text-align:center; padding:20px;" >
            <p style="font-size:1.2em;">ç¬¬${electionHistory.length + 1}å›å¤§çµ±é ˜é¸æŒ™ãŒå…¬ç¤ºã•ã‚Œã¾ã—ãŸã€‚</p>
            <p>ã“ã®é¸æŒ™ã«ç«‹å€™è£œã—ã¾ã™ã‹ï¼Ÿ</p>
            <div style="margin-top:20px; font-size:0.8em; color:#bdc3c7;">
                â€»ç«‹å€™è£œã™ã‚‹ã¨ã€ã‚ãªãŸã®æ”¯æŒè€…ãŒã€ã‚ãªãŸã«æŠ•ç¥¨ã—ã¾ã™ã€‚<br>
                ç«‹å€™è£œã—ãªã„å ´åˆã¯ã€ä»–ã®å€™è£œè€…ã¸ã®æŠ•ç¥¨æ¨©ã®ã¿æŒã¡ã¾ã™ã€‚
            </div>
        </div >
            `;

        // æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã€Œç«‹å€™è£œã™ã‚‹ã‹ã€ã‚’èã
        openUniversalModal(
            "ğŸ—³ï¸ é¸æŒ™ç«‹å€™è£œã®ç¢ºèª",
            htmlContent,
            [
                {
                    text: "ç«‹å€™è£œã™ã‚‹ï¼",
                    color: "#4ecca3",
                    cb: () => proceedToVote(true) // ç«‹å€™è£œã—ã¦æ¬¡ã¸
                },
                {
                    text: "ä»Šå›ã¯è¦‹é€ã‚‹",
                    color: "#e74c3c",
                    cb: () => proceedToVote(false) // ç«‹å€™è£œã›ãšæ¬¡ã¸
                }
            ]
        );
    }

    function proceedToVote(willRun) {
        closeUniversalModal(); // ä¸€æ—¦é–‰ã˜ã‚‹

        const profile = JSON.parse(localStorage.getItem('political_game_data'));
        let candidates = [];

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å€™è£œè€…ã«è¿½åŠ 
        if (willRun) {
            candidates.push({
                id: 'player',
                name: profile.name,
                icon: profile.icon,
                isPlayer: true,
                termCount: 0,
                ideology: profile.ideology,
                votes: 0,
                supporters: []
            });
        }

        // NPCã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«3äººç«‹å€™è£œï¼ˆå…ˆè¡Œè€…åˆ©ç›Šæ ï¼‰
        const npcPotential = [...npcs].sort(() => 0.5 - Math.random()).slice(0, 3);
        npcPotential.forEach(n => {
            candidates.push({ ...n, votes: 0, supporters: [], isPlayer: false });
        });

        // æ¬¡ã®ã€ŒæŠ•ç¥¨å…ˆé¸æŠã€ã¸é€²ã‚€
        showVotingScreen(candidates, willRun);
    }

    function showVotingScreen(candidates, willRun) {
        const title = willRun ? "æŠ•ç¥¨ã™ã‚‹å€™è£œè€…ã‚’é¸ã‚“ã§ãã ã•ã„" : "æŠ•ç¥¨ã™ã‚‹å€™è£œè€…ã‚’é¸ã‚“ã§ãã ã•ã„";

        let html = `<div style = "display:grid; grid-template-columns:1fr 1fr; gap:10px;" > `;
        candidates.forEach(cand => {
            html += `
            <div id = "vote-target-${cand.id}" class="stat-card" style = "cursor:pointer; text-align:center; border: 1px solid #7f8c8d;" >
                <img src="${cand.icon}" style="width:50px; border-radius:50%;"><br>
                    <strong>${cand.name}</strong><br>
                        <small>${getIdeologyTitle(cand.ideology)}</small>
                    </div>
                    `;
        });
        html += `</div>`;

        // æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã§æŠ•ç¥¨å…ˆã‚’è¡¨ç¤º
        openUniversalModal(title, html, []); // ãƒœã‚¿ãƒ³ã¯JSã§å¾Œã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸

        // å„ã‚«ãƒ¼ãƒ‰ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»˜ä¸
        candidates.forEach(cand => {
            document.getElementById(`vote-target-${cand.id}`).onclick = () => {
                finalizeElection(candidates, cand.id);
            };
        });
    }
    function finalizeElection(candidates, playerVoteTargetId) {
        closeUniversalModal();
        document.getElementById('voting-modal').style.display = 'none';

        // æ”¯æŒè€…ã®è©³ç´°ã‚’ä¸€æ™‚çš„ã«æ ¼ç´ã™ã‚‹é…åˆ—ã‚’ç”¨æ„
        candidates.forEach(cand => {
            cand.temp_supporters_info = [];
        });

        // 1. NPCãŸã¡ã®è‡ªå‹•æŠ•ç¥¨
        npcs.forEach(npc => {
            let bestAffinity = -1;
            let voteTo = null;

            candidates.forEach(cand => {
                const aff = calculateAffinity(npc.ideology, cand.ideology);
                const priorityBonus = (candidates.indexOf(cand) === 0) ? 8 : 0;

                if ((aff + priorityBonus) > bestAffinity) {
                    bestAffinity = aff + priorityBonus;
                    voteTo = cand;
                }
            });

            if (voteTo) {
                voteTo.votes++;
                voteTo.supporters.push(npc.icon);
                // ã€é‡è¦ã€‘æ”¯æŒè€…ã®è©³ç´°ï¼ˆåå‰ã€ã‚¢ã‚¤ã‚³ãƒ³ã€æ‰€å±æ”¿å…šIDï¼‰ã‚’è¨˜éŒ²
                voteTo.temp_supporters_info.push({
                    name: npc.name,
                    icon: npc.icon,
                    partyId: npc.partyId
                });
            }
        });

        // 2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®1ç¥¨ã‚’åŠ ç®—
        const myChoice = candidates.find(c => c.id === playerVoteTargetId);
        if (myChoice) {
            myChoice.votes++;

            // localStorageã‹ã‚‰æœ€æ–°ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆæ‰€å±æ”¿å…šè¾¼ã¿ï¼‰ã‚’å–å¾—
            profile = JSON.parse(localStorage.getItem('political_game_data')) || {};
            myChoice.supporters.push(profile.icon || "");

            // profile.partyId ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†ã€‚ãªã‘ã‚Œã°ç„¡æ‰€å±ã€‚
            let pPartyId = profile.partyId || "independents";

            myChoice.temp_supporters_info.push({
                name: profile.name || "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼",
                icon: profile.icon || "",
                partyId: pPartyId
            });
        }

        // 3. çµæœã®æ•´ç†ã¨å±¥æ­´ã¸ã®ä¿å­˜ï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆåŒ–ï¼‰
        candidates.sort((a, b) => b.votes - a.votes);
        presidentElect = candidates[0];

        // å±¥æ­´ã«ã¯ã€Œãã®ç¬é–“ã®å€¤ã€ã‚’ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜ã™ã‚‹
        const historyEntry = {
            date: new Date(gameDate),
            winner: presidentElect,
            totalVotes: npcs.length + 1,
            all: candidates.map(cand => ({
                id: cand.id,
                name: cand.name,
                icon: cand.icon,
                partyId: cand.partyId,
                votes: cand.votes,
                isPlayer: (cand.id === "player" || cand.isPlayer === true),
                supporters: [...cand.supporters], // ã‚¢ã‚¤ã‚³ãƒ³é…åˆ—ã‚’ã‚³ãƒ”ãƒ¼
                supporters_data: [...cand.temp_supporters_info] // ã€é‡è¦ã€‘è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ä¿å­˜
            })),
            inaugurated: false
        };

        electionHistory.push(historyEntry);

        showElectionResult(candidates);
    }

    function showElectionResult(results) {
        const content = document.getElementById('election-content');
        const [first, second, ...others] = results;

        let html = `<h1 style="text-align:center; color:#f1c40f;">ğŸ—³ï¸ é¸æŒ™çµæœç™ºè¡¨</h1>`;

        // ä¸Šä½2åã®ç‰¹å¤§è¡¨ç¤º
        html += `
                    <div style="display:flex; justify-content:center; gap:20px; margin-top:30px;">
                        <div style="text-align:center; border:2px solid #f1c40f; padding:20px; border-radius:10px; width:45%;">
                            <h2>ğŸ¥‡ 1ä½ (å½“é¸)</h2>
                            <img src="${first.icon}" style="width:120px; height:120px; border-radius:50%; border:4px solid #f1c40f;">
                                <div style="font-size:1.5em; font-weight:bold; margin-top:10px;">${first.name}</div>
                                <div style="font-size:2em; color:#f1c40f;">${first.votes} ç¥¨</div>
                                <div style="margin-top:10px;">æ”¯æŒè€…:<br>${first.supporters.map(img => `<img src="${img}" style="width:25px; border-radius:50%;">`).join("")}</div>
                        </div>
                        <div style="text-align:center; border:2px solid #bdc3c7; padding:20px; border-radius:10px; width:40%;">
                            <h2>ğŸ¥ˆ 2ä½</h2>
                            <img src="${second.icon}" style="width:100px; height:100px; border-radius:50%; border:2px solid #bdc3c7;">
                                <div style="font-size:1.2em; margin-top:10px;">${second.name}</div>
                                <div style="font-size:1.8em; color:#bdc3c7;">${second.votes} ç¥¨</div>
                                <div style="margin-top:10px;">æ”¯æŒè€…:<br>${second.supporters.map(img => `<img src="${img}" style="width:20px; border-radius:50%;">`).join("")}</div>
                        </div>
                    </div>`;

        // æ®‹ã‚Šã®å€™è£œè€…ã‚’ä¸‹ã«å°ã•ã
        html += `<div style="display:flex; justify-content:center; gap:15px; margin-top:40px; flex-wrap:wrap;">`;
        others.forEach(cand => {
            html += `
        <div style="text-align:center; background:#34495e; padding:10px; border-radius:8px; width:100px; font-size:0.8em;">
            <img src="${cand.icon}" style="width:50px; border-radius:50%;">
            <div>${cand.name}</div>
            <div>${cand.votes} ç¥¨</div>
        </div>`;
        });
        html += `</div>`;
        html += `
                    <div style="text-align:center;">
                        <h2 style="color:#f1c40f;">é¸æŒ™é€Ÿå ±</h2>
                        <img src="${presidentElect.icon}" style="width:100px; border-radius:50%; border:4px solid #f1c40f;">
                            <p style="font-size:1.2em;"><strong>${presidentElect.name}</strong> æ°ã®å½“é¸ãŒç¢ºå®Ÿã¨ãªã‚Šã¾ã—ãŸï¼</p>
                            <p>1æœˆ20æ—¥ã®å°±ä»»å¼ã¾ã§ã€æ”¿æ¨©ç§»è¡ŒæœŸé–“ã«å…¥ã‚Šã¾ã™ã€‚</p>
                    </div>
                    `;

        content.innerHTML = html;
        document.getElementById('election-result-modal').style.display = 'block';
        setGameSpeed(0); // çµæœç™ºè¡¨æ™‚ã¯æ™‚é–“ã‚’æ­¢ã‚ã‚‹
        electionCountdown = 1460;

    }

    // é¸æŒ™çµæœã‚’é–‰ã˜ãŸã‚‰ãƒ‡ã‚£ãƒŠãƒ¼ä¼šã¸
    function closeElectionModal() {
        document.getElementById('election-result-modal').style.display = 'none';
        // é¸æŒ™çµæœã®é€Ÿå ±ã‚’è¡¨ç¤º
        // é–‹å‚¬ã•ã‚Œã‚‹å ´åˆ
        startPostElectionDinner();
    }

    function startPostElectionDinner() {
        // 1. ã¾ãš40%ã®ç¢ºç‡ã§ã‚¤ãƒ™ãƒ³ãƒˆè‡ªä½“ãŒæ¶ˆæ»…
        if (Math.random() < 0.4) {
            openUniversalModal(
                "ğŸ½ï¸ ãƒ‡ã‚£ãƒŠãƒ¼ä¼šä¸­æ­¢",
                `<div style="text-align:center;">å„å€™è£œè€…ã®è«¸äº‹æƒ…ã«ã‚ˆã‚Šã€æœ¬æ—¥ã®ãƒ‡ã‚£ãƒŠãƒ¼ä¼šã¯ä¸­æ­¢ã§ã™ã€‚</div>`,
                [{ text: "äº†è§£", cb: closeUniversalModal, color: "#7f8c8d" }]
            );
            return;
        }

        const lastElection = electionHistory[electionHistory.length - 1];
        const playerInElection = lastElection.all.some(cand => cand.isPlayer);

        if (playerInElection) {
            // ã€ç«‹å€™è£œã—ã¦ã„ãŸå ´åˆã€‘ã¾ãšå‚åŠ ã™ã‚‹ã‹ã©ã†ã‹ã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«èã
            openUniversalModal(
                "âœ‰ï¸ ãƒ‡ã‚£ãƒŠãƒ¼ã¸ã®æ‹›å¾…",
                `<div style="text-align:center;">
                é¸æŒ™ãŒçµ‚ã‚ã‚Šã€ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‹ã‚‰æ‹›å¾…çŠ¶ãŒå±Šãã¾ã—ãŸã€‚<br>
                ç”Ÿé…ä¿¡ãƒ©ã‚¤ãƒ–ãŒè¡Œã‚ã‚Œã‚‹äºˆå®šã§ã™ãŒã€å‡ºå¸­ã—ã¾ã™ã‹ï¼Ÿ
            </div>`,
                [
                    { text: "å‡ºå¸­ã™ã‚‹", cb: () => processDinner(true), color: "#4ecca3" },
                    { text: "ä¸å‚åŠ ", cb: () => processDinner(false), color: "#e74c3c" }
                ]
            );
        } else {
            // ã€è¦³å®¢ã®å ´åˆã€‘ãã®ã¾ã¾é…ä¿¡ã‚’è¦‹ã‚‹ç”»é¢ã¸
            processDinner(false, true);
        }
    }

    /**
     * å®Ÿéš›ã®ãƒ‡ã‚£ãƒŠãƒ¼å‡¦ç†
     * @param {boolean} playerAttending - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‡ºå¸­ã™ã‚‹ã‹
                    * @param {boolean} isSpectator - è¦³å®¢ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹
                    */
    function processDinner(playerAttending, isSpectator = false) {
        const lastElection = electionHistory[electionHistory.length - 1];
        let attendeesCount = 0;
        let html = `<div style="background:#000; color:#0f0; padding:5px; font-family:monospace; margin-bottom:10px;">ğŸ”´ LIVE:ã€ã”ã¯ã‚“ã€‘ã‚ªãƒ„ã‚«ãƒ¬ã•ã¾ãƒ‡ã‚£ãƒŠãƒ¼</div>`;
        html += `<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:15px;">`;

        lastElection.all.forEach(cand => {
            let statusText = "";
            let opacity = "1";
            let isAttending = false;

            if (cand.isPlayer) {
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆ¤å®š
                if (playerAttending) {
                    statusText = "âœ… å‚åŠ ";
                    isAttending = true;
                } else {
                    statusText = "ğŸ’¢ ä¸å‚åŠ ";
                    opacity = "0.3";
                }
            } else {
                // NPCã®åˆ¤å®š
                const rand = Math.random();
                if (rand < 0.15) { statusText = "ğŸ¤’ é¢¨é‚ªæ¬ å¸­"; opacity = "0.3"; }
                else if (rand < 0.3) { statusText = "ğŸ’¢ ä¸å‚åŠ "; opacity = "0.3"; }
                else {
                    statusText = "âœ… å‚åŠ ";
                    isAttending = true;
                }
            }

            if (isAttending) attendeesCount++;

            html += `
                        <div style="text-align:center; opacity:${opacity}; background:#2c3e50; padding:10px; border-radius:10px; border: 1px solid ${opacity === "1" ? '#4ecca3' : 'transparent'};">
                        <img src="${cand.icon}" style="width:60px; border-radius:50%;"><br>
                            <strong style="font-size:0.8em;">${cand.name}</strong><br>
                                <span style="font-size:0.65em;">${statusText}</span>
                            </div>
                            `;
        });
        html += `</div>`;

        // çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ
        let resultMessage = "";
        if (isSpectator) {
            resultMessage = "è¦–è´è€…ã¨ã—ã¦ãƒ©ã‚¤ãƒ–ã‚’è¦‹å®ˆã£ã¦ã„ã¾ã™ã€‚";
        } else if (playerAttending) {
            resultMessage = attendeesCount > 1 ? "è³‘ã‚„ã‹ãªä¼šé£Ÿã¨ãªã‚Šã¾ã—ãŸã€éå¸¸ã«æ¥½ã—ã„é£Ÿäº‹ã§ã—ãŸã€‚" : "å‚åŠ è€…ã¯ã‚ãªãŸä¸€äººã§ã—ãŸã€‚è±ªè¯ãªæ–™ç†ã‚’ç‹¬ã‚Šå ã‚ã§ã™ã€‚";
        } else {
            resultMessage = "ã‚ãªãŸã¯æ¬ å¸­ã—ã¾ã—ãŸã€‚ãƒ©ã‚¤ãƒ–é…ä¿¡ã®ãƒãƒ£ãƒƒãƒˆæ¬„ã§ã¯ã‚ãªãŸã®ä¸åœ¨ãŒå™‚ã•ã‚Œã¦ã„ã¾ã™ã€‚";
        }

        html += `<p style="margin-top:15px; font-size:0.9em; text-align:center; color:#bdc3c7;">${resultMessage}</p>`;

        // ãƒœã‚¿ãƒ³ã®è¨­å®š
        const buttons = [];
        if (isSpectator) {
            buttons.push({ text: "é£Ÿäº‹ãƒ©ã‚¤ãƒ–ã‚’æœ€å¾Œã¾ã§è¦‹ã‚‹", cb: closeUniversalModal, color: "#3498db" });
            buttons.push({ text: "é£Ÿäº‹ãƒ©ã‚¤ãƒ–ã‚’é–‰ã˜ã‚‹", cb: closeUniversalModal, color: "#7f8c8d" });
        } else {
            buttons.push({ text: playerAttending ? "ä¼šé£Ÿã‚’çµ‚ãˆã‚‹" : "ãƒ©ã‚¤ãƒ–é…ä¿¡ã‚’é–‰ã˜ã‚‹", cb: closeUniversalModal, color: "#4ecca3" });
        }

        openUniversalModal("ğŸ½ï¸ é¸æŒ™å¾Œãƒ‡ã‚£ãƒŠãƒ¼çµæœ", html, buttons);
    }

    function openElectionHistory() {
        setGameSpeed(0);

        if (electionHistory.length === 0) {
            openUniversalModal(
                "ğŸ“œ æ­´ä»£é¸æŒ™ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–",
                `<div style="text-align:center; padding:50px;">
                <h2>ã¾ã é¸æŒ™ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</h2>
                <p>æœ€åˆã®é¸æŒ™ãŒå®Ÿæ–½ã•ã‚Œã‚‹ã¾ã§å¾…ã¡ã¾ã—ã‚‡ã†ã€‚</p>
             </div>`,
                [{ text: "é–‰ã˜ã‚‹", cb: closeUniversalModal, color: "#7f8c8d" }]
            );
            return;
        }

        let html = `<div style="padding:10px;">`;
        // æœ€æ–°ã®å±¥æ­´ã‹ã‚‰é †ã«ç”Ÿæˆ
        [...electionHistory].reverse().forEach((record, index) => {
            const realIndex = electionHistory.length - 1 - index;
            const dateStr = `${record.date.getFullYear()}/${record.date.getMonth() + 1}/${record.date.getDate()}`;
            const isPlayerWinner = record.winner.isPlayer;

            html += `
                                <div onclick="showElectionDetail(${realIndex})"
                                    style="background:#34495e; padding:15px; border-radius:10px; margin-bottom:12px; border-left: 5px solid ${isPlayerWinner ? '#4ecca3' : '#e74c3c'}; cursor:pointer;">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <div>
                                            <div style="font-size:0.7em; color:#bdc3c7;">ç¬¬ ${realIndex + 1} æœŸ é¸æŒ™</div>
                                            <div style="font-weight:bold; font-size:1.1em;">å½“é¸è€…: ${record.winner.name}</div>
                                            <div style="font-size:0.75em;">${dateStr} å®Ÿæ–½</div>
                                        </div>
                                        <img src="${record.winner.icon}" style="width:45px; border-radius:50%; background:#2c3e50;">
                                    </div>
                                </div>`;
        });
        html += `</div>`;
        setGameSpeed(0);

        // æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã§å±¥æ­´ä¸€è¦§ã‚’è¡¨ç¤º
        openUniversalModal(
            "ğŸ“œ æ­´ä»£é¸æŒ™ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–",
            html,
            [{ text: "é–‰ã˜ã‚‹", cb: closeUniversalModal, color: "#34495e" }]
        );
    }

    function getPartyInfo(partyId) {
        const party = parties.find(p => p.id === partyId);
        return party ? { name: party.name, color: party.color } : { name: "ç„¡æ‰€å±", color: "#95a5a6" };
    }

    /**
     * é¸æŒ™ã®å€‹åˆ¥è©³ç´°ã‚’è¡¨ç¤ºã™ã‚‹
     * @param {number} index - electionHistoryã®æ·»å­—
     */
    function showElectionDetail(index) {
        const record = electionHistory[index];
        if (!record || !record.all) return;

        const totalVotes = record.totalVotes || record.all.reduce((sum, c) => sum + c.votes, 0) || 1;
        const dateStr = record.date;

        let html = `
        <div style="background:#f8f9fa; color:#202122; padding:20px; border-radius:5px; font-family: sans-serif; max-height:80vh; overflow-y:auto;">
            <div style="text-align:center; border-bottom:1px solid #a2a9b1; margin-bottom:10px; padding-bottom:10px;">
                <h2 style="margin:0; font-size:1.2em;">ç¬¬ ${index + 1} æœŸ å¤§çµ±é ˜é¸æŒ™ è©³ç´°åˆ†æ</h2>
                <small>${dateStr} å®Ÿæ–½</small>
            </div>

            <table style="width:100%; border-collapse: collapse; text-align:center; table-layout: fixed; margin-bottom:20px;">
                <tr>
                    ${record.all.slice(0, 3).map((cand, i) => {
            const party = getPartyInfo(cand.partyId);
            const percentage = ((cand.votes / totalVotes) * 100).toFixed(1);
            return `
                        <td style="padding:5px; vertical-align: top; border-bottom: 4px solid ${party.color};">
                            <div style="font-size:0.75em; font-weight:bold; color:#555;">${i === 0 ? 'ğŸ† å½“é¸' : 'å€™è£œè€…'}</div>
                            <div style="background:${party.color}; color:${getContrastYIQ(party.color)}; font-size:0.7em; padding:2px 5px; border-radius:3px; display:inline-block; margin-bottom:5px;">${party.name}</div>
                            <img src="${cand.icon}" style="width:60px; height:60px; border-radius:50%; border:2px solid ${party.color}; display:block; margin:0 auto; background:white;">
                            <div style="font-weight:bold; margin-top:5px; font-size:0.85em;">${cand.name}</div>
                            <div style="font-size:1.1em; font-weight:bold; margin-top:3px;">${cand.votes} <span style="font-size:0.6em;">ç¥¨</span></div>
                            <div style="font-size:0.8em; color:#666;">(${percentage}%)</div>
                        </td>`;
        }).join('')}
                </tr>
            </table>

            <h3 style="font-size:0.9em; border-left:4px solid #34495e; padding-left:8px; margin-bottom:15px;">ğŸ“Š å€™è£œè€…åˆ¥ãƒ»æ”¯æŒæ”¿å…šã®å†…è¨³åˆ†æ</h3>
            <div style="display:flex; flex-direction:column; gap:15px;">
                ${record.all.slice(0, 3).map(cand => {
            const party = getPartyInfo(cand.partyId);
            const supData = cand.supporters_data || [];

            // --- æ”¿å…šã”ã¨ã®ç¥¨æ•°ã‚’é›†è¨ˆ ---
            const partyStats = {};
            supData.forEach(s => {
                const pName = getPartyInfo(s.partyId).name;
                partyStats[pName] = (partyStats[pName] || 0) + 1;
            });

            // ç¥¨æ•°ãŒå¤šã„é †ã«ã‚½ãƒ¼ãƒˆ
            const sortedParties = Object.entries(partyStats).sort((a, b) => b[1] - a[1]);

            return `
                    <div style="background:#fff; border:1px solid #c8ccd1; border-left: 8px solid ${party.color}; padding:12px; border-radius:4px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <strong style="font-size:0.9em;">${cand.name} ã¸ã®æŠ•ç¥¨å†…è¨³</strong>
                            <span style="font-size:0.75em; color:#666;">ç·æ”¯æŒè€…: ${supData.length}å</span>
                        </div>

                        <div style="display:flex; width:100%; height:12px; border-radius:6px; overflow:hidden; background:#eee; margin-bottom:10px;">
                            ${sortedParties.map(([pName, count]) => {
                // é›†è¨ˆå¯¾è±¡ã®æ”¿å…šã®è‰²ã‚’å–å¾—
                const pColor = parties.find(p => p.name === pName)?.color || "#95a5a6";
                return `<div style="width:${(count / supData.length * 100)}%; background:${pColor};" title="${pName}: ${count}ç¥¨"></div>`;
            }).join('')}
                        </div>

                        <div style="display:flex; flex-wrap:wrap; gap:10px;">
                            ${sortedParties.map(([pName, count]) => {
                const pColor = parties.find(p => p.name === pName)?.color || "#95a5a6";
                const pRatio = ((count / supData.length) * 100).toFixed(1);
                return `
                                <div style="font-size:0.7em; display:flex; align-items:center; gap:4px;">
                                    <span style="width:8px; height:8px; border-radius:50%; background:${pColor};"></span>
                                    <span style="font-weight:bold;">${pName}:</span> ${pRatio}% 
                                    <span style="color:#888;">(${count}äºº)</span>
                                </div>`;
            }).join('')}
                        </div>

                        <div style="display:flex; flex-wrap:wrap; gap:3px; margin-top:12px; padding-top:8px; border-top:1px dashed #eee;">
                            ${supData.map(s => {
                const sParty = getPartyInfo(s.partyId);
                return `<img src="${s.icon}" title="${s.name} (${sParty.name})" style="width:18px; height:18px; border-radius:50%; border:1.5px solid ${sParty.color}; background:#f0f0f0;">`;
            }).join('')}
                        </div>
                    </div>`;
        }).join('')}
            </div>

            <div style="margin-top:20px; font-size:0.7em; color:#54595d; line-height:1.4; background:#eee; padding:10px; border-radius:4px;">
                <strong>ğŸ’¡ åˆ†æã®ãƒ’ãƒ³ãƒˆ:</strong><br>
                å€™è£œè€…è‡ªèº«ã®æ‰€å±æ”¿å…šä»¥å¤–ã‹ã‚‰ã®ï¼…ãŒé«˜ã„å ´åˆã€ä»–å…šã‹ã‚‰ã®ã€Œç¥¨ã®æµå…¥ã€ãŒèµ·ãã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚ã“ã‚ŒãŒé«˜ã„å€™è£œè€…ã¯ã€æ€æƒ³ã¨ã‹é–¢ä¿‚ãªãæ”¯æŒã•ã‚Œã‚‹ã€Œè‹±é›„ã€ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
            </div>
        </div>
    `;

        openUniversalModal("Wikipedia: é¸æŒ™ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–", html, [
            { text: "ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’é–‰ã˜ã‚‹", cb: closeUniversalModal, color: "#34495e" }
        ]);
    }
    // æ”¿å…š //
    let parties = [];

    // æ”¿å…šã®åˆæœŸç”Ÿæˆï¼ˆAI/ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
    function createParty(name, color, leader) {
        const party = {
            id: "party-" + Date.now() + Math.random().toString(36).substr(2, 5),
            name: name,
            color: color,
            leader: leader, // NPCã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            members: leader ? [leader] : [], // åˆæœŸãƒ¡ãƒ³ãƒãƒ¼
            active: true, // ç¾å­˜ãƒ•ãƒ©ã‚°
            foundedDate: new Date(gameDate),
            dissolvedDate: null,
        };
        parties.push(party);
        return party;
    }
    function openPartyMenu() {
        const activeParties = parties.filter(p => p.active);
        const dissolvedParties = parties.filter(p => !p.active);

        let html = `
        <div style="max-height: 70vh; overflow-y: auto; text-align: left;">
            <h3 style="border-left: 5px solid #4ecca3; padding-left: 10px;">ç¾å­˜ã™ã‚‹æ”¿å…š</h3>
            <div id="active-party-list" style="display: grid; gap: 10px; margin-bottom: 20px;">
                ${activeParties.map(p => renderPartyCard(p)).join('')}
            </div>

            <h3 style="border-left: 5px solid #95a5a6; padding-left: 10px; color: #7f8c8d;">æ­´å²çš„ãªæ”¿å…šï¼ˆæ¶ˆæ»…ï¼‰</h3>
            <div id="dissolved-party-list" style="display: grid; gap: 10px; opacity: 0.7;">
                ${dissolvedParties.length > 0 ? dissolvedParties.map(p => renderPartyCard(p)).join('') : "<p>ãªã—</p>"}
            </div>
        </div>
    `;

        openUniversalModal("æ”¿å…šãƒãƒ¼ã‚¿ãƒ«", html, [
            { text: "é–‰ã˜ã‚‹", cb: () => closeUniversalModal(), color: "#34495e" }
        ]);
    }

    // æ”¿å…šã‚«ãƒ¼ãƒ‰ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderPartyCard(party) {
        return `
        <div onclick="showPartyDetail('${party.id}')" style="background: #2c3e50; border: 2px solid ${party.color}; padding: 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; position: relative;">
            <div style="position: absolute; top: 0; left: 0; width: 10px; height: 100%; background: ${party.color}; border-radius: 8px 0 0 8px;"></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-left: 10px;">
                <strong style="font-size: 1.1em; color: white;">${party.name}</strong>
                <span style="font-size: 0.8em; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px;">ãƒ¡ãƒ³ãƒãƒ¼: ${party.members.length}å</span>
            </div>
            <div style="font-size: 0.9em; color: #bdc3c7; margin-top: 5px; margin-left: 10px;">
                ä»£è¡¨: ${party.leader ? party.leader.name : "ç©ºå¸­"}
            </div>
        </div>
    `;
    }

    function showPartyDetail(partyId) {
        const party = parties.find(p => p.id === partyId);
        if (!party) return;

        // ã‚ãªãŸãŒå¤§çµ±é ˜ã€ã‚ã‚‹ã„ã¯ã“ã®æ”¿å…šã®ä»£è¡¨ã§ã‚ã‚‹ã‹ã®åˆ¤å®š
        const isPlayerLeader = party.leader && party.leader.isPlayer;

        let memberHtml = party.members.map(m => `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 5px; border-bottom: 1px solid #3d4e5f;">
            <span><img src="${m.icon}" style="width:24px; vertical-align:middle; border-radius:50%;"> ${m.name}</span>
            ${isPlayerLeader && !m.isPlayer ? `<button onclick="expelMember('${party.id}', '${m.id}')" style="background:#e74c3c; color:white; border:none; border-radius:3px; cursor:pointer; font-size:0.7em;">é™¤å</button>` : ""}
        </div>
    `).join('');

        let actionButtons = [];
        if (isPlayerLeader && party.active) {
            actionButtons.push({ text: "ä»–å…šã¨åˆæµäº¤æ¸‰", cb: () => proposeMerge(party.id), color: "#f1c40f" });
            actionButtons.push({ text: "æ–°ãƒ¡ãƒ³ãƒãƒ¼æ‹›å¾…", cb: () => inviteMember(party.id), color: "#27ae60" });
        }
        actionButtons.push({ text: "æˆ»ã‚‹", cb: () => openPartyMenu(), color: "#34495e" });

        const detailHtml = `
        <div style="text-align: left;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <div style="width: 50px; height: 50px; background: ${party.color}; border-radius: 10px;"></div>
                <div>
                    <h2 style="margin: 0;">${party.name}</h2>
                    <small>çµå…š: ${party.foundedDate.getFullYear()}å¹´</small>
                </div>
            </div>
            <h4>ä»£è¡¨</h4>
            <div style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                ${party.leader ? `<img src="${party.leader.icon}" style="width:30px; border-radius:50%;"> ${party.leader.name}` : "ç©ºå¸­"}
            </div>
            <h4>ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ (${party.members.length}å)</h4>
            <div style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px;">
                ${memberHtml}
            </div>
        </div>
    `;

        openUniversalModal(`${party.name} è©³ç´°`, detailHtml, actionButtons);
    }
    function runPartyElection(partyId) {
        const party = parties.find(p => p.id === partyId);
        const candidates = party.members.slice(0, 3); // ä¸Šä½3åãŒç«‹å€™è£œã¨ä»®å®š

        let winner = null;
        let maxVotes = -1;

        candidates.forEach(cand => {
            let votes = 0;
            party.members.forEach(member => {
                // å…šå†…ãƒ¡ãƒ³ãƒãƒ¼ã¨ã®ç›¸æ€§ã§æŠ•ç¥¨
                const aff = calculateAffinity(member.ideology, cand.ideology);
                if (aff > 50) votes++;
            });

            if (votes > maxVotes) {
                maxVotes = votes;
                winner = cand;
            }
        });

        party.leader = winner;
        console.log(`${party.name}ã®æ–°ä»£è¡¨ã¯ ${winner.name} ã«æ±ºå®šï¼`);
    }
    // æ”¿å…šåˆæµã®åˆ¤å®š
    function proposeMerge(myPartyId) {
        const myParty = parties.find(p => p.id === myPartyId);
        const otherParties = parties.filter(p => p.active && p.id !== myPartyId);

        let html = `<p>åˆæµã‚’æ‰“è¨ºã™ã‚‹æ”¿å…šã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆæˆåŠŸç‡ã¯ä»£è¡¨åŒå£«ã®ç›¸æ€§ã«ä¾å­˜ã—ã¾ã™ï¼‰</p>`;
        otherParties.forEach(p => {
            const aff = calculateAffinity(myParty.leader.ideology, p.leader.ideology);
            html += `<button onclick="processMerge('${myParty.id}', '${p.id}')" style="display:block; width:100%; margin:5px 0; padding:10px; text-align:left; background:#34495e; color:white; border:none; border-radius:5px;">
            ${p.name} (ä»£è¡¨: ${p.leader.name} / ç›¸æ€§: ${aff}%)
        </button>`;
        });

        openUniversalModal("æ”¿å…šåˆæµäº¤æ¸‰", html, [{ text: "æˆ»ã‚‹", cb: () => showPartyDetail(myPartyId) }]);
    }

    function processMerge(targetId, otherId) {
        const target = parties.find(p => p.id === targetId);
        const other = parties.find(p => p.id === otherId);
        const aff = calculateAffinity(target.leader.ideology, other.leader.ideology);

        // æˆåŠŸç¢ºç‡: åŸºæœ¬3% + ç›¸æ€§ãƒœãƒ¼ãƒŠã‚¹(æœ€å¤§12%) = æœ€å¤§15% ã®ä½ç¢ºç‡è¨­å®š
        const chance = 0.03 + (aff > 80 ? (aff - 80) * 0.006 : 0);
        const success = Math.random() < chance;

        if (success) {
            alert(`${target.name} ã¨ ${other.name} ãŒåˆæµã—ã€å·¨å¤§æ”¿å…šãŒèª•ç”Ÿã—ã¾ã—ãŸï¼`);
            target.name = target.name + "ãƒ»" + other.name;
            target.members = [...target.members, ...other.members];
            other.active = false; // æ¶ˆæ»…
            other.dissolvedDate = new Date(gameDate);
            showPartyDetail(target.id);
        } else {
            alert(`${other.name} ã®ä»£è¡¨ ${other.leader.name} ã«æ‹’çµ¶ã•ã‚Œã¾ã—ãŸã€‚ã€Œæˆ‘ã€…ã®èª‡ã‚Šã¯é‡‘ã§ã¯è²·ãˆãªã„ã€ã¨ã®ã“ã¨ã§ã™ã€‚`);
        }
    }
    // æ”¿å…šçµæˆ
    // æ—¥æ¬¡å‡¦ç†ã®ä¸­ã§å‘¼ã¶
    function checkPartyCreationEvent() {
        // 200æ—¥ã«1å›ã€10%ã®ç¢ºç‡ã§ç™ºç”Ÿ (Math.random() < 0.1)
        // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³å¤‰æ•° eventCounter ãªã©ã‚’ä½œã£ã¦ç®¡ç†ã™ã‚‹ã¨æ­£ç¢ºã§ã™
        if (dayCounter % 200 === 0 && Math.random() < 0.3) {
            dayCounter = 0;
            startPartyFoundingEvent();
        }
    }

    function startPartyFoundingEvent() {
        // 1. ç™ºèµ·äººã‚’ãƒ©ãƒ³ãƒ€ãƒ ãªNPCã‹ã‚‰é¸ã¶
        const founder = npcs[Math.floor(Math.random() * npcs.length)];

        // 2. æ‹›å¾…å€™è£œã‚’é¸å‡º (2äººã€œ50äºº)
        const inviteCount = Math.floor(Math.random() * 49) + 2;
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å«ã‚€å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦æŠ½å‡º
        let potentialMembers = [...npcs, { isPlayer: true, name: profile.name, icon: profile.icon, id: "player" }];
        potentialMembers = potentialMembers.sort(() => 0.5 - Math.random()).slice(0, inviteCount);

        const invitedNames = potentialMembers.map(m => m.name).join(', ');
        console.log(`ç™ºèµ·äºº ${founder.name} ãŒæ–°å…šçµæˆã‚’å‘¼ã³ã‹ã‘ã¾ã—ãŸï¼æ‹›å¾…: ${invitedNames}`);

        // 3. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ‹›å¾…ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const playerInvited = potentialMembers.find(m => m.isPlayer);

        if (playerInvited) {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ã®æ‹›å¾…ãƒ¢ãƒ¼ãƒ€ãƒ«
            setGameSpeed(0);
            openUniversalModal(
                "æ–°å…šçµæˆã®èª˜ã„",
                `<div style="text-align:center;">
                <img src="${founder.icon}" style="width:80px; border-radius:50%;">
                <p><strong>${founder.name}</strong> ãŒæ–°ã—ã„æ”¿å…šã‚’ç«‹ã¡ä¸Šã’ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚</p>
                <p>ã‚ãªãŸã‚‚å‰µè¨­ãƒ¡ãƒ³ãƒãƒ¼ã¨ã—ã¦å‚åŠ ã—ã¾ã›ã‚“ã‹ï¼Ÿ</p>
                <small>ï¼ˆä»– ${potentialMembers.length - 1} åã«ã‚‚æ‹›å¾…ãŒé€ã‚‰ã‚Œã¦ã„ã¾ã™ï¼‰</small>
            </div>`,
                [
                    { text: "å‚åŠ ã™ã‚‹", cb: () => finalizeNewParty(founder, potentialMembers, true), color: "#2ecc71" },
                    { text: "æ‹’å¦ã™ã‚‹", cb: () => finalizeNewParty(founder, potentialMembers, false), color: "#e74c3c" }
                ]
            );
        } else {
            // NPCã®ã¿ã§é€²è¡Œ
            finalizeNewParty(founder, potentialMembers, false);
        }
    }

    function finalizeNewParty(founder, invitees, playerJoined) {
        closeUniversalModal();

        let joinedMembers = [];

        // NPCã®æ‰¿è«¾åˆ¤å®š (ç›¸æ€§ã‚„æ€§æ ¼ã§æ±ºã‚ã‚‹ãŒã€ä»Šå›ã¯ç°¡æ˜“çš„ã«50%ã§æ‰¿è«¾)
        invitees.forEach(m => {
            if (m.isPlayer) {
                if (playerJoined) joinedMembers.push(m);
            } else {
                // NPCã¯ç™ºèµ·äººã¨ã®ç›¸æ€§ãŒ50ä»¥ä¸Šãªã‚‰å‚åŠ ã—ã‚„ã™ã„
                const aff = calculateAffinity(founder.ideology, m.ideology);
                if (Math.random() * 100 < aff) {
                    joinedMembers.push(m);
                }
            }
        });

        // ç™ºèµ·äººã¯å¿…ãšå‚åŠ 
        if (!joinedMembers.find(m => m.id === founder.id)) {
            joinedMembers.push(founder);
        }

        // æœ€ä½2äººé›†ã¾ã£ãŸã‚‰çµæˆ
        if (joinedMembers.length >= 2) {
            joinedMembers.forEach(member => {
                // ã‚‚ã—æ—¢ã«ã©ã“ã‹ã®å…šã«æ‰€å±ã—ã¦ã„ãŸã‚‰ã€ãã®å…šã®ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‹ã‚‰è‡ªåˆ†ã‚’æ¶ˆã™
                if (member.partyId) {
                    const oldParty = parties.find(p => p.id === member.partyId);
                    if (oldParty && oldParty.members) {
                        oldParty.members = oldParty.members.filter(m => m.id !== member.id);
                    }
                }
            });
            const generatedName = generateDynamicPartyName();
            let color = Math.floor(Math.random() * 16777215).toString(16);
            let colors = "#" + color.padStart(6, '0');
            const newParty = createParty(
                generatedName,
                colors,
                founder
            );

            newParty.members = joinedMembers;

            // æ‰€å±ãƒ¡ãƒ³ãƒãƒ¼ã«partyIdã‚’ã‚»ãƒƒãƒˆï¼ˆFactionå‡¦ç†ç”¨ï¼‰
            joinedMembers.forEach(m => {
                if (!m.isPlayer) m.partyId = newParty.id;
            });
            setGameSpeed(0);

            // æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’è¡¨ç¤º
            const newsHtml = `
        <div style="text-align:center; padding: 20px;">
            <div style="background:${newParty.color}; color:white; padding:15px; border-radius:10px; margin-bottom:20px;">
                <h2 style="margin:0;">${newParty.name}</h2>
                <small>çµæˆã®å£°æ˜</small>
            </div>
            <img src="${founder.icon}" style="width:80px; border-radius:50%; border:3px solid ${newParty.color};">
            <p style="font-size:1.1em; margin-top:10px;">
                <strong>${founder.name}</strong> æ°ã‚’ä¸­å¿ƒã¨ã™ã‚‹ ${joinedMembers.length} åãŒã€<br>
                æ–°ãŸãªã€Œ<strong>${newParty.name}</strong>ã€ã®çµæˆã‚’å®£è¨€ã—ã¾ã—ãŸã€‚
            </p>
            <div style="background:rgba(0,0,0,0.05); padding:10px; border-radius:5px; font-size:0.9em; color:#666;">
                ã€Œæ–°ã—ã„${newParty.name.replace('å…š', '')}ã®ç†æƒ³ã‚’æ²ã’ã‚‹ï¼ã€
            </div>
        </div>
    `;

            openUniversalModal("ğŸ“° é€Ÿå ±", newsHtml, [
                { text: "ç¢ºèª", cb: () => closeUniversalModal(), color: "#34495e" }
            ]);
        }
    }
    // æ”¿å…šåãƒ¡ãƒ¼ã‚«ãƒ¼
    function generateDynamicPartyName() {
        const prefixes = ["è‡ªç”±", "æ—¥æœ¬", "å›½æ°‘", "é©æ–°", "æ°‘ä¸»", "ç¤¾ä¼š", "ä¿å®ˆ", "æœªæ¥", "å¹³å’Œ", "ãƒ•ãƒ­ãƒ³ãƒ†ã‚£ã‚¢", "æ–°", "æ”¹é©", "é€²æ­©", "å…±å’Œ", "å…±ã«", "ã¿ã‚“ãªã§", "ç„¡åŠ¹åŒ–", "å", "ã‚¢ãƒ³ãƒ", "SNS"];
        const middles = ["é€²æ­©", "å…±ç”Ÿ", "æ­£ç¾©", "ãƒ•ãƒ­ãƒ³ãƒ†ã‚£ã‚¢", "æ”¹é©", "é€£å¸¯", "å¸Œæœ›", "ã®", "ãŒ", "ã ã£ãŸ"];
        const suffixes = ["å…š", "é€£åˆ", "ä¼š", "ã®ä¼š", "å…š", "é€£ç›Ÿ", "æ”¿æ²»é€£ç›Ÿ", "æ´¾", "å…š", "ã‚¯ãƒ©ãƒ–", "æ–°å…š", "å…š"]; // "å…š"ã‚’å¤šã‚ã«

        const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
        const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];

        // 50%ã®ç¢ºç‡ã§ãƒŸãƒ‰ãƒ«ãƒãƒ¼ãƒ ï¼ˆåè©ï¼‰ãŒå…¥ã‚‹
        if (Math.random() < 0.5) {
            const middle = middles[Math.floor(Math.random() * middles.length)];
            return prefix + middle + suffix;
        } else {
            return prefix + suffix;
        }
    }
    // è»éšŠ
    // 100æ—¥ã”ã¨ã«å®Ÿè¡Œã•ã‚Œã‚‹è»äº‹ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«
    function processMilitaryLifeCycle() {
        console.log("è»æ›´æ–°")

        npcs.forEach(n => {
            const gov = n.ideology.gov;
            const econ = n.ideology.econ;

            // åˆ¤å®šç”¨ã®ç§°å·ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            const isMilitarist = (gov > 70 && econ < 30) || (gov > 70 && econ > 70);

            if (n.military) {
                // é€€éšŠåˆ¤å®š: 200æ—¥ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹å ´åˆ20%ã§è¾ã‚ã‚‹
                const serviceDays = Math.floor((new Date(gameDate) - new Date(n.military.joinedDate)) / (1000 * 60 * 60 * 24));
                if (serviceDays >= 200 && Math.random() < 0.20) {
                    n.military = null;
                }
            } else {
                // å…¥éšŠåˆ¤å®š: è»å›½/æ¨©å¨ã¯60%ã€ãã®ä»–ã¯25%
                const joinChance = isMilitarist ? 0.60 : 0.25;
                if (Math.random() < joinChance) {
                    const branches = ["é™¸è»", "æµ·è»", "ç©ºè»"];
                    n.military = {
                        branch: branches[Math.floor(Math.random() * branches.length)],
                        joinedDate: new Date(gameDate),
                        power: Math.floor(Math.random() * 50) + 10 // å€‹äººã®å½±éŸ¿åŠ›
                    };
                }
            }
        });
    }
    let stats
    function getMilitaryStats() {
        stats = {
            é™¸è»: { members: [], totalPower: 0, color: "#5d6d31" },
            æµ·è»: { members: [], totalPower: 0, color: "#2980b9" },
            ç©ºè»: { members: [], totalPower: 0, color: "#7f8c8d" },
            totalSoldiers: 0
        };

        npcs.forEach(n => {
            if (n.military) {
                stats[n.military.branch].members.push(n);
                stats[n.military.branch].totalPower += n.military.power;
                stats.totalSoldiers++;
            }
        });

        // å„è»ã®ãƒªãƒ¼ãƒ€ãƒ¼ã‚’é¸å‡ºï¼ˆãã®è»ã§æœ€ã‚‚å½±éŸ¿åŠ›ãŒé«˜ã„NPCï¼‰
        ["é™¸è»", "æµ·è»", "ç©ºè»"].forEach(b => {
            stats[b].leader = stats[b].members.sort((a, b) => b.military.power - a.military.power)[0];
        });

        // ç·è»ãƒªãƒ¼ãƒ€ãƒ¼ï¼ˆå…¨è»ã§æœ€ã‚‚ãƒ‘ãƒ¯ãƒ¼ãŒã‚ã‚‹NPCï¼‰
        const allMilitary = [...stats.é™¸è».members, ...stats.æµ·è».members, ...stats.ç©ºè».members];
        stats.grandLeader = allMilitary.sort((a, b) => b.military.power - a.military.power)[0];

        return stats;
    }
    function showMilitaryModal() {
        const stats = getMilitaryStats();

        let html = `
    <div style="background:#2c3e50; color:#ecf0f1; padding:20px; border-radius:8px; font-family:sans-serif;">
        <div style="text-align:center; border-bottom:2px solid #34495e; padding-bottom:15px; margin-bottom:20px;">
            <h2 style="margin:0; letter-spacing:2px;">ğŸ›¡ï¸ å›½å®¶æœ€é«˜è»äº‹ä¼šè­°</h2>
            <small>å…¨è»ç·æ•°: ${stats.totalSoldiers} å / å›½å†…å½±éŸ¿åŠ›: ${((stats.totalSoldiers / npcs.length) * 100).toFixed(1)}%</small>
        </div>

        ${stats.grandLeader ? `
        <div style="background:#c0392b; padding:15px; border-radius:5px; margin-bottom:20px; display:flex; align-items:center; gap:15px; border:2px solid #e74c3c;">
            <img src="${stats.grandLeader.icon}" style="width:60px; height:60px; border-radius:50%; border:2px solid white;">
            <div>
                <div style="font-size:0.8em; opacity:0.8;">çµ±åˆå‚è¬€æœ¬éƒ¨ ç·è»ãƒªãƒ¼ãƒ€ãƒ¼</div>
                <div style="font-size:1.2em; font-weight:bold;">${stats.grandLeader.name}</div>
                <div style="font-size:0.7em;">æ‰€å±: ${stats.grandLeader.military.branch}</div>
            </div>
            <div style="margin-left:auto; text-align:right;">
                <div style="font-size:0.7em;">ã‚¯ãƒ¼ãƒ‡ã‚¿ãƒ¼è­¦æˆ’</div>
                <div style="font-size:1.2em; font-weight:bold;">            ${stats.é™¸è».members.length > stats.æµ·è».members.length && stats.é™¸è».members.length > stats.ç©ºè».members.length
                    ? 'ğŸš¨ é«˜' : 'âœ… ä½'}</div>
            </div>
        </div>
        ` : ''}

        <div style="display:flex; height:30px; border-radius:15px; overflow:hidden; margin-bottom:25px; border:1px solid #fff;">
            ${["é™¸è»", "æµ·è»", "ç©ºè»"].map(b => {
                        const width = stats.totalSoldiers ? (stats[b].members.length / stats.totalSoldiers) * 100 : 0;
                        return `<div style="width:${width}%; background:${stats[b].color}; transition: width 0.5s;" title="${b}"></div>`;
                    }).join('')}
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
            ${["é™¸è»", "æµ·è»", "ç©ºè»"].map(b => {
                        const branch = stats[b];
                        const leader = branch.leader;
                        const powerRatio = stats.totalSoldiers ? (branch.members.length / stats.totalSoldiers * 100).toFixed(0) : 0;

                        return `
                <div style="background:#34495e; padding:10px; border-radius:5px; border-top:5px solid ${branch.color};">
                    <div style="font-weight:bold; border-bottom:1px solid #555; margin-bottom:8px;">${b}</div>
                    <div style="font-size:0.7em; margin-bottom:10px;">
                        å‹¢åŠ›æ¯”: ${powerRatio}%<br>
                        äººå“¡: ${branch.members.length}å
                    </div>
                    ${leader ? `
                        <div style="text-align:center;">
                            <img src="${leader.icon}" style="width:40px; height:40px; border-radius:50%; background:#eee;">
                            <div style="font-size:0.75em; font-weight:bold; margin-top:5px;">${leader.name.split(' ')[0]}</div>
                            <small style="font-size:0.6em; color:#bdc3c7;">æœ€é«˜æŒ‡æ®å®˜</small>
                        </div>
                    ` : '<small>æŒ‡æ®å®˜ä¸åœ¨</small>'}
                </div>`;
                    }).join('')}
        </div>

        <div style="margin-top:20px; font-size:0.7em; background:rgba(0,0,0,0.2); padding:10px; border-radius:4px;">
            <strong>ğŸ“Œ å‹¢åŠ›æ¦‚æ³:</strong><br>
            ${stats.é™¸è».members.length > stats.æµ·è».members.length && stats.é™¸è».members.length > stats.ç©ºè».members.length
                ? "ç¾åœ¨ã€é™¸è»ãŒå›½å†…ã®æ²»å®‰æ¨©é™ã‚’æŒæ¡ã—ã¦ã„ã¾ã™ã€‚ã‚¯ãƒ¼ãƒ‡ã‚¿ãƒ¼ã¸ã®è­¦æˆ’ãŒå¿…è¦ã§ã™ã€‚"
                : "ä¸‰è»ã®å‡è¡¡ãŒä¿ãŸã‚Œã¦ã„ã¾ã™ã€‚æ–‡æ°‘çµ±åˆ¶ã¯æ¯”è¼ƒçš„å®¹æ˜“ã§ã™ã€‚"}
        </div>
    </div>
    `;

        openUniversalModal("è»äº‹æƒ…å ±ãƒ»å‹¢åŠ›å›³", html, [
            { text: "é–‰ã˜ã‚‹", cb: closeUniversalModal, color: "#7f8c8d" }
        ]);
    }
</script>

</html>