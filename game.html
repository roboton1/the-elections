<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>æ”¿æ²»ã‚²ãƒ¼ãƒ </title>
    <style>
        body {
            font-family: 'serif';
            background: #2c3e50;
            color: #ecf0f1;
            margin: 0;
            padding: 20px;
        }

        .dashboard {
            max-width: 800px;
            margin: 0 auto;
            background: #34495e;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #bdc3c7;
        }

        .header {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #7f8c8d;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .leader-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid #f1c40f;
            margin-right: 20px;
            object-fit: cover;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .stat-card {
            background: #2c3e50;
            padding: 15px;
            border-radius: 5px;
        }

        .stat-val {
            font-size: 1.2em;
            font-weight: bold;
            color: #f1c40f;
        }

        .ideology-tag {
            display: inline-block;
            padding: 5px 10px;
            background: #e67e22;
            border-radius: 4px;
            font-size: 0.8em;
            margin-top: 5px;
        }

        /* NPCãƒªã‚¹ãƒˆå°‚ç”¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼è¨­å®š */
        #npc-list::-webkit-scrollbar {
            width: 6px;
        }

        #npc-list::-webkit-scrollbar-track {
            background: #2c3e50;
            border-radius: 10px;
        }

        #npc-list::-webkit-scrollbar-thumb {
            background: #7f8c8d;
            border-radius: 10px;
        }

        #npc-list::-webkit-scrollbar-thumb:hover {
            background: #4ecca3;
        }
    </style>
</head>

<body>

    <div class="dashboard">
        <div>
            <span id="display-date" style="font-size: 1.5em; font-weight: bold; color: #4ecca3;">2026å¹´ 1æœˆ 1æ—¥</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="setGameSpeed(0)" id="btn-pause"
                style="background: #e74c3c; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">ä¸€æ™‚åœæ­¢</button>
            <button onclick="setGameSpeed(1)" id="btn-play"
                style="background: #4ecca3; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">å†ç”Ÿ</button>
            <button onclick="setGameSpeed(3)" id="btn-fast"
                style="background: #f1c40f; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">æ—©é€ã‚Š</button>
            <button onclick="setGameSpeed(50)" id="btn-skip"
                style="background: hsl(113, 89%, 50%); border: none; padding: 10px; border-radius: 5px; cursor: pointer;">ã‚¹ã‚­ãƒƒãƒ—</button>
        </div>
        <div class="stat-card" style="margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>ğŸ—³ï¸ æ¬¡ã®å¤§çµ±é ˜é¸æŒ™ã¾ã§: <strong id="election-days-left">1460</strong> æ—¥</span>
                <button onclick="openElectionHistory()"
                    style="background: #3498db; border: none; padding: 5px 10px; color: white; border-radius: 4px; cursor: pointer; font-size: 0.8em;">é¸æŒ™å±¥æ­´ãƒ»åˆ†æ</button>
            </div>
            <div style="width: 100%; background: #2c3e50; height: 10px; border-radius: 5px; margin-top: 5px;">
                <div id="election-progress"
                    style="width: 0%; background: #f1c40f; height: 100%; border-radius: 5px; transition: width 0.3s;">
                </div>
            </div>
        </div>

        <div id="voting-modal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2500; justify-content:center; align-items:center;">
            <div class="dashboard" style="width:90%; max-width:500px; text-align:center;">
                <h2 id="voting-title">æŠ•ç¥¨å…ˆã‚’é¸ã‚“ã§ãã ã•ã„</h2>
                <div id="candidate-options"
                    style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:20px 0;">
                </div>
            </div>
        </div>

        <div id="universal-modal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; justify-content:center; align-items:center; overflow-y: auto;">
            <div class="dashboard" style="width:90%; max-width:600px; position:relative; animation: modalFadeIn 0.3s;">
                <h2 id="modal-title"
                    style="color:#f1c40f; text-align:center; border-bottom: 2px solid #f1c40f; padding-bottom:10px;">
                    ã‚¿ã‚¤ãƒˆãƒ«</h2>

                <div id="modal-body" style="margin:20px 0; max-height: 70vh; overflow-y: auto;">
                </div>

                <div id="modal-footer" style="display:flex; gap:10px; justify-content:center;">
                </div>
            </div>
        </div>

        <style>
            @keyframes modalFadeIn {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        </style>

        <div id="election-result-modal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:2000; overflow-y: auto; padding: 20px; box-sizing: border-box;">
            <div id="election-content" style="max-width: 800px; margin: 0 auto; color: white;">
            </div>
            <button onclick="closeElectionModal()" id="election-close"
                style="display:block; margin: 20px auto; padding: 10px 40px; background: #e74c3c; border: none; color: white; border-radius: 5px; cursor: pointer;">é–‰ã˜ã‚‹</button>
        </div>
        <div class="header">
            <img id="display-icon" class="leader-icon" src="" alt="æŒ‡å°è€…ã‚¢ã‚¤ã‚³ãƒ³">
            <div>
                <h1 id="display-name" style="margin: 0;">æ°å</h1>
                <div id="ideology-label" class="ideology-tag">æ€æƒ³ï¼šè§£æä¸­...</div>
            </div>
        </div>

        <div class="status-grid">
            <div class="stat-card">
                <label>çµŒæ¸ˆè»¸</label>
                <div id="val-econ" class="stat-val">--</div>
                <small id="desc-econ"></small>
            </div>
            <div class="stat-card">
                <label>çµ±æ²»è»¸</label>
                <div id="val-gov" class="stat-val">--</div>
                <small id="desc-gov"></small>
            </div>
            <div class="stat-card">
                <label>å¤–äº¤è»¸</label>
                <div id="val-diplomatic" class="stat-val">--</div>
                <small id="desc-diplomatic"></small>
            </div>
        </div>
        <div class="dashboard" style="margin-top: 20px;">
            <h2>äººç‰©ãŸã¡</h2>

            <div style="margin-bottom: 15px;">
                <input type="text" id="npc-search" placeholder="åå‰ã‚„æ€æƒ³ã§æ¤œç´¢..."
                    style="width: 100%; padding: 10px; border-radius: 5px; border: none;">
            </div>
            <button onclick="addNewNPC()"
                style="width: 100%; background: #4ecca3; border: none; padding: 10px; border-radius: 5px; cursor: pointer; color: #1a1a2e; font-weight: bold; margin-bottom: 15px;">
                ï¼‹ æ–°ã—ã„äººç‰©ã‚’è¿½åŠ 
            </button>

            <div id="npc-list" style="
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 10px; 
    max-height: 400px; 
    overflow-y: auto; 
    padding-right: 5px;
"></div>
            <div id="npc-modal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center;">
                <div class="dashboard" style="width:90%; max-width:400px;">
                    <h3>äººç‰©ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</h3>
                    <label>åå‰</label>
                    <input type="text" id="edit-npc-name"
                        style="width:100%; padding:8px; box-sizing:border-box; margin-bottom:10px;">

                    <label>ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š</label>
                    <div style="display: flex; gap: 5px; margin-bottom:10px;">
                        <input type="text" id="edit-npc-seed" placeholder="ã‚·ãƒ¼ãƒ‰å€¤" style="flex: 2; padding:8px;">
                        <label
                            style="flex: 1; background: #3498db; padding: 8px; border-radius: 4px; text-align: center; cursor: pointer; font-size: 0.8em; color: white;">
                            ç”»åƒé¸æŠ
                            <input type="file" id="npc-image-upload" accept="image/*" style="display: none;">
                        </label>
                    </div>

                    <div style="text-align:center; margin:10px;">
                        <img id="edit-npc-preview" src=""
                            style="width:80px; height:80px; border-radius:50%; background:#2c3e50; border: 2px solid #bdc3c7;">
                    </div>

                    <div style="display:flex; gap:10px;">
                        <button id="save-npc-btn"
                            style="flex:1; background:#4ecca3; border:none; padding:10px; border-radius:5px; cursor:pointer;">ä¿å­˜</button>
                        <button onclick="closeModal()"
                            style="flex:1; background:#e74c3c; border:none; padding:10px; border-radius:5px; cursor:pointer; color:white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </div>
            </div>

        </div>
</body>


<script>
    let presidentElect = null; // æ¬¡æœŸå½“é¸è€…
    let president = null;
    let gameDate = new Date(2026, 0, 1); // é–‹å§‹æ—¥

    const lastNames = ["ä½è—¤", "éˆ´æœ¨", "é«˜æ©‹", "ç”°ä¸­", "ä¼Šè—¤", "æ¸¡è¾º", "å±±æœ¬", "ä¸­æ‘", "å°æ—", "åŠ è—¤", "å‰ç”°", "å±±ç”°", "ä½ã€…æœ¨", "å±±å£", "æ¾æœ¬",
        "ã‚¸ãƒ§ãƒ³", "ã‚¢ãƒ«", "ãƒãƒ¼ãƒãƒ¼ãƒ‰", "ãƒãƒ¼ãƒãƒ¼ãƒˆ", "ãƒ‰ãƒŠãƒ«ãƒ‰", "ã‚¸ãƒ§ãƒ¼", "ã‚¸ãƒ§ã‚»ãƒ•", "ã‚¸ãƒ§ãƒ¼ã‚¸", "ã‚²ã‚ªãƒ«ã‚¯", "ã‚¢ãƒ‰ãƒ«ãƒ•", "ã‚¢ãƒ­ã‚¤ã‚¹", "ãƒãƒ¼ãƒ†ã‚£ãƒ³", "ã‚¦ã‚£ãƒªã‚¢ãƒ ", "ãƒ•ãƒ©ãƒ³ã‚¯",
        "ãƒ•ãƒ©ãƒ³ã‚¯ãƒªãƒ³", "ã‚«ãƒ«ãƒ´ã‚£ãƒ³", "ã‚«ãƒ«ãƒ“ãƒ³", "ãƒ¦ã‚¹ãƒ•", "ãƒ¨ã‚»ãƒ•", "ãƒ¨ã‚»ãƒ¼ãƒ—", "ãƒ¬ã‚·ãƒ—", "ãƒ¬ã‚·ãƒƒãƒ—", "ã‚¸ã‚§ãƒ¼ãƒ ã‚º", "ã‚¸ã‚§ãƒ¼ãƒ ã‚¹", "ã‚¸ã‚§ã‚¤ãƒ ã‚º", "ã‚¢ãƒ¼ã‚µãƒ¼",
        "ãƒãƒ£ãƒ¼ãƒ«ã‚º", "ã‚¦ã‚£ãƒ³ã‚¹ãƒˆãƒ³", "ã‚¦ã‚£ãƒ³ãƒˆãƒ³", "ãƒŸãƒ©ãƒ¼ãƒ‰", "ã‚¶ã‚«ãƒªãƒ¼", "ã‚¢ãƒ³ãƒ‰ãƒªãƒ¥ãƒ¼", "ã‚¢ãƒ³ãƒ‰ãƒ«ãƒ¼", "æ", "ã‚­ã‚¢", "ãƒªã‚·", "ãƒœãƒªã‚¹", "ãƒœãƒ–", "ãƒ“ãƒ«", "ã‚°ãƒ­ãƒãƒ¼", "ã‚°ãƒ­ãƒ´ã‚¡ãƒ¼"
        , "ãƒãƒªãƒ¼", "ã‚¸ãƒ§ãƒ³ã‚½ãƒ³", "ã‚¸ãƒ§ãƒ¼ãƒ³", "ã‚·ãƒ§ãƒ¼ãƒ³", "ã‚·ãƒ§ãƒ³", "ãƒ•ãƒ©ãƒ³ã‚­ãƒ³", "ã‚¢ãƒ«ãƒ•ãƒ¬ãƒƒãƒ‰"
    ];
    const firstNames = ["å¤ªéƒ", "æ¬¡éƒ", "å¥ä¸€", "æ˜­å¤«", "å’Œä¹Ÿ", "æµ©å¸", "æ‚Ÿ", "ç›´æ¨¹", "ä¸€éƒ", "é€²", "é“å¤«", "æ­£", "ç§€æ¨¹", "è‹±äºŒ", "é›„å¤ª",
        "ã‚¢ãƒ€ãƒ ", "ã‚¢ãƒ€ãƒ ã‚º", "ã‚¢ãƒ€ãƒ ã‚¹", "ã‚¸ã‚§ãƒ•ã‚¡ãƒ¼ã‚½ãƒ³", "ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼", "ãƒ‘ãƒ¯ãƒ¼ãƒ‰", "ãƒ‘ãƒ¼ãƒˆ", "ã‚¹ãƒŸã‚¹", "ãƒ¯ã‚¤ãƒ«ãƒ‰", "ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰", "ãƒ‰ã‚¥ãƒ¼ã‚¤", "ãƒ‰ãƒ¼ã‚¤", "ã‚¹ã‚³ãƒƒãƒˆ", "ã„ã£ãºã„", "ã‚¹ã‚«ãƒƒãƒˆ",
        "ãƒœã‚½ãƒ³", "ãƒã‚ºãƒ³", "æ˜å¤«", "ã‚ããŠ", "ã‚¯ãƒ¼ãƒªãƒƒã‚¸", "ã‚¯ãƒ¼ãƒªãƒ¼", "æ —å³¶", "ã‚·ã‚²ãƒ«", "èŒ‚", "ã—ã’ãŠ", "ã—ã’ãŸ"
    ];
    const specialMiddles = ["ãƒ»Dãƒ»", "ãƒ»ãƒ•ã‚©ãƒ³ãƒ»", "ãƒ»ãƒ‡ãƒ»", "ãƒ»ãƒ´ã‚¡ãƒ³ãƒ»"];

    // A(65)ã‹ã‚‰Z(90)ã¾ã§ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦è‡ªå‹•ç”Ÿæˆ
    const alphabetMiddles = Array.from({ length: 26 }, (_, i) => `ãƒ»${String.fromCharCode(65 + i)}ãƒ»`);

    // äºŒã¤ã‚’åˆä½“ã•ã›ã¦æœ€å¼·ã®ãƒŸãƒ‰ãƒ«ãƒãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’ä½œã‚‹
    const middleNames = [...specialMiddles, ...alphabetMiddles];
    let electionCountdown = 1;
    window.onload = function () {
        // 1. LocalStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const savedData = localStorage.getItem('political_game_data');

        if (!savedData) {
            alert("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
            location.href = 'index.html'; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯æˆ»ã™
            return;
        }

        const profile = JSON.parse(savedData);

        npcs = []; // é…åˆ—ã‚’åˆæœŸåŒ–

        gameDate = profile.startYear || 2024;
        gameDate = new Date(gameDate, 0, 1); // æœˆã¯0ã‹ã‚‰å§‹ã¾ã‚‹ã®ã§0=1æœˆ

        // 1. ã¾ãšã‚«ã‚¹ã‚¿ãƒ NPCã‚’ãƒªã‚¹ãƒˆã«å…¥ã‚Œã‚‹
        if (profile.customNPCs && profile.customNPCs.length > 0) {
            profile.customNPCs.forEach(c => {
                npcs.push({
                    id: "custom-" + Math.random().toString(36).substr(2, 9),
                    name: c.name,
                    icon: c.icon,
                    ideology: {
                        economy: parseInt(c.ideology.economy),
                        government: parseInt(c.ideology.government),
                        diplomacy: parseInt(c.ideology.diplomacy)
                    },
                    isCustom: true // ã‚«ã‚¹ã‚¿ãƒ NPCãƒ•ãƒ©ã‚°
                });
            });
        }

        // 2. HTMLè¦ç´ ã«åæ˜ 
        document.getElementById('display-name').innerText = profile.name;
        document.getElementById('display-icon').src = profile.icon;

        // æ€æƒ³æ•°å€¤ã®åæ˜ 
        const econ = profile.ideology.economy;
        const gov = profile.ideology.government;
        const diplo = profile.ideology.diplomacy;

        document.getElementById('val-econ').innerText = econ;
        document.getElementById('val-gov').innerText = gov;
        document.getElementById('val-diplomatic').innerText = diplo;

        // 3. æ•°å€¤ã«åŸºã¥ã„ãŸç°¡æ˜“èª¬æ˜ã®è¡¨ç¤º
        document.getElementById('desc-econ').innerText = econ > 60 ? "å¸‚å ´çµŒæ¸ˆé‡è¦–" : (econ < 40 ? "è¨ˆç”»çµŒæ¸ˆé‡è¦–" : "æ··åˆçµŒæ¸ˆ");
        document.getElementById('desc-gov').innerText = gov > 60 ? "ç§©åºã¨æ¨©å¨" : (gov < 40 ? "å€‹äººã®è‡ªç”±" : "ä¸­åº¸ãªçµ±æ²»");
        document.getElementById('desc-diplomatic').innerText = gov > 60 ? "å›½å®¶ã«é›†ä¸­" : (gov < 40 ? "è‡ªç”±å¤–äº¤" : "æ™®é€šå¤–äº¤");

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã§è¨­å®šã—ãŸäººæ•°åˆ†ã ã‘ä½œæˆ
        const count = profile.initialNpcCount || 5;
        for (let i = 0; i < count; i++) {
            const uniqueName = generateComplexName(); // é€²åŒ–ã—ãŸåå‰ã‚’ç”Ÿæˆ
            npcs.push(createRandomNPC(uniqueName));
        }
        // åˆå›ç”Ÿæˆåˆ†ã‚’ä¿å­˜

        // 4. ç§°å·ã®åˆ¤å®šï¼ˆãŠã¾ã‘ï¼‰
        let title = "ä¸­é“";
        if (gov > 70 && econ > 70) title = "é‡‘ã˜ã‚ƒã‚“ã˜ã‚ƒã‚“ä¸»ç¾©";
        if (gov < 30 && econ < 30) title = "å¹³ç­‰ä¸»ç¾©ã®éæ¿€æ´¾";
        if (gov > 70 && econ < 30) title = "ç‹¬è£è€…";
        if (gov < 30 && econ > 70) title = "è‡ªç”±ä¸»ç¾©è€…";

        renderNPCs("", profile.ideology);


        document.getElementById('ideology-label').innerText = "ç·åˆçš„ãªæ€æƒ³: " + title;

        document.getElementById('edit-npc-seed').addEventListener('input', (e) => {
            const seed = e.target.value || "default";
            document.getElementById('edit-npc-preview').src = `https://api.dicebear.com/9.x/personas/svg?seed=${seed}`;
        });
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        document.getElementById('npc-image-upload').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('edit-npc-preview').src = event.target.result;
                    document.getElementById('edit-npc-seed').value = ""; // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã¯ã‚·ãƒ¼ãƒ‰ã‚’ç©ºã«
                };
                reader.readAsDataURL(file);
            }
        });
    };

    // æ±ç”¨ç³» //
    /**
     * @param {string} title - ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«
     * @param {string} htmlContent - ä¸­èº«ã®HTMLï¼ˆæ–‡å­—åˆ—ã§OKï¼‰
     * @param {Array} buttons - ãƒœã‚¿ãƒ³ã®é…åˆ— [{text: "æ–‡å­—", cb: é–¢æ•°, color: "è‰²"}]
     */
    function openUniversalModal(title, htmlContent, buttons = []) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-body').innerHTML = htmlContent;

        const footer = document.getElementById('modal-footer');
        footer.innerHTML = ""; // ä»¥å‰ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªã‚¢

        buttons.forEach(btnInfo => {
            const btn = document.createElement('button');
            btn.innerText = btnInfo.text;
            btn.style.cssText = `padding:10px 20px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; background:${btnInfo.color || '#4ecca3'}; color:white;`;
            btn.onclick = () => {
                btnInfo.cb(); // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
            };
            footer.appendChild(btn);
        });

        document.getElementById('universal-modal').style.display = 'flex';
    }

    function closeUniversalModal() {
        document.getElementById('universal-modal').style.display = 'none';
    }
    // æ±ç”¨ã‚·ãƒªãƒ¼ã‚ºçµ‚ã‚ã‚Š //

    function generateComplexName() {
        const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
        const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
        const rand = Math.random(); // 0.0 ã€œ 1.0

        if (rand < 0.10) {
            // 10%ã®ç¢ºç‡ã§ã€Œã€‡ã€‡2ä¸–ã€
            const suffixes = ["2ä¸–", "Jr.", "3ä¸–", "å¿"];
            const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
            return `${lastName}ãƒ»${firstName}${suffix}`;
        } else if (rand < 0.20) {
            // æ¬¡ã®10%ã®ç¢ºç‡ã§ã€ŒãƒŸãƒ‰ãƒ«ãƒãƒ¼ãƒ ã€
            const middle = middleNames[Math.floor(Math.random() * middleNames.length)];
            return `${lastName}${middle}${firstName}`;
        } else {
            // æ®‹ã‚Š80%ã¯é€šå¸¸ã®ã€Œè‹—å­— åå‰ã€
            return `${lastName}ãƒ»${firstName}`;
        }
    }


    function createRandomNPC(name) {
        // ãƒ©ãƒ³ãƒ€ãƒ ãªã‚·ãƒ¼ãƒ‰æ–‡å­—åˆ—ã‚’ç”Ÿæˆ
        const randomSeed = Math.random().toString(36).substring(7);
        return {
            id: Date.now() + Math.random(), // ğŸ’¥ å›ºæœ‰ã®IDã‚’è¿½åŠ 
            name: name,
            // DiceBear APIã‚’ä½¿ç”¨ (seedã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«)
            icon: `https://api.dicebear.com/9.x/personas/svg?seed=${randomSeed}`,
            ideology: {
                economy: Math.floor(Math.random() * 101),
                government: Math.floor(Math.random() * 101),
                diplomacy: Math.floor(Math.random() * 101)
            }
        };
    }

    // NPCã®ãƒ‡ãƒ¼ã‚¿é…åˆ—
    let npcs = [
    ];

    // æ€æƒ³ã®è¿‘ã•ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼ˆè¦ªå¯†åº¦ï¼‰
    function calculateAffinity(ideology1, ideology2) {
        // å„è»¸ã®å·®ã®çµ¶å¯¾å€¤ã‚’åˆè¨ˆã—ã€100ã‹ã‚‰å¼•ãï¼ˆå˜ç´”ãªè·é›¢è¨ˆç®—ï¼‰
        const diffEcon = Math.abs(ideology1.economy - ideology2.economy);
        const diffGov = Math.abs(ideology1.government - ideology2.government);
        const diffDipl = Math.abs(ideology1.diplomacy - ideology2.diplomacy);

        const avgDiff = (diffEcon + diffGov + diffDipl) / 3;
        return Math.round(100 - avgDiff); // 100ã«è¿‘ã„ã»ã©ä»²è‰¯ã—
    }
    let currentEditingIndex = null;

    function renderNPCs(filterText = "", playerIdeology) {
        const listElement = document.getElementById('npc-list');
        listElement.innerHTML = "";

        npcs.forEach((npc) => {
            if (!npc.name.includes(filterText)) return;

            const affinity = calculateAffinity(playerIdeology, npc.ideology);
            const title = getIdeologyTitle(npc.ideology); // ç§°å·ã‚’å–å¾—

            const card = document.createElement('div');
            card.className = "stat-card";
            card.style.cursor = "pointer";

            // ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼šindexã§ã¯ãªãnpc.idã‚’ä½¿ã£ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            card.onclick = () => openNpcModal(npc.id);

            card.innerHTML = `
            <div style="display:flex; align-items:center; margin-bottom:5px;">
                <img src="${npc.icon}" style="width:40px; height:40px; border-radius:50%; margin-right:10px; background:#2c3e50;">
                <div>
                    <div style="font-weight:bold;">${npc.name}</div>
                    <div style="font-size:0.7em; color:${affinity > 55 ? '#4ecca3' : '#e74c3c'}">
                        é–¢ä¿‚: ${affinity}%
                    </div>
                </div>
            </div>
            <div class="ideology-tag" style="font-size: 0.65em; margin-top: 2px; background: #3498db;">
                ${title}
            </div>
        `;
            listElement.appendChild(card);
        });
    }

    // --- æ–°ã—ã„NPCã‚’è¿½åŠ ã™ã‚‹é–¢æ•° ---
    function addNewNPC() {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§æ–°ã—ã„NPCã‚’ä½œæˆ
        const newNpc = createRandomNPC("æ–°ã—ã„äººç‰©");
        // é…åˆ—ã®å…ˆé ­ã«è¿½åŠ 
        npcs.unshift(newNpc);

        // ãã®ã¾ã¾ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        const playerIdeology = JSON.parse(localStorage.getItem('political_game_data')).ideology;
        renderNPCs("", playerIdeology);
    }

    // ã‚¤ãƒ‡ã‚ªãƒ­ã‚®ãƒ¼å–å¾—
    // æ€æƒ³ã‚¹ã‚³ã‚¢ã‹ã‚‰ç§°å·ï¼ˆæ€æƒ³åï¼‰ã‚’è¿”ã™å…±é€šé–¢æ•°
    function getIdeologyTitle(ideology) {
        const { economy: econ, government: gov } = ideology;
        let title = "ä¸­é“";
        if (gov > 70 && econ > 70) title = "æ–°è‡ªç”±ä¸»ç¾©"; // å…ƒï¼šé‡‘ã˜ã‚ƒã‚“ã˜ã‚ƒã‚“
        if (gov < 30 && econ < 30) title = "ã‚¢ãƒŠãƒ¼ã‚­ã‚ºãƒ "; // å…ƒï¼šå¹³ç­‰ä¸»ç¾©ã®éæ¿€æ´¾
        if (gov > 70 && econ < 30) title = "æ¨©å¨ä¸»ç¾©";   // å…ƒï¼šç‹¬è£è€…
        if (gov < 30 && econ > 70) title = "è‡ªç”±ä¸»ç¾©"; // å…ƒï¼šè‡ªç”±ä¸»ç¾©è€…

        // ã•ã‚‰ã«ç´°ã‹ãåˆ†å²ã•ã›ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™
        return title;
    }

    // --- ä¿å­˜å‡¦ç†ã®ä¿®æ­£ (ä¿å­˜ãƒœã‚¿ãƒ³ã®onclickå†…) ---
    // --- 1. ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ¶å¾¡ (DiceBear & ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰) ---

    // ã‚·ãƒ¼ãƒ‰å€¤å…¥åŠ›

    // --- 2. ä¿å­˜å‡¦ç† (ä¸€ç®‡æ‰€ã«çµ±åˆ) ---
    // --- ä¿å­˜å‡¦ç†ï¼ˆã“ã‚Œ1ã¤ã ã‘ã«ã—ã¦ãã ã•ã„ï¼ï¼‰ ---
    document.getElementById('save-npc-btn').onclick = () => {
        // currentEditingIdã‚’ä½¿ã£ã¦ã€å…ƒã®é…åˆ—ã‹ã‚‰è©²å½“è€…ã‚’æ¢ã™
        const targetNpc = npcs.find(n => n.id === currentEditingId);
        if (!targetNpc) return;

        targetNpc.name = document.getElementById('edit-npc-name').value;
        targetNpc.icon = document.getElementById('edit-npc-preview').src;

        closeModal();
        const profile = JSON.parse(localStorage.getItem('political_game_data'));
        renderNPCs(document.getElementById('npc-search').value, profile.ideology);
    };

    // --- 3. æ¤œç´¢ã‚¤ãƒ™ãƒ³ãƒˆ ---
    document.getElementById('npc-search').addEventListener('input', (e) => {
        const profile = JSON.parse(localStorage.getItem('political_game_data'));
        renderNPCs(e.target.value, profile.ideology);
    });

    function closeModal() {
        document.getElementById('npc-modal').style.display = 'none';
    }
    // NPCã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

    // 1. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openNpcModal(targetId) {
        // IDãŒä¸€è‡´ã™ã‚‹äººã‚’ä¸€äººæ¢ã™
        const npc = npcs.find(n => n.id === targetId);
        if (!npc) return;

        currentEditingId = targetId; // currentEditingIndexã®ä»£ã‚ã‚Šã«Idã‚’ä½¿ã†

        document.getElementById('edit-npc-name').value = npc.name;
        const seedMatch = npc.icon.match(/seed=([^&]+)/);
        document.getElementById('edit-npc-seed').value = seedMatch ? seedMatch[1] : "";
        document.getElementById('edit-npc-preview').src = npc.icon;
        document.getElementById('npc-modal').style.display = 'flex';
    }

    // 2. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeModal() {
        document.getElementById('npc-modal').style.display = 'none';
    }

    // 3. ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    document.getElementById('edit-npc-seed').addEventListener('input', (e) => {
        const newSeed = e.target.value || "default";
        document.getElementById('edit-npc-preview').src = `https://api.dicebear.com/9.x/personas/svg?seed=${newSeed}`;
    });

    let gameTimer = null;
    let gameSpeed = 0; // 0: åœæ­¢, 1: é€šå¸¸, 3: æ—©é€ã‚Š

    // æ—¥ä»˜ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function updateDateDisplay() {
        const year = gameDate.getFullYear();
        const month = gameDate.getMonth() + 1;
        const day = gameDate.getDate();
        document.getElementById('display-date').innerText = `${year}å¹´ ${month}æœˆ ${day}æ—¥`;
    }

    // ã‚²ãƒ¼ãƒ ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹é–¢æ•°
    function setGameSpeed(speed) {
        gameSpeed = speed;

        // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
        if (gameTimer) clearInterval(gameTimer);

        // ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒ0ã‚ˆã‚Šå¤§ãã„ãªã‚‰ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        if (gameSpeed > 0) {
            // é€šå¸¸ã¯1ç§’(1000ms)ã”ã¨ã«1æ—¥é€²ã‚€ã€‚ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒ3ãªã‚‰1/3ã®é€Ÿã•ã§é€²ã‚€
            gameTimer = setInterval(() => {
                gameDate.setDate(gameDate.getDate() + 1);
                updateDateDisplay();
                updateElectionStatus();

                // æ¯æœˆ1æ—¥ã«ä½•ã‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’èµ·ã“ã™ãªã‚‰ã“ã“
                if (gameDate.getDate() === 1) {
                    console.log("æœˆã®å§‹ã¾ã‚Šï¼äºˆç®—ã®æ›´æ–°ãªã©...");
                }
            }, 1000 / gameSpeed);
        }

        // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’å¤‰ãˆã‚‹ï¼ˆä»»æ„ï¼‰
        document.getElementById('btn-pause').style.opacity = speed === 0 ? "1" : "0.5";
        document.getElementById('btn-play').style.opacity = speed === 1 ? "1" : "0.5";
        document.getElementById('btn-fast').style.opacity = speed === 3 ? "1" : "0.5";
        document.getElementById('btn-skip').style.opacity = speed === 50 ? "1" : "0.5";

    }
    // é¸æŒ™
    // window.onloadã®å¤–ã‹ã€é©åˆ‡ãªå ´æ‰€ã«è¿½åŠ 
    let electionHistory = []; // æ­´ä»£ã®çµæœã‚’ä¿å­˜

    function updateElectionStatus() {
        // 1. ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®é€²è¡Œï¼ˆé¸æŒ™å‰ã®ã¿æ¸›ã‚‰ã™ï¼‰
        if (electionCountdown > 0) {
            electionCountdown--;
        }

        // 2. é¸æŒ™ã®ç™ºç«ï¼ˆ0ã«ãªã£ãŸç¬é–“ï¼‰
        if (electionCountdown === 0) {
            runElection();
            electionCountdown = -1; // å°±ä»»å¼ã¾ã§ã€Œå¾…æ©Ÿãƒ¢ãƒ¼ãƒ‰ã€ã¸
        }

        // 3. UIæ›´æ–°ï¼ˆãƒã‚¤ãƒŠã‚¹ã‚’è¡¨ç¤ºã•ã›ãªã„ã€100%ã§æ­¢ã‚ã‚‹ï¼‰
        const displayDays = Math.max(0, electionCountdown);
        document.getElementById('election-days-left').innerText = displayDays;

        // é¸æŒ™å¾Œã¯ãƒãƒ¼ã‚’100%ã§å›ºå®šã€é¸æŒ™å‰ã¯è¨ˆç®—
        let progress;
        if (electionCountdown <= 0) {
            progress = 100;
        } else {
            progress = ((1460 - electionCountdown) / 1460) * 100;
        }
        document.getElementById('election-progress').style.width = Math.min(100, progress) + "%";

        // 4. å°±ä»»å¼ã®ãƒã‚§ãƒƒã‚¯ (1æœˆ20æ—¥)
        if (gameDate.getMonth() === 0 && gameDate.getDate() === 20 && presidentElect) {
            holdInauguration();
            // â€»ã“ã®ä¸­ã®å‡¦ç†ã§ electionCountdown = 1460 ã«æˆ»ã‚‹
        }
    }

    function holdInauguration() {
        setGameSpeed(0); // æ™‚é–“ã‚’æ­¢ã‚ã‚‹

        let farewellMessage = "";

        if (president) {
            // å‰å¤§çµ±é ˜ã¨æ–°å¤§çµ±é ˜ã®æ€æƒ³ç›¸æ€§ã‚’è¨ˆç®—
            const affinity = calculateAffinity(president.ideology, presidentElect.ideology);

            // ç›¸æ€§ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åˆ†å²
            if (affinity >= 80) {
                farewellMessage = `ã€Œ${presidentElect.name}ã€ã‚ãªãŸã¯ã€å¤§çµ±é ˜ã¨ã—ã¦è·å‹™ã‚’é ‘å¼µã£ã¦ãã ã•ã„ã€å¿œæ´ã—ã¦ã„ã¾ã™ã€‚ã€`;
            } else if (affinity >= 50) {
                farewellMessage = `ã€Œ${presidentElect.name}ã€ã“ã‚Œã‹ã‚‰ã¯ã‚ãªãŸã®æ™‚ä»£ã§ã™ã€é ‘å¼µã£ã¦ãã ã•ã„ã€å¿œæ´ã—ã¦ã¾ã™ã€‚ã€`;
            } else if (affinity >= 30) {
                farewellMessage = `ã€Œ${presidentElect.name}ã€ã‚ãªãŸãŒå¤§çµ±é ˜ã«ãªã‚‹ã¨ã¯æ€ã‚ãªã‹ã£ãŸã€ã“ã‚Œã‹ã‚‰ã®æ™‚ä»£ãŒã©ã†ãªã‚‹ã‹ã‚ã‹ã‚Šã¾ã›ã‚“ãŒã€é ‘å¼µã£ã¦ãã ã•ã„ã€‚ã€`;
            } else {
                farewellMessage = `ã€Œ${presidentElect.name}ã€ã‚ãªãŸãŒå¤§çµ±é ˜ã«ãªã‚‹ã¨ã¯ã ã‚Œã‚‚äºˆæƒ³ã—ã¦ã„ãªã‹ã£ãŸã€æ­£ç›´è¨€ã£ã¦ã“ã‚ŒãŒç¾å®Ÿã ã¨ã¯æ€ã„ãŸããªã„ã€‚ã€`;
            }
        }

        const isPlayer = presidentElect.isPlayer; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå½“é¸ã—ãŸã‹
        const title = isPlayer ? "ã‚ãªãŸã®å°±ä»»å¼" : `${presidentElect.name}å¤§çµ±é ˜å°±ä»»å¼`;
        let html = `
        <div style="background:#1a2a6c; color:white; padding:30px; border-radius:10px; text-align:center; border: 5px solid #f1c40f;">
            <h1 style="margin-bottom:20px;">ğŸ›ï¸å°±ä»»å¼ã®æ—¥</h1>
            <img src="${presidentElect.icon}" style="width:120px; height:120px; border-radius:50%; border:5px solid white; background:white;">
            <h2 style="margin-top:20px;">${presidentElect.name}</h2>
            <p style="font-style:italic; font-size:1.1em; margin:20px 0;">
                "ç§ã¯å¤§çµ±é ˜ã«å°±ä»»ã—ã¾ã™ã€‚"
            </p>
            <div style="font-size:0.9em; color:#bdc3c7;">
                ${gameDate.getFullYear()}å¹´1æœˆ20æ—¥ æ­£åˆ
            </div>
        </div>
    `;
        if (president) {
            html += `<div style="background:#1a2a6c; color:white; padding:30px; border-radius:10px; text-align:center; border: 5px solid #f1c40f;">
            <h1 style="margin-bottom:20px; font-size:1.5em;">ğŸ›ï¸å°±ä»»å¼ã®æ—¥</h1>
            
                        <img src="${president.icon}" style="width:120px; height:120px; border-radius:50%; border:5px solid white; background:white;">
            <h2 style="margin-top:20px;">${president.name}</h2>
                <div style="margin-bottom:20px; padding:10px; background:rgba(0,0,0,0.3); border-radius:5px;">
                    <small>å‰å¤§çµ±é ˜${president.name}ã®é€€ä»»:</small>
                    <p style="font-size:1.1em; color:#ecf0f1;">${farewellMessage}</p>
                </div>
            </div >`;
        }
        president = presidentElect

        openUniversalModal(title, html, [
            {
                text: "æ–°æ”¿æ¨©ã€å§‹å‹•",
                cb: () => {
                    // ã“ã“ã§æ­£å¼ã«å¤§çµ±é ˜ã‚’æ›´æ–°ã™ã‚‹
                    currentPresident = presidentElect;
                    presidentElect = null; // ã‚¯ãƒªã‚¢
                    closeUniversalModal();
                    setGameSpeed(1);
                },
                color: "#f1c40f"
            }
        ]);
    }

    function runElection() {
        setGameSpeed(0); // æ™‚é–“ã‚’æ­¢ã‚ã‚‹
        const profile = JSON.parse(localStorage.getItem('political_game_data'));

        // ç«‹å€™è£œç¢ºèªç”¨ã®HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„
        const htmlContent = `
            <div style = "text-align:center; padding:20px;" >
            <p style="font-size:1.2em;">ç¬¬${electionHistory.length + 1}å›å¤§çµ±é ˜é¸æŒ™ãŒå…¬ç¤ºã•ã‚Œã¾ã—ãŸã€‚</p>
            <p>ã“ã®é¸æŒ™ã«ç«‹å€™è£œã—ã¾ã™ã‹ï¼Ÿ</p>
            <div style="margin-top:20px; font-size:0.8em; color:#bdc3c7;">
                â€»ç«‹å€™è£œã™ã‚‹ã¨ã€ã‚ãªãŸã®æ”¯æŒè€…ãŒã€ã‚ãªãŸã«æŠ•ç¥¨ã—ã¾ã™ã€‚<br>
                ç«‹å€™è£œã—ãªã„å ´åˆã¯ã€ä»–ã®å€™è£œè€…ã¸ã®æŠ•ç¥¨æ¨©ã®ã¿æŒã¡ã¾ã™ã€‚
            </div>
        </div >
            `;

        // æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã€Œç«‹å€™è£œã™ã‚‹ã‹ã€ã‚’èã
        openUniversalModal(
            "ğŸ—³ï¸ é¸æŒ™ç«‹å€™è£œã®ç¢ºèª",
            htmlContent,
            [
                {
                    text: "ç«‹å€™è£œã™ã‚‹ï¼",
                    color: "#4ecca3",
                    cb: () => proceedToVote(true) // ç«‹å€™è£œã—ã¦æ¬¡ã¸
                },
                {
                    text: "ä»Šå›ã¯è¦‹é€ã‚‹",
                    color: "#e74c3c",
                    cb: () => proceedToVote(false) // ç«‹å€™è£œã›ãšæ¬¡ã¸
                }
            ]
        );
    }

    function proceedToVote(willRun) {
        closeUniversalModal(); // ä¸€æ—¦é–‰ã˜ã‚‹

        const profile = JSON.parse(localStorage.getItem('political_game_data'));
        let candidates = [];

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å€™è£œè€…ã«è¿½åŠ 
        if (willRun) {
            candidates.push({
                id: 'player',
                name: profile.name,
                icon: profile.icon,
                isPlayer: true,
                ideology: profile.ideology,
                votes: 0,
                supporters: []
            });
        }

        // NPCã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«3äººç«‹å€™è£œï¼ˆå…ˆè¡Œè€…åˆ©ç›Šæ ï¼‰
        const npcPotential = [...npcs].sort(() => 0.5 - Math.random()).slice(0, 3);
        npcPotential.forEach(n => {
            candidates.push({ ...n, votes: 0, supporters: [], isPlayer: false });
        });

        // æ¬¡ã®ã€ŒæŠ•ç¥¨å…ˆé¸æŠã€ã¸é€²ã‚€
        showVotingScreen(candidates, willRun);
    }

    function showVotingScreen(candidates, willRun) {
        const title = willRun ? "æŠ•ç¥¨ã™ã‚‹å€™è£œè€…ã‚’é¸ã‚“ã§ãã ã•ã„" : "æŠ•ç¥¨ã™ã‚‹å€™è£œè€…ã‚’é¸ã‚“ã§ãã ã•ã„";

        let html = `<div style = "display:grid; grid-template-columns:1fr 1fr; gap:10px;" > `;
        candidates.forEach(cand => {
            html += `
            <div id = "vote-target-${cand.id}" class="stat-card" style = "cursor:pointer; text-align:center; border: 1px solid #7f8c8d;" >
                <img src="${cand.icon}" style="width:50px; border-radius:50%;"><br>
                    <strong>${cand.name}</strong><br>
                        <small>${getIdeologyTitle(cand.ideology)}</small>
                    </div>
                    `;
        });
        html += `</div>`;

        // æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã§æŠ•ç¥¨å…ˆã‚’è¡¨ç¤º
        openUniversalModal(title, html, []); // ãƒœã‚¿ãƒ³ã¯JSã§å¾Œã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸

        // å„ã‚«ãƒ¼ãƒ‰ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»˜ä¸
        candidates.forEach(cand => {
            document.getElementById(`vote-target-${cand.id}`).onclick = () => {
                finalizeElection(candidates, cand.id);
            };
        });
    }

    function finalizeElection(candidates, playerVoteTargetId) {
        closeUniversalModal();
        document.getElementById('voting-modal').style.display = 'none';

        // 1. NPCãŸã¡ã®è‡ªå‹•æŠ•ç¥¨ï¼ˆå…ˆè¡Œè€…è£œæ­£ã‚ã‚Šï¼‰
        npcs.forEach(npc => {
            let bestAffinity = -1;
            let voteTo = null;

            candidates.forEach(cand => {
                const aff = calculateAffinity(npc.ideology, cand.ideology);
                const priorityBonus = (candidates.indexOf(cand) === 0) ? 8 : 0; // ç­†é ­å€™è£œã¸ã®è£œæ­£

                if ((aff + priorityBonus) > bestAffinity) {
                    bestAffinity = aff + priorityBonus;
                    voteTo = cand;
                }
            });
            if (voteTo) {
                voteTo.votes++;
                voteTo.supporters.push(npc.icon);
            }
        });

        // 2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®1ç¥¨ã‚’åŠ ç®—
        const myChoice = candidates.find(c => c.id === playerVoteTargetId);
        if (myChoice) {
            myChoice.votes++;
            const profile = JSON.parse(localStorage.getItem('political_game_data'));
            myChoice.supporters.push(profile.icon);
        }

        // 3. çµæœè¡¨ç¤º
        candidates.sort((a, b) => b.votes - a.votes);
        presidentElect = candidates[0];

        electionHistory.push({
            date: new Date(gameDate),
            winner: presidentElect,
            all: candidates,
            inaugurated: false // ã¾ã å°±ä»»ã—ã¦ã„ãªã„ãƒ•ãƒ©ã‚°
        });
        showElectionResult(candidates);
    }

    function showElectionResult(results) {
        const content = document.getElementById('election-content');
        const [first, second, ...others] = results;

        let html = `<h1 style="text-align:center; color:#f1c40f;">ğŸ—³ï¸ é¸æŒ™çµæœç™ºè¡¨</h1>`;

        // ä¸Šä½2åã®ç‰¹å¤§è¡¨ç¤º
        html += `
                    <div style="display:flex; justify-content:center; gap:20px; margin-top:30px;">
                        <div style="text-align:center; border:2px solid #f1c40f; padding:20px; border-radius:10px; width:45%;">
                            <h2>ğŸ¥‡ 1ä½ (å½“é¸)</h2>
                            <img src="${first.icon}" style="width:120px; height:120px; border-radius:50%; border:4px solid #f1c40f;">
                                <div style="font-size:1.5em; font-weight:bold; margin-top:10px;">${first.name}</div>
                                <div style="font-size:2em; color:#f1c40f;">${first.votes} ç¥¨</div>
                                <div style="margin-top:10px;">æ”¯æŒè€…:<br>${first.supporters.map(img => `<img src="${img}" style="width:25px; border-radius:50%;">`).join("")}</div>
                        </div>
                        <div style="text-align:center; border:2px solid #bdc3c7; padding:20px; border-radius:10px; width:40%;">
                            <h2>ğŸ¥ˆ 2ä½</h2>
                            <img src="${second.icon}" style="width:100px; height:100px; border-radius:50%; border:2px solid #bdc3c7;">
                                <div style="font-size:1.2em; margin-top:10px;">${second.name}</div>
                                <div style="font-size:1.8em; color:#bdc3c7;">${second.votes} ç¥¨</div>
                                <div style="margin-top:10px;">æ”¯æŒè€…:<br>${second.supporters.map(img => `<img src="${img}" style="width:20px; border-radius:50%;">`).join("")}</div>
                        </div>
                    </div>`;

        // æ®‹ã‚Šã®å€™è£œè€…ã‚’ä¸‹ã«å°ã•ã
        html += `<div style="display:flex; justify-content:center; gap:15px; margin-top:40px; flex-wrap:wrap;">`;
        others.forEach(cand => {
            html += `
        <div style="text-align:center; background:#34495e; padding:10px; border-radius:8px; width:100px; font-size:0.8em;">
            <img src="${cand.icon}" style="width:50px; border-radius:50%;">
            <div>${cand.name}</div>
            <div>${cand.votes} ç¥¨</div>
        </div>`;
        });
        html += `</div>`;
        html += `
                    <div style="text-align:center;">
                        <h2 style="color:#f1c40f;">é¸æŒ™é€Ÿå ±</h2>
                        <img src="${presidentElect.icon}" style="width:100px; border-radius:50%; border:4px solid #f1c40f;">
                            <p style="font-size:1.2em;"><strong>${presidentElect.name}</strong> æ°ã®å½“é¸ãŒç¢ºå®Ÿã¨ãªã‚Šã¾ã—ãŸï¼</p>
                            <p>1æœˆ20æ—¥ã®å°±ä»»å¼ã¾ã§ã€æ”¿æ¨©ç§»è¡ŒæœŸé–“ã«å…¥ã‚Šã¾ã™ã€‚</p>
                    </div>
                    `;

        content.innerHTML = html;
        document.getElementById('election-result-modal').style.display = 'block';
        setGameSpeed(0); // çµæœç™ºè¡¨æ™‚ã¯æ™‚é–“ã‚’æ­¢ã‚ã‚‹
        electionCountdown = 1460;

    }

    // é¸æŒ™çµæœã‚’é–‰ã˜ãŸã‚‰ãƒ‡ã‚£ãƒŠãƒ¼ä¼šã¸
    function closeElectionModal() {
        document.getElementById('election-result-modal').style.display = 'none';
        // é¸æŒ™çµæœã®é€Ÿå ±ã‚’è¡¨ç¤º
        // é–‹å‚¬ã•ã‚Œã‚‹å ´åˆ
        startPostElectionDinner();
    }

    function startPostElectionDinner() {
        // 1. ã¾ãš40%ã®ç¢ºç‡ã§ã‚¤ãƒ™ãƒ³ãƒˆè‡ªä½“ãŒæ¶ˆæ»…
        if (Math.random() < 0.4) {
            openUniversalModal(
                "ğŸ½ï¸ ãƒ‡ã‚£ãƒŠãƒ¼ä¼šä¸­æ­¢",
                `<div style="text-align:center;">å„å€™è£œè€…ã®è«¸äº‹æƒ…ã«ã‚ˆã‚Šã€æœ¬æ—¥ã®ãƒ‡ã‚£ãƒŠãƒ¼ä¼šã¯ä¸­æ­¢ã§ã™ã€‚</div>`,
                [{ text: "äº†è§£", cb: closeUniversalModal, color: "#7f8c8d" }]
            );
            return;
        }

        const lastElection = electionHistory[electionHistory.length - 1];
        const playerInElection = lastElection.all.some(cand => cand.isPlayer);

        if (playerInElection) {
            // ã€ç«‹å€™è£œã—ã¦ã„ãŸå ´åˆã€‘ã¾ãšå‚åŠ ã™ã‚‹ã‹ã©ã†ã‹ã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«èã
            openUniversalModal(
                "âœ‰ï¸ ãƒ‡ã‚£ãƒŠãƒ¼ã¸ã®æ‹›å¾…",
                `<div style="text-align:center;">
                é¸æŒ™ãŒçµ‚ã‚ã‚Šã€ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‹ã‚‰æ‹›å¾…çŠ¶ãŒå±Šãã¾ã—ãŸã€‚<br>
                ç”Ÿé…ä¿¡ãƒ©ã‚¤ãƒ–ãŒè¡Œã‚ã‚Œã‚‹äºˆå®šã§ã™ãŒã€å‡ºå¸­ã—ã¾ã™ã‹ï¼Ÿ
            </div>`,
                [
                    { text: "å‡ºå¸­ã™ã‚‹", cb: () => processDinner(true), color: "#4ecca3" },
                    { text: "ä¸å‚åŠ ", cb: () => processDinner(false), color: "#e74c3c" }
                ]
            );
        } else {
            // ã€è¦³å®¢ã®å ´åˆã€‘ãã®ã¾ã¾é…ä¿¡ã‚’è¦‹ã‚‹ç”»é¢ã¸
            processDinner(false, true);
        }
    }

    /**
     * å®Ÿéš›ã®ãƒ‡ã‚£ãƒŠãƒ¼å‡¦ç†
     * @param {boolean} playerAttending - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‡ºå¸­ã™ã‚‹ã‹
                    * @param {boolean} isSpectator - è¦³å®¢ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹
                    */
    function processDinner(playerAttending, isSpectator = false) {
        const lastElection = electionHistory[electionHistory.length - 1];
        let attendeesCount = 0;
        let html = `<div style="background:#000; color:#0f0; padding:5px; font-family:monospace; margin-bottom:10px;">ğŸ”´ LIVE:ã€ã”ã¯ã‚“ã€‘ã‚ªãƒ„ã‚«ãƒ¬ã•ã¾ãƒ‡ã‚£ãƒŠãƒ¼</div>`;
        html += `<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:15px;">`;

        lastElection.all.forEach(cand => {
            let statusText = "";
            let opacity = "1";
            let isAttending = false;

            if (cand.isPlayer) {
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆ¤å®š
                if (playerAttending) {
                    statusText = "âœ… å‚åŠ ";
                    isAttending = true;
                } else {
                    statusText = "ğŸ’¢ ä¸å‚åŠ ";
                    opacity = "0.3";
                }
            } else {
                // NPCã®åˆ¤å®š
                const rand = Math.random();
                if (rand < 0.15) { statusText = "ğŸ¤’ é¢¨é‚ªæ¬ å¸­"; opacity = "0.3"; }
                else if (rand < 0.3) { statusText = "ğŸ’¢ ä¸å‚åŠ "; opacity = "0.3"; }
                else {
                    statusText = "âœ… å‚åŠ ";
                    isAttending = true;
                }
            }

            if (isAttending) attendeesCount++;

            html += `
                        <div style="text-align:center; opacity:${opacity}; background:#2c3e50; padding:10px; border-radius:10px; border: 1px solid ${opacity === "1" ? '#4ecca3' : 'transparent'};">
                        <img src="${cand.icon}" style="width:60px; border-radius:50%;"><br>
                            <strong style="font-size:0.8em;">${cand.name}</strong><br>
                                <span style="font-size:0.65em;">${statusText}</span>
                            </div>
                            `;
        });
        html += `</div>`;

        // çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ
        let resultMessage = "";
        if (isSpectator) {
            resultMessage = "è¦–è´è€…ã¨ã—ã¦ãƒ©ã‚¤ãƒ–ã‚’è¦‹å®ˆã£ã¦ã„ã¾ã™ã€‚";
        } else if (playerAttending) {
            resultMessage = attendeesCount > 1 ? "è³‘ã‚„ã‹ãªä¼šé£Ÿã¨ãªã‚Šã¾ã—ãŸã€éå¸¸ã«æ¥½ã—ã„é£Ÿäº‹ã§ã—ãŸã€‚" : "å‚åŠ è€…ã¯ã‚ãªãŸä¸€äººã§ã—ãŸã€‚è±ªè¯ãªæ–™ç†ã‚’ç‹¬ã‚Šå ã‚ã§ã™ã€‚";
        } else {
            resultMessage = "ã‚ãªãŸã¯æ¬ å¸­ã—ã¾ã—ãŸã€‚ãƒ©ã‚¤ãƒ–é…ä¿¡ã®ãƒãƒ£ãƒƒãƒˆæ¬„ã§ã¯ã‚ãªãŸã®ä¸åœ¨ãŒå™‚ã•ã‚Œã¦ã„ã¾ã™ã€‚";
        }

        html += `<p style="margin-top:15px; font-size:0.9em; text-align:center; color:#bdc3c7;">${resultMessage}</p>`;

        // ãƒœã‚¿ãƒ³ã®è¨­å®š
        const buttons = [];
        if (isSpectator) {
            buttons.push({ text: "é£Ÿäº‹ãƒ©ã‚¤ãƒ–ã‚’æœ€å¾Œã¾ã§è¦‹ã‚‹", cb: closeUniversalModal, color: "#3498db" });
            buttons.push({ text: "é£Ÿäº‹ãƒ©ã‚¤ãƒ–ã‚’é–‰ã˜ã‚‹", cb: closeUniversalModal, color: "#7f8c8d" });
        } else {
            buttons.push({ text: playerAttending ? "ä¼šé£Ÿã‚’çµ‚ãˆã‚‹" : "ãƒ©ã‚¤ãƒ–é…ä¿¡ã‚’é–‰ã˜ã‚‹", cb: closeUniversalModal, color: "#4ecca3" });
        }

        openUniversalModal("ğŸ½ï¸ é¸æŒ™å¾Œãƒ‡ã‚£ãƒŠãƒ¼çµæœ", html, buttons);
    }

    function openElectionHistory() {
        setGameSpeed(0);

        if (electionHistory.length === 0) {
            openUniversalModal(
                "ğŸ“œ æ­´ä»£é¸æŒ™ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–",
                `<div style="text-align:center; padding:50px;">
                <h2>ã¾ã é¸æŒ™ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</h2>
                <p>æœ€åˆã®é¸æŒ™ãŒå®Ÿæ–½ã•ã‚Œã‚‹ã¾ã§å¾…ã¡ã¾ã—ã‚‡ã†ã€‚</p>
             </div>`,
                [{ text: "é–‰ã˜ã‚‹", cb: closeUniversalModal, color: "#7f8c8d" }]
            );
            return;
        }

        let html = `<div style="padding:10px;">`;
        // æœ€æ–°ã®å±¥æ­´ã‹ã‚‰é †ã«ç”Ÿæˆ
        [...electionHistory].reverse().forEach((record, index) => {
            const realIndex = electionHistory.length - 1 - index;
            const dateStr = `${record.date.getFullYear()}/${record.date.getMonth() + 1}/${record.date.getDate()}`;
            const isPlayerWinner = record.winner.isPlayer;

            html += `
                                <div onclick="showElectionDetail(${realIndex})"
                                    style="background:#34495e; padding:15px; border-radius:10px; margin-bottom:12px; border-left: 5px solid ${isPlayerWinner ? '#4ecca3' : '#e74c3c'}; cursor:pointer;">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <div>
                                            <div style="font-size:0.7em; color:#bdc3c7;">ç¬¬ ${realIndex + 1} æœŸ é¸æŒ™</div>
                                            <div style="font-weight:bold; font-size:1.1em;">å½“é¸è€…: ${record.winner.name}</div>
                                            <div style="font-size:0.75em;">${dateStr} å®Ÿæ–½</div>
                                        </div>
                                        <img src="${record.winner.icon}" style="width:45px; border-radius:50%; background:#2c3e50;">
                                    </div>
                                </div>`;
        });
        html += `</div>`;
        setGameSpeed(0);

        // æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã§å±¥æ­´ä¸€è¦§ã‚’è¡¨ç¤º
        openUniversalModal(
            "ğŸ“œ æ­´ä»£é¸æŒ™ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–",
            html,
            [{ text: "é–‰ã˜ã‚‹", cb: closeUniversalModal, color: "#34495e" }]
        );
    }

    function showElectionDetail(historyIndex) {
        const record = electionHistory[historyIndex];
        const totalVotes = record.all.reduce((sum, c) => sum + c.votes, 0);
        const dateStr = `${record.date.getFullYear()}å¹´${record.date.getMonth() + 1}æœˆ${record.date.getDate()}æ—¥`;

        // Wikipedia Infoboxé¢¨ã®HTMLæ§‹ç¯‰
        let html = `
                            <div style="background:#f8f9fa; color:#202122; padding:20px; border-radius:5px; font-family: sans-serif;">
                                <div style="text-align:center; border-bottom:1px solid #a2a9b1; margin-bottom:10px; padding-bottom:10px;">
                                    <h2 style="margin:0; font-size:1.2em;">ç¬¬ ${historyIndex + 1} æœŸ å¤§çµ±é ˜é¸æŒ™ è©³ç´°</h2>
                                    <small>${dateStr} å®Ÿæ–½</small>
                                </div>

                                <table style="width:100%; border-collapse: collapse; text-align:center; table-layout: fixed;">
                                    <tr>
                                        ${record.all.slice(0, 3).map((cand, i) => `
                        <td style="padding:5px; vertical-align: top;">
                            <div style="font-size:0.8em; font-weight:bold;">${i === 0 ? 'ã€å½“é¸ã€‘' : 'å€™è£œè€…'}</div>
                            <img src="${cand.icon}" style="width:80px; height:80px; border-radius:50%; background:#eaecf0; border:1px solid #a2a9b1; margin:5px 0;">
                            <div style="font-weight:bold; height:2.4em; overflow:hidden;">${cand.name}</div>
                            <div style="background:${i === 0 ? '#4ecca3' : '#3498db'}; color:white; padding:2px; margin:5px 0; font-size:0.9em;">
                                ${((cand.votes / totalVotes) * 100).toFixed(1)}%
                            </div>
                            <div style="font-size:1.1em; font-weight:bold;">${cand.votes} ç¥¨</div>
                        </td>
                    `).join('')}
                                    </tr>
                                </table>

                                <div style="margin-top:20px; border-top:1px solid #a2a9b1; padding-top:10px;">
                                    <h3 style="font-size:0.9em; border-bottom:1px solid #eaecf0;">ğŸ“Š æŠ•ç¥¨è€…åˆ†æï¼ˆæ”¯æŒå±¤ã‚¢ã‚¤ã‚³ãƒ³ï¼‰</h3>
                                    <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;">
                                        ${record.all.slice(0, 3).map(cand => `
                        <div style="flex:1; min-width:80px; background:#fff; border:1px solid #c8ccd1; padding:5px; border-radius:3px;">
                            <small style="display:block; border-bottom:1px solid #eee;">${cand.name.split(' ')[0]}æ´¾</small>
                            <div style="display:flex; flex-wrap:wrap; gap:2px; margin-top:5px;">
                                ${cand.supporters.map(sIcon => `<img src="${sIcon}" style="width:18px; height:18px; border-radius:50%;">`).join('')}
                            </div>
                        </div>
                    `).join('')}
                                    </div>
                                </div>

                                <div style="margin-top:15px; font-size:0.75em; color:#54595d; line-height:1.4;">
                                    <p>æ³¨è¨˜: ã“ã®é¸æŒ™çµæœã¯è‡ªå‹•é›†è¨ˆã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚
                                        ç·å¾—ç¥¨æ•°: ${totalVotes}ç¥¨ / æ£„æ¨©: ãªã—</p>
                                </div>
                            </div>
    `;

        // æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’èµ·å‹•ï¼
        openUniversalModal(
            "Wikipedia: é¸æŒ™ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–",
            html,
            [{ text: "ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’é–‰ã˜ã‚‹", cb: closeUniversalModal, color: "#34495e" }]
        );
    }
</script>

</html>