<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>æ”¿æ²»ã‚²ãƒ¼ãƒ </title>
    <style>
        body {
            font-family: 'serif';
            background: #2c3e50;
            color: #ecf0f1;
            margin: 0;
            padding: 20px;
        }

        .dashboard {
            max-width: 800px;
            margin: 0 auto;
            background: #34495e;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #bdc3c7;
        }

        .header {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #7f8c8d;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .leader-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid #f1c40f;
            margin-right: 20px;
            object-fit: cover;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .stat-card {
            background: #2c3e50;
            padding: 15px;
            border-radius: 5px;
        }

        .cabinet-card {
            background: #9b9b9b;
            padding: 15px;
            border-radius: 5px;
        }

        .cabinet-card text {
            color: #f1c40f;
        }

        .stat-val {
            font-size: 1.2em;
            font-weight: bold;
            color: #f1c40f;
        }

        .ideology-tag {
            display: inline-block;
            padding: 5px 10px;
            background: #e67e22;
            border-radius: 4px;
            font-size: 0.8em;
            margin-top: 5px;
        }

        /* NPCãƒªã‚¹ãƒˆå°‚ç”¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼è¨­å®š */
        #npc-list::-webkit-scrollbar {
            width: 6px;
        }

        #npc-list::-webkit-scrollbar-track {
            background: #2c3e50;
            border-radius: 10px;
        }

        #npc-list::-webkit-scrollbar-thumb {
            background: #7f8c8d;
            border-radius: 10px;
        }

        #npc-list::-webkit-scrollbar-thumb:hover {
            background: #4ecca3;
        }

        /* é€šçŸ¥ã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆå³å´ã«å›ºå®šï¼‰ */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            /* ä¸‹ã®è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ */
        }

        /* é€šçŸ¥æœ¬ä½“ */
        .toast-card {
            pointer-events: auto;
            /* ã‚«ãƒ¼ãƒ‰å†…ã¯ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã« */
            width: 280px;
            background: rgba(44, 62, 80, 0.95);
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-left: 5px solid #3498db;
            position: relative;
            animation: slideInRight 0.3s ease-out;
            font-size: 0.9em;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-close {
            position: absolute;
            top: 5px;
            right: 8px;
            cursor: pointer;
            font-size: 1.2em;
            opacity: 0.7;
        }

        .toast-close:hover {
            opacity: 1;
        }

        .election-progress-container {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            display: flex;
            overflow: hidden;
            margin: 20px 0;
            position: relative;
            border: 2px solid #34495e;
        }

        .majority-line {
            position: absolute;
            left: 50%;
            top: 0;
            width: 2px;
            height: 100%;
            background: red;
            z-index: 10;
        }

        .majority-label {
            position: absolute;
            left: 50%;
            top: -20px;
            transform: translateX(-50%);
            font-size: 10px;
            color: red;
            font-weight: bold;
        }

        .elected-member-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin: 2px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }

        .elected-member-icon:hover {
            transform: scale(1.2);
            z-index: 5;
        }

        .party-block {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            text-align: left;
        }
    </style>
</head>

<body>

    <div class="dashboard">

        <div>
            <span id="display-date" style="font-size: 1.5em; font-weight: bold; color: #4ecca3;">2026å¹´ 1æœˆ 1æ—¥</span>
        </div>
        <button onclick="openSettingsModal()"
            style="padding:10px; background: #3498db; border: none; padding: 5px 10px; color: white; border-radius: 4px; cursor: pointer; font-size: 0.8em;">é€šçŸ¥è¨­å®š</button>
        <div style="display: flex; gap: 10px;">
            <button onclick="setGameSpeed(0)" id="btn-pause"
                style="background: #e74c3c; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">ä¸€æ™‚åœæ­¢</button>
            <button onclick="setGameSpeed(1)" id="btn-play"
                style="background: #4ecca3; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">å†ç”Ÿ</button>
            <button onclick="setGameSpeed(3)" id="btn-fast"
                style="background: #f1c40f; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">æ—©é€ã‚Š</button>
            <button onclick="setGameSpeed(50)" id="btn-skip"
                style="background: hsl(113, 89%, 50%); border: none; padding: 10px; border-radius: 5px; cursor: pointer;">ã‚¹ã‚­ãƒƒãƒ—</button>
        </div>
        <div class="stat-card" style="margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>ğŸ—³ï¸ æ¬¡ã®å¤§çµ±é ˜é¸æŒ™ã¾ã§: <strong id="election-days-left"></strong> æ—¥</span>
                <button onclick="openElectionHistory()"
                    style="background: #3498db; border: none; padding: 5px 10px; color: white; border-radius: 4px; cursor: pointer; font-size: 0.8em;">é¸æŒ™å±¥æ­´ãƒ»åˆ†æ</button>
                <button onclick="openPartyMenu()"
                    style="background: #3498db; border: none; padding: 5px 10px; color: white; border-radius: 4px; cursor: pointer; font-size: 0.8em;">å…šãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
                <button onclick="showlog()"
                    style="background: #3498db; border: none; padding: 5px 10px; color: white; border-radius: 4px; cursor: pointer; font-size: 0.8em;">æ´»å‹•è¨˜éŒ²</button>
            </div>
            <div style="width: 100%; background: #2c3e50; height: 10px; border-radius: 5px; margin-top: 5px;">
                <div id="election-progress"
                    style="width: 0%; background: #f1c40f; height: 100%; border-radius: 5px; transition: width 0.3s;">
                </div>
            </div>
        </div>

        <div id="log-window" style="background:#2c3e50; padding:10px; border-radius:5px; height:200px; overflow-y:auto; display:none;
            margin-top: 10px;">
            <h4 style="margin:0 0 10px 0; color:#bdc3c7; border-bottom:1px solid #3d4e5f;">ğŸ“œ æ´»å‹•è¨˜éŒ²</h4>
            <div id="game-log"></div>
        </div>

        <div id="parliament-status-container" class="wiki-panel">
            <div class="panel-header">
                <span class="icon">ğŸ›ï¸</span> è­°ä¼šé¸æŒ™ç®¡ç†
            </div>
            <div class="panel-body">
                <div class="timer-section">
                    <span class="label">æ¬¡æœŸç·é¸æŒ™ã¾ã§:</span>
                    <span id="parliament-timer" class="days-count">730</span>
                    <span class="unit">æ—¥</span>
                </div>

                <div class="status-section">
                    <div id="parliament-status-text">æœªã‚¨ãƒ³ãƒˆãƒªãƒ¼</div>
                    <div id="parliament-action-area">
                    </div>
                </div>

                <div class="election-info">
                    <small>â€»å¤§çµ±é ˜é¸ã¨ã®é‡è¤‡ç«‹å€™è£œã¯ã§ãã¾ã›ã‚“</small>
                </div>
            </div>
        </div>
        <style>
            #parliament-election-panel {
                width: 250px;
                border: 1px solid #a2a9b1;
                background-color: #363636;
                font-family: sans-serif;
                margin-bottom: 15px;
            }

            .panel-header {
                background-color: #eaecf0;
                padding: 8px;
                font-weight: bold;
                border-bottom: 1px solid #a2a9b1;
                font-size: 0.9em;
            }

            .panel-body {
                padding: 12px;
            }

            .timer-section {
                text-align: center;
                margin-bottom: 10px;
            }

            .days-count {
                font-size: 1.4em;
                font-weight: bold;
                color: #202122;
            }

            .status-section {
                border-top: 1px solid #e2e2e2;
                padding-top: 10px;
                text-align: center;
            }

            #parliament-status-text {
                font-size: 0.85em;
                color: #54595d;
                margin-bottom: 8px;
            }

            /* ç«‹å€™è£œãƒœã‚¿ãƒ³ */
            .btn-parliament-run {
                background-color: #3366cc;
                color: white;
                border: 1px solid #3366cc;
                padding: 6px 12px;
                border-radius: 2px;
                cursor: pointer;
                font-size: 0.9em;
                width: 100%;
                transition: background 0.2s;
            }

            .btn-parliament-run:hover {
                background-color: #447ff5;
            }

            .btn-parliament-run:disabled {
                background-color: #c8ccd1;
                border-color: #c8ccd1;
                cursor: not-allowed;
            }

            /* ç«‹å€™è£œæ¸ˆã¿ãƒãƒƒã‚¸ */
            .badge-running {
                display: block;
                background-color: #d5fdf4;
                color: #14866d;
                border: 1px solid #14866d;
                padding: 5px;
                border-radius: 2px;
                font-weight: bold;
                font-size: 0.85em;
            }
        </style>

        <div class="cabinet-card" style="margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 style="color:#f1c40f; text-align:center;">ğŸ—³ï¸å¤§çµ±é ˜ã®çŠ¶æ³:</h2>
                <button onclick="showMilitaryModal();">è»ã®çŠ¶æ³</button>
                <button onclick="showCabinetAnnouncement();">å¤§çµ±é ˜ã®éƒ¨ä¸‹</button>
                <button onclick="showParliamentStatus();">è­°ä¼šã®çŠ¶æ³</button>
                <button onclick="showElectionHistory();">è­°ä¼šã®å±¥æ­´</button>
            </div>
        </div>

        <div id="voting-modal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2500; justify-content:center; align-items:center;">
            <div class="dashboard" style="width:90%; max-width:500px; text-align:center;">
                <h2 id="voting-title">æŠ•ç¥¨å…ˆã‚’é¸ã‚“ã§ãã ã•ã„</h2>
                <div id="candidate-options"
                    style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:20px 0;">
                </div>
            </div>
        </div>

        <div id="universal-modal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; justify-content:center; align-items:center; overflow-y: auto;">
            <div class="dashboard" style="width:90%; max-width:600px; position:relative; animation: modalFadeIn 0.3s;">
                <h2 id="modal-title"
                    style="color:#f1c40f; text-align:center; border-bottom: 2px solid #f1c40f; padding-bottom:10px;">
                    ã‚¿ã‚¤ãƒˆãƒ«</h2>

                <div id="modal-body" style="margin:20px 0; max-height: 70vh; overflow-y: auto;">
                </div>

                <div id="modal-footer" style="display:flex; gap:10px; justify-content:center;">
                </div>
            </div>
        </div>

        <style>
            @keyframes modalFadeIn {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        </style>

        <div id="election-result-modal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:2000; overflow-y: auto; padding: 20px; box-sizing: border-box;">
            <div id="election-content" style="max-width: 800px; margin: 0 auto; color: white;">
            </div>
            <button onclick="closeElectionModal()" id="election-close"
                style="display:block; margin: 20px auto; padding: 10px 40px; background: #e74c3c; border: none; color: white; border-radius: 5px; cursor: pointer;">é–‰ã˜ã‚‹</button>
        </div>
        <div class="header">
            <img id="display-icon" class="leader-icon" src="" alt="æŒ‡å°è€…ã‚¢ã‚¤ã‚³ãƒ³">
            <div>
                <h1 id="display-name" style="margin: 0;">æ°å</h1>
                <div id="ideology-label" class="ideology-tag">æ€æƒ³ï¼šè§£æä¸­...</div>
            </div>
        </div>

        <div class="status-grid">
            <div class="stat-card">
                <label>çµŒæ¸ˆè»¸</label>
                <div id="val-econ" class="stat-val">--</div>
                <small id="desc-econ"></small>
            </div>
            <div class="stat-card">
                <label>çµ±æ²»è»¸</label>
                <div id="val-gov" class="stat-val">--</div>
                <small id="desc-gov"></small>
            </div>
            <div class="stat-card">
                <label>å¤–äº¤è»¸</label>
                <div id="val-diplomatic" class="stat-val">--</div>
                <small id="desc-diplomatic"></small>
            </div>
        </div>
        <div class="dashboard" style="margin-top: 20px;">
            <h2>äººç‰©ãŸã¡</h2>

            <div style="margin-bottom: 15px;">
                <input type="text" id="npc-search" placeholder="åå‰ã‚„æ€æƒ³ã§æ¤œç´¢..."
                    style="width: 100%; padding: 10px; border-radius: 5px; border: none;">
            </div>
            <button onclick="addNewNPC()"
                style="width: 100%; background: #4ecca3; border: none; padding: 10px; border-radius: 5px; cursor: pointer; color: #1a1a2e; font-weight: bold; margin-bottom: 15px;">
                ï¼‹ æ–°ã—ã„äººç‰©ã‚’è¿½åŠ 
            </button>

            <div id="npc-list" style="
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 10px; 
    max-height: 400px; 
    overflow-y: auto; 
    padding-right: 5px;
"></div>
            <div id="npc-modal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center;">
                <div class="dashboard" style="width:90%; max-width:400px;">
                    <h3>äººç‰©ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</h3>
                    <label>åå‰</label>
                    <input type="text" id="edit-npc-name"
                        style="width:100%; padding:8px; box-sizing:border-box; margin-bottom:10px;">

                    <label>æ‰€å±æ”¿å…š</label>
                    <select id="edit-npc-party"
                        style="width:100%; padding:8px; box-sizing:border-box; margin-bottom:10px; background: white; border: 1px solid #ccc; border-radius: 4px;">
                    </select>

                    <label>ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š</label>
                    <div style="display: flex; gap: 5px; margin-bottom:10px;">
                        <input type="text" id="edit-npc-seed" placeholder="ã‚·ãƒ¼ãƒ‰å€¤" style="flex: 2; padding:8px;">
                        <label
                            style="flex: 1; background: #3498db; padding: 8px; border-radius: 4px; text-align: center; cursor: pointer; font-size: 0.8em; color: white;">
                            ç”»åƒé¸æŠ
                            <input type="file" id="npc-image-upload" accept="image/*" style="display: none;">
                        </label>
                    </div>

                    <div style="text-align:center; margin:10px;">
                        <img id="edit-npc-preview" src=""
                            style="width:80px; height:80px; border-radius:50%; background:#2c3e50; border: 2px solid #bdc3c7;">
                    </div>

                    <div style="display:flex; gap:10px;">
                        <button id="save-npc-btn"
                            style="flex:1; background:#4ecca3; border:none; padding:10px; border-radius:5px; cursor:pointer;">ä¿å­˜</button>
                        <button onclick="closeModal()"
                            style="flex:1; background:#e74c3c; border:none; padding:10px; border-radius:5px; cursor:pointer; color:white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </div>
            </div>

        </div>
</body>


<script>
    const gameSettings = {
        skipPresidentialElection: false, // å¤§çµ±é ˜é¸ã®å‡ºé¦¬ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—
        skipPartyElection: false,        // å…šä»£è¡¨é¸ã®å‡ºé¦¬ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—
        skipGeneralElection: false       // è­°ä¼šé¸æŒ™ã®å‡ºé¦¬ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—
    };

    function openSettingsModal() {
        const content = `
        <div style="text-align: left; padding: 10px; color: #333;">
            <h4 style="border-bottom: 2px solid #3498db; padding-bottom: 5px;">ğŸ”” é€šçŸ¥ãƒ»ã‚ªãƒ¼ãƒˆè¨­å®š</h4>
            
            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" id="set-skip-pres" ${gameSettings.skipPresidentialElection ? 'checked' : ''}> 
                    å¤§çµ±é ˜é¸æŒ™ã¸ã®å‡ºé¦¬é€šçŸ¥ã‚’ç„¡åŠ¹åŒ–
                </label>
                
                <label style="display: block; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" id="set-skip-party" ${gameSettings.skipPartyElection ? 'checked' : ''}> 
                    å…šä»£è¡¨é¸æŒ™ã¸ã®å‡ºé¦¬é€šçŸ¥ã‚’ç„¡åŠ¹åŒ–
                </label>
                
                <label style="display: block; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" id="set-skip-gen" ${gameSettings.skipGeneralElection ? 'checked' : ''}> 
                    è­°ä¼šé¸æŒ™ã®é€šçŸ¥ã‚’ç°¡ç•¥åŒ–
                </label>
            </div>
            <p style="font-size: 0.8em; color: #666;">â€»ç„¡åŠ¹ã«ã—ãŸå ´åˆã€è‡ªå‹•çš„ã«ã€Œç«‹å€™è£œã—ãªã„ã€ã¨ã—ã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚</p>
        </div>
    `;

        openUniversalModal("ã‚·ã‚¹ãƒ†ãƒ è¨­å®š", content, [
            {
                text: "è¨­å®šã‚’ä¿å­˜",
                cb: () => {
                    gameSettings.skipPresidentialElection = document.getElementById('set-skip-pres').checked;
                    gameSettings.skipPartyElection = document.getElementById('set-skip-party').checked;
                    gameSettings.skipGeneralElection = document.getElementById('set-skip-gen').checked;
                    closeUniversalModal();
                    showToast("è¨­å®šä¿å­˜", "é€šçŸ¥è¨­å®šãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚", "#2ecc71");
                },
                color: "#2ecc71"
            }
        ]);
    }
    const usStates = [
        "å¤§é˜ªåºœ", "äº¬éƒ½åºœ", "æ±äº¬éƒ½"
    ];

    function generateStatePolitics() {
        const stateData = {};
        const activeParties = parties.filter(p => p.active);

        usStates.forEach(state => {
            // ãã®å·ã§æœ€ã‚‚å¼·ã„å…šã‚’æ±ºå®šï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‹å…šã®å‹¢åŠ›ï¼‰
            const dominantParty = activeParties[Math.floor(Math.random() * activeParties.length)];
            // å¤§çµ±é ˜ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¾ãŸã¯NPCï¼‰ã®æ”¯æŒç‡ã‚’ç®—å‡º
            const presApproval = Math.floor(Math.random() * 40) + 30; // 30-70%ã®é–“ã§å¤‰å‹•

            stateData[state] = {
                party: dominantParty,
                approval: presApproval
            };
        });
        return stateData;
    }
    async function showNationalPoliticalMap() {
        const activeParties = parties.filter(p => p.active);

        // 1. æ”¿å…šãŒä¸€ã¤ã‚‚ãªã„å ´åˆã®å®‰å…¨è£…ç½®
        if (activeParties.length === 0) {
            return showToast("ã‚¨ãƒ©ãƒ¼", "æ´»å‹•ä¸­ã®æ”¿å…šãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚");
        }

        const stateData = generateStatePolitics();
        const avgApproval = Object.values(stateData).reduce((a, b) => a + b.approval, 0) / 50;

        // SVGåœ°å›³ã®ç°¡æ˜“çš„ãªã‚°ãƒªãƒƒãƒ‰é…ç½®ï¼ˆ50å·ã‚’ä¸¦ã¹ã‚‹ï¼‰
        // æœ¬æ¥ã¯æ­£ç¢ºãªåœ°å›³åº§æ¨™ãŒç†æƒ³ã§ã™ãŒã€è»½é‡åŒ–ã®ãŸã‚ãƒªã‚¹ãƒˆ/ã‚°ãƒªãƒƒãƒ‰å½¢å¼ã€
        // ã‚‚ã—ãã¯å¤–éƒ¨ã®è»½é‡ãªSVGåœ°å›³ãƒ‘ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

        let mapHTML = `
        <div style="text-align:center; background:#f8f9fa; padding:15px; border-radius:10px;">
            <h3 style="margin-bottom:5px;">æƒ…å‹¢ãƒãƒƒãƒ—</h3>
            <div style="font-size:1.2em; font-weight:bold; color:#2c3e50;">
                å¤§çµ±é ˜å…¨å›½æ”¯æŒç‡: <span style="color:${avgApproval > 50 ? '#27ae60' : '#e74c3c'}">${avgApproval.toFixed(1)}%</span>
            </div>
            <hr>
            <div style="display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; margin-top:15px;">
    `;

        usStates.forEach(state => {
            const data = stateData[state];
            mapHTML += `
            <div title="${state}: ${data.party.name}æ”¯æŒ / æ”¯æŒç‡ ${data.approval}%"
                 style="aspect-ratio:1; display:flex; align-items:center; justify-content:center; 
                        background:${data.party.color}; color:white; font-size:10px; font-weight:bold; 
                        border-radius:3px; cursor:help; border:1px solid rgba(0,0,0,0.1);">
                ${state}
            </div>
        `;
        });

        mapHTML += `
            </div>
            <div style="margin-top:15px; font-size:0.7em; text-align:left; background:white; padding:10px; border:1px solid #ddd;">
                <strong>å‡¡ä¾‹:</strong><br>
                ${parties.filter(p => p.active).map(p => `<span style="display:inline-block; width:10px; height:10px; background:${p.color};"></span> ${p.name}`).join(' ')}
            </div>
        </div>
    `;

        openUniversalModal("æƒ…å‹¢èª¿æŸ»", mapHTML, [{ text: "é–‰ã˜ã‚‹", cb: () => closeUniversalModal() }]);
    }
    function addMapButton() {
        const container = document.getElementById('side-panel'); // ã¾ãŸã¯é©åˆ‡ãªã‚³ãƒ³ãƒ†ãƒŠ
        const btn = document.createElement('button');
        btn.innerHTML = "ğŸ—ºï¸ åœ°å›³ã‚’è¡¨ç¤º (å…¨ç±³æƒ…å‹¢)";
        btn.style.cssText = "width:100%; padding:10px; background:#2c3e50; color:white; border:none; border-radius:5px; margin-top:10px; cursor:pointer;";
        btn.onclick = showNationalPoliticalMap;
        container.appendChild(btn);
    }
    let parhistory = [];
    let prpl = [];
    let isPlayerRunningForPresident = false
    let parliamentElectionCounter = 2; // 2å¹´ï¼ˆ730æ—¥ï¼‰ã«1å›ã¨ã™ã‚‹
    let isPlayerRunningForParliament = false; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè­°ä¼šé¸ã«ç«‹å€™è£œã—ã¦ã„ã‚‹ã‹
    let president = null;

    let currentCabinet = {
        vicePresident: null,    // å‰¯å¤§çµ±é ˜
        stateSecretary: null,   // å›½å‹™é•·å®˜
        justiceSecretary: null, // å¸æ³•é•·å®˜
        defenseSecretary: null, // å›½é˜²é•·å®˜
        commerceSecretary: null,// å•†å‹™é•·å®˜
        homelandSecretary: null // å›½åœŸé–‹ç™ºé•·å®˜
    };

    // å½¹è·åã¨èª¬æ˜ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const CABINET_ROLES = {
        vicePresident: "å‰¯å¤§çµ±é ˜",
        stateSecretary: "å›½å‹™é•·å®˜",
        justiceSecretary: "å¸æ³•é•·å®˜",
        defenseSecretary: "å›½é˜²é•·å®˜",
        commerceSecretary: "å•†å‹™é•·å®˜",
        homelandSecretary: "å›½åœŸé–‹ç™ºé•·å®˜"
    };
    let presidentElect = null; // æ¬¡æœŸå½“é¸è€…
    let presidenttermcount = null;
    let gameDate = new Date(2026, 0, 1); // é–‹å§‹æ—¥

    const lastNames = ["ä½è—¤", "éˆ´æœ¨", "é«˜æ©‹", "ç”°ä¸­", "ä¼Šè—¤", "æ¸¡è¾º", "å±±æœ¬", "ä¸­æ‘", "å°æ—", "åŠ è—¤", "å‰ç”°", "å±±ç”°", "ä½ã€…æœ¨", "å±±å£", "æ¾æœ¬",
        "ã‚¸ãƒ§ãƒ³", "ã‚¢ãƒ«", "ãƒãƒ¼ãƒãƒ¼ãƒ‰", "ãƒãƒ¼ãƒãƒ¼ãƒˆ", "ãƒ‰ãƒŠãƒ«ãƒ‰", "ã‚¸ãƒ§ãƒ¼", "ã‚¸ãƒ§ã‚»ãƒ•", "ã‚¸ãƒ§ãƒ¼ã‚¸", "ã‚²ã‚ªãƒ«ã‚¯", "ã‚¢ãƒ‰ãƒ«ãƒ•", "ã‚¢ãƒ­ã‚¤ã‚¹", "ãƒãƒ¼ãƒ†ã‚£ãƒ³", "ã‚¦ã‚£ãƒªã‚¢ãƒ ", "ãƒ•ãƒ©ãƒ³ã‚¯",
        "ãƒ•ãƒ©ãƒ³ã‚¯ãƒªãƒ³", "ã‚«ãƒ«ãƒ´ã‚£ãƒ³", "ã‚«ãƒ«ãƒ“ãƒ³", "ãƒ¦ã‚¹ãƒ•", "ãƒ¨ã‚»ãƒ•", "ãƒ¨ã‚»ãƒ¼ãƒ—", "ãƒ¬ã‚·ãƒ—", "ãƒ¬ã‚·ãƒƒãƒ—", "ã‚¸ã‚§ãƒ¼ãƒ ã‚º", "ã‚¸ã‚§ãƒ¼ãƒ ã‚¹", "ã‚¸ã‚§ã‚¤ãƒ ã‚º", "ã‚¢ãƒ¼ã‚µãƒ¼",
        "ãƒãƒ£ãƒ¼ãƒ«ã‚º", "ã‚¦ã‚£ãƒ³ã‚¹ãƒˆãƒ³", "ã‚¦ã‚£ãƒ³ãƒˆãƒ³", "ãƒŸãƒ©ãƒ¼ãƒ‰", "ã‚¶ã‚«ãƒªãƒ¼", "ã‚¢ãƒ³ãƒ‰ãƒªãƒ¥ãƒ¼", "ã‚¢ãƒ³ãƒ‰ãƒ«ãƒ¼", "æ", "ã‚­ã‚¢", "ãƒªã‚·", "ãƒœãƒªã‚¹", "ãƒœãƒ–", "ãƒ“ãƒ«", "ã‚°ãƒ­ãƒãƒ¼", "ã‚°ãƒ­ãƒ´ã‚¡ãƒ¼"
        , "ãƒãƒªãƒ¼", "ã‚¸ãƒ§ãƒ³ã‚½ãƒ³", "ã‚¸ãƒ§ãƒ¼ãƒ³", "ã‚·ãƒ§ãƒ¼ãƒ³", "ã‚·ãƒ§ãƒ³", "ãƒ•ãƒ©ãƒ³ã‚­ãƒ³", "ã‚¢ãƒ«ãƒ•ãƒ¬ãƒƒãƒ‰", "çŸ³äº•", "çŸ³ç”°", "çŸ³å·", "ãƒ˜ãƒ³ãƒªãƒ¼", "ãƒ’ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆ", "ãƒ‹ã‚³ãƒ©ã‚¹",
        "ã‚¸ãƒ§ãƒ©ã‚¤", "ã‚·ãƒ§ãƒ©ã‚¤", "ãƒ›ãƒ¬ã‚¤ã‚·ãƒ§", "ãƒ›ãƒ¼ãƒ¬ã‚¤", "ãƒ›ãƒ¬ã‚¤", "å²©äº•", "å²©å´", "å²©ç”°", "æ–è—¤", "é½‹è—¤", "æ¸•ä¸Š", "æ·µä¸Š", "ç”°å±±"
    ];
    const firstNames = ["å¤ªéƒ", "æ¬¡éƒ", "å¥ä¸€", "æ˜­å¤«", "å’Œä¹Ÿ", "æµ©å¸", "æ‚Ÿ", "ç›´æ¨¹", "ä¸€éƒ", "é€²", "é“å¤«", "æ­£", "ç§€æ¨¹", "è‹±äºŒ", "é›„å¤ª",
        "ã‚¢ãƒ€ãƒ ", "ã‚¢ãƒ€ãƒ ã‚º", "ã‚¢ãƒ€ãƒ ã‚¹", "ã‚¸ã‚§ãƒ•ã‚¡ãƒ¼ã‚½ãƒ³", "ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼", "ãƒ‘ãƒ¯ãƒ¼ãƒ‰", "ãƒ‘ãƒ¼ãƒˆ", "ã‚¹ãƒŸã‚¹", "ãƒ¯ã‚¤ãƒ«ãƒ‰", "ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰", "ãƒ‰ã‚¥ãƒ¼ã‚¤", "ãƒ‰ãƒ¼ã‚¤", "ã‚¹ã‚³ãƒƒãƒˆ", "ã„ã£ãºã„", "ã‚¹ã‚«ãƒƒãƒˆ",
        "ãƒœã‚½ãƒ³", "ãƒã‚ºãƒ³", "æ˜å¤«", "ã‚ããŠ", "ã‚¯ãƒ¼ãƒªãƒƒã‚¸", "ã‚¯ãƒ¼ãƒªãƒ¼", "æ —å³¶", "ã‚·ã‚²ãƒ«", "èŒ‚", "ã—ã’ãŠ", "ã—ã’ãŸ", "ã‚¸ãƒ£ã‚¯ã‚½ãƒ³", "ã‚¸ãƒ£ãƒƒã‚¯ã‚½ãƒ³",
        "ã‚¢ãƒ‡ãƒ ", "ã‚¸ãƒ§ãƒ¼ã‚¤", "ãƒ˜ãƒ³ãƒ•ãƒªãƒ¼", "ãƒ˜ãƒ•ãƒªãƒ¼", "ãƒã‚¯ã‚«ãƒãƒ³", "ãƒã‚¯ã‚¬ãƒãƒ³", "ãƒã‚¯ãƒãƒ³", "ãƒãƒƒã‚¯", "ãƒ€ãƒŠã‚¹", "ã‚¬ãƒŠã‚¹", "ãƒãƒŠã‚¹", "ãƒ©ãƒŠã‚¹",
        "ãƒ©ãƒšã‚¹", "ã‚¸ãƒ§ãƒ³ã‚½ãƒ³", "ã‚¸ãƒ§ãƒ³", "ãƒãƒ¼ãƒŠãƒ¼", "ãƒãƒ¼ãƒŠãƒ¼ãƒ‰", "ãƒãƒ¼ãƒŠãƒ¼ã‚º"
    ];
    const specialMiddles = ["ãƒ»Dãƒ»", "ãƒ»ãƒ•ã‚©ãƒ³ãƒ»", "ãƒ»ãƒ‡ãƒ»", "ãƒ»ãƒ´ã‚¡ãƒ³ãƒ»"];

    // A(65)ã‹ã‚‰Z(90)ã¾ã§ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦è‡ªå‹•ç”Ÿæˆ
    const alphabetMiddles = Array.from({ length: 26 }, (_, i) => `ãƒ»${String.fromCharCode(65 + i)}ãƒ»`);

    // äºŒã¤ã‚’åˆä½“ã•ã›ã¦æœ€å¼·ã®ãƒŸãƒ‰ãƒ«ãƒãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’ä½œã‚‹
    const middleNames = [...specialMiddles, ...alphabetMiddles];
    let electionCountdown = 1;
    let profile = null;
    window.onload = function () {
        // 1. LocalStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const savedData = localStorage.getItem('political_game_data');

        if (!savedData) {
            alert("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
            location.href = 'index.html'; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯æˆ»ã™
            return;
        }

        profile = JSON.parse(savedData);
        profile.id = "player";
        profile.title = "";

        npcs = []; // é…åˆ—ã‚’åˆæœŸåŒ–

        gameDate = profile.startYear || 2024;
        gameDate = new Date(gameDate, 0, 1); // æœˆã¯0ã‹ã‚‰å§‹ã¾ã‚‹ã®ã§0=1æœˆ

        prpl.push({
            id: "player",
            name: profile.name,
            icon: profile.icon,
            isPlayer: true,
            termCount: 0,
            military: null,
            ideology: {
                economy: parseInt(profile.ideology.economy),
                government: parseInt(profile.ideology.government),
                diplomacy: parseInt(profile.ideology.diplomacy)
            },
        });

        // 1. ã¾ãšã‚«ã‚¹ã‚¿ãƒ NPCã‚’ãƒªã‚¹ãƒˆã«å…¥ã‚Œã‚‹
        if (profile.customNPCs && profile.customNPCs.length > 0) {
            profile.customNPCs.forEach(c => {
                npcs.push({
                    id: "custom-" + Math.random().toString(36).substr(2, 9),
                    name: c.name,
                    icon: c.icon,
                    isPlayer: false,
                    termCount: 0,
                    military: null,
                    ideology: {
                        economy: parseInt(c.ideology.economy),
                        government: parseInt(c.ideology.government),
                        diplomacy: parseInt(c.ideology.diplomacy)
                    },
                    isCustom: true // ã‚«ã‚¹ã‚¿ãƒ NPCãƒ•ãƒ©ã‚°
                });
            });
        }

        // 2. HTMLè¦ç´ ã«åæ˜ 
        document.getElementById('display-name').innerText = profile.name;
        document.getElementById('display-icon').src = profile.icon;

        // æ€æƒ³æ•°å€¤ã®åæ˜ 
        const econ = profile.ideology.economy;
        const gov = profile.ideology.government;
        const diplo = profile.ideology.diplomacy;

        document.getElementById('val-econ').innerText = econ;
        document.getElementById('val-gov').innerText = gov;
        document.getElementById('val-diplomatic').innerText = diplo;

        // 3. æ•°å€¤ã«åŸºã¥ã„ãŸç°¡æ˜“èª¬æ˜ã®è¡¨ç¤º
        document.getElementById('desc-econ').innerText = econ > 60 ? "å¸‚å ´çµŒæ¸ˆé‡è¦–" : (econ < 40 ? "è¨ˆç”»çµŒæ¸ˆé‡è¦–" : "æ··åˆçµŒæ¸ˆ");
        document.getElementById('desc-gov').innerText = gov > 60 ? "ç§©åºã¨æ¨©å¨" : (gov < 40 ? "å€‹äººã®è‡ªç”±" : "ä¸­åº¸ãªçµ±æ²»");
        document.getElementById('desc-diplomatic').innerText = gov > 60 ? "å›½å®¶ã«é›†ä¸­" : (gov < 40 ? "è‡ªç”±å¤–äº¤" : "æ™®é€šå¤–äº¤");

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã§è¨­å®šã—ãŸäººæ•°åˆ†ã ã‘ä½œæˆ
        const count = profile.initialNpcCount || 5;
        for (let i = 0; i < count; i++) {
            const uniqueName = generateComplexName(); // é€²åŒ–ã—ãŸåå‰ã‚’ç”Ÿæˆ
            npcs.push(createRandomNPC(uniqueName));
        }
        // åˆå›ç”Ÿæˆåˆ†ã‚’ä¿å­˜

        // 4. ç§°å·ã®åˆ¤å®šï¼ˆãŠã¾ã‘ï¼‰
        let title = "ä¸­é“";
        if (gov > 70 && econ > 70) title = "é‡‘ã˜ã‚ƒã‚“ã˜ã‚ƒã‚“ä¸»ç¾©";
        if (gov < 30 && econ < 30) title = "å¹³ç­‰ä¸»ç¾©ã®éæ¿€æ´¾";
        if (gov > 70 && econ < 30) title = "ç‹¬è£è€…";
        if (gov < 30 && econ > 70) title = "è‡ªç”±ä¸»ç¾©è€…";


        document.getElementById('ideology-label').innerText = "ç·åˆçš„ãªæ€æƒ³: " + title;

        document.getElementById('edit-npc-seed').addEventListener('input', (e) => {
            const seed = e.target.value || "default";
            document.getElementById('edit-npc-preview').src = `https://api.dicebear.com/9.x/personas/svg?seed=${seed}`;
        });
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        document.getElementById('npc-image-upload').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('edit-npc-preview').src = event.target.result;
                    document.getElementById('edit-npc-seed').value = ""; // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã¯ã‚·ãƒ¼ãƒ‰ã‚’ç©ºã«
                };
                reader.readAsDataURL(file);
            }
        });
        initializeTwoPartySystem();
        renderNPCs("", profile.ideology);
    };

    let annualPoliticsLog = {
        invited: [],
        expelled: []
    };

    function resetAnnualLog() {
        annualPoliticsLog = {
            invited: [],
            expelled: []
        };
    }

    /* è­°ä¼šã®ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ */
    function showParliamentStatus() {
        // 1. ä¸‹æº–å‚™ï¼šã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå…¨æ”¿å…šã‚’ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹ï¼ˆè­°å¸­0ã§ã‚‚è¡¨ç¤ºã™ã‚‹ãŸã‚ï¼‰
        const activeParties = parties.filter(p => p.active);
        const currentMPs = npcs.filter(n => n.title === "è­°å“¡");

        // 2. ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆ
        let resultsData = activeParties.map(party => {
            // ã“ã®å…šã«æ‰€å±ã™ã‚‹ç¾è·è­°å“¡ã‚’æŠ½å‡º
            const members = currentMPs.filter(m => m.partyId === party.id);

            // ã“ã®å…šã®å€™è£œè€…å…¨å“¡ã®ã€Œç›´è¿‘ã®å¾—ç¥¨æ•°ã€ã‚’åˆè¨ˆï¼ˆcandidatesé…åˆ—ã‹ã‚‰å–å¾—ã™ã‚‹ã®ãŒç¢ºå®Ÿï¼‰
            // candidatesãŒãªã„å ´åˆã¯è­°å“¡ã®votesã‚’ä½¿ã†
            const totalVotes = (typeof candidates !== 'undefined' && candidates.length > 0)
                ? candidates
                    .filter(c => c.partyId === party.id)
                    .reduce((sum, c) => sum + (c.votes || 0), 0)
                : members.reduce((sum, m) => sum + (m.votes || 0), 0);

            // å¢—æ¸›ã®è¨ˆç®—ï¼ˆå‰å›ã®è­°å¸­æ•° stats.partyBases[party.name] ç­‰ã¨æ¯”è¼ƒï¼‰
            const lastSeats = lastParliamentSeats[party.name] || 0;
            const currentSeats = members.length;
            const change = currentSeats - lastSeats;

            // å…šé¦–æƒ…å ±
            const leader = party.leader || { name: "ï¼ˆç©ºå¸­ï¼‰", icon: "https://placehold.co/200x250?text=No+Image" };

            return {
                id: party.id,
                name: party.name,
                color: party.color,
                seats: currentSeats,
                change: change,
                votes: totalVotes,
                voteRate: 0, // å¾Œã§ä¸€æ‹¬è¨ˆç®—
                leaderName: leader.name,
                leaderImage: leader.icon
            };
        });

        // ç„¡æ‰€å±æ ã®è¿½åŠ ï¼ˆè­°å¸­ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
        const indies = currentMPs.filter(m => !m.partyId);
        if (indies.length > 0) {
            resultsData.push({
                name: "ç„¡æ‰€å±",
                color: "#95a5a6",
                seats: indies.length,
                change: indies.length - (lastParliamentSeats["ç„¡æ‰€å±"] || 0),
                votes: indies.reduce((sum, m) => sum + (m.votes || 0), 0),
                voteRate: 0,
                leaderName: "ãƒ¼",
                leaderImage: "https://placehold.co/200x250?text=Independents"
            });
        }

        // 3. å¾—ç¥¨ç‡ã®è¨ˆç®—ï¼ˆåˆ†æ¯ãŒ0ã«ãªã‚‰ãªã„ã‚ˆã†æ³¨æ„ï¼‰
        const grandTotalVotes = resultsData.reduce((sum, p) => sum + p.votes, 0) || 1;
        resultsData.forEach(p => {
            p.voteRate = ((p.votes / grandTotalVotes) * 100).toFixed(1);
        });

        // 4. ã‚½ãƒ¼ãƒˆï¼ˆè­°å¸­æ•° > å¾—ç¥¨æ•°ï¼‰
        resultsData.sort((a, b) => b.seats - a.seats || b.votes - a.votes);

        // 5. è¡¨ç¤ºç”Ÿæˆ
        const tableHtml = generateWikiStyleTable(resultsData, parliamentSize);

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç«‹å ´
        const myParty = parties.find(p => p.id === profile.partyId) || { name: "ç„¡æ‰€å±" };
        // ç¬¬1å…šãŒä¸å…šï¼ˆé€£ç«‹ã®æ¦‚å¿µãŒãªã„å ´åˆï¼‰
        const rulingPartyName = resultsData[0]?.name || "";
        const isRuling = myParty.name === rulingPartyName;

        const footerHtml = `
        <div style="margin-top:15px; padding:12px; background:#f8f9fa; border:1px solid #ddd; border-radius:6px; text-align:center;">
             <span style="color:#666;">ç¾åœ¨ã®æ‰€å±:</span> 
             <strong style="font-size:1.1em; color:${myParty.color || '#333'};">${myParty.name}</strong>
             <span style="margin-left:10px; padding:3px 10px; border-radius:20px; color:white; font-size:0.8em; font-weight:bold; background:${isRuling ? '#e74c3c' : '#3498db'};">
                ${isRuling ? 'ä¸å…š' : 'é‡å…š'}
             </span>
        </div>
    `;

        openUniversalModal("ğŸ›ï¸ è­°ä¼šå‹¢åŠ›å›³", tableHtml + footerHtml, [{ text: "é–‰ã˜ã‚‹", cb: closeUniversalModal }]);
    }

    function showElectionHistory() {
        if (!parhistory || parhistory.length === 0) {
            alert("é¸æŒ™ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }

        let htmlContent = `<div style="max-height:500px; overflow-y:auto; padding:10px;">`;

        [...parhistory].reverse().forEach((record, idx) => {
            const electionNum = parhistory.length - idx;

            // stats.partyDetails ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã„å ´åˆã¯æ—§ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®äº’æ›å‡¦ç†
            const details = record.partyDetails || {};

            let histResults = Object.entries(record.partyBases).map(([pName, seatCount]) => {
                const partyInfo = parties.find(p => p.name === pName) || { color: "#999" };
                const detail = details[pName] || {}; // ä¿å­˜ã•ã‚ŒãŸè©³ç´°æƒ…å ±

                return {
                    name: pName,
                    color: partyInfo.color,
                    seats: seatCount,
                    // ä¿å­˜ã•ã‚ŒãŸå¢—æ¸›ãƒ»å¾—ç¥¨æ•°ãƒ»å…šé¦–ã‚’ä½¿ç”¨ã™ã‚‹
                    change: detail.change || 0,
                    votes: detail.votes || 0,
                    voteRate: record.mvpVotes > 0 ? ((detail.votes / record.mvpVotes) * 10).toFixed(1) : "--", // æ¦‚ç®—
                    leaderName: detail.leaderName || "ä¸æ˜",
                    leaderImage: detail.leaderIcon || "https://placehold.co/100x100?text=No+Image"
                };
            });

            histResults.sort((a, b) => b.seats - a.seats);

            htmlContent += `
            <div style="margin-bottom:30px; border:1px solid #ddd; border-radius:8px; background:#fff; overflow:hidden;">
                <div style="background:#2c3e50; color:#fff; padding:10px; font-weight:bold;">
                    ç¬¬${electionNum}å› ç·é¸æŒ™ (${new Date(record.date).toLocaleDateString()})
                </div>
                <div style="padding:10px;">
                    ${generateWikiStyleTable(histResults)}
                </div>
            </div>
        `;
        });

        htmlContent += `</div>`;
        openUniversalModal("ğŸ“œ æ­´ä»£é¸æŒ™ã®çµæœ", htmlContent, [{ text: "é–‰ã˜ã‚‹", cb: closeUniversalModal }]);
    }
    /**
 * æ”¿å…šã®æ—¥å¸¸çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ‹›å¾…ãƒ»é™¤åãƒ»çµ±åˆï¼‰ã‚’å‡¦ç†ã™ã‚‹
 */
    function processDailyPartyAction() {
        if (Math.random() > 0.03) return;

        const activeParties = parties.filter(p => p.active);
        if (activeParties.length === 0) return;

        const party = activeParties[Math.floor(Math.random() * activeParties.length)];
        const rand = Math.random();
        checkPartyDissolution(party);

        if (rand < 0.60) {
            // --- ğŸš€ ã€æ–°è¦ã€‘è»ãƒ»è­¦å¯Ÿä»¥å¤–ã‹ã¤ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä»¥å¤–ã®ç„¡æ‰€å±å€™è£œã‚’æŠ½å‡º ---
            const unaffiliatedCivilians = npcs.filter(npc => {
                if (npc.isPlayer || npc.partyId) return false;
                const isMilitary = npc.job && (npc.job.includes("è»") || npc.job.includes("å…µ") || npc.job.includes("è­¦"));
                return !isMilitary;
            });

            let target = null;

            // ç„¡æ‰€å±ã®æ°‘é–“äººãŒã„ã‚Œã°å„ªå…ˆçš„ã«ã‚¹ã‚«ã‚¦ãƒˆã€ã„ãªã‘ã‚Œã°ä»–å…šã‹ã‚‰å¼•ãæŠœã
            if (unaffiliatedCivilians.length > 0) {
                target = unaffiliatedCivilians[Math.floor(Math.random() * unaffiliatedCivilians.length)];
            } else {
                // ä»–å…šã®ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆä»£è¡¨ä»¥å¤–ï¼‰ã‚’å¼•ãæŠœã
                const otherPartyMembers = npcs.filter(npc =>
                    !npc.isPlayer &&
                    npc.partyId &&
                    npc.partyId !== party.id &&
                    !parties.some(p => p.leader.id === npc.id)
                );
                if (otherPartyMembers.length > 0) {
                    target = otherPartyMembers[Math.floor(Math.random() * otherPartyMembers.length)];
                }
            }

            if (target) {
                // ç§»ç±å‡¦ç†ï¼šå‰ã®å…šã‹ã‚‰è„±é€€
                if (target.partyId) {
                    const oldParty = parties.find(p => p.id === target.partyId);
                    if (oldParty) oldParty.members = oldParty.members.filter(m => m.id !== target.id);
                }

                target.partyId = party.id;
                if (!party.members.some(m => m.id === target.id)) {
                    party.members.push(target);
                }

                const isNewMember = !target.partyId; // å…ƒã€…ç„¡æ‰€å±ã ã£ãŸã‹
                showToast(
                    isNewMember ? `ğŸ“¢ æ–°è¦å…¥å…š: ${party.name}` : `ğŸ¤ æ”¿å…šç§»ç±: ${party.name}`,
                    `${target.name} æ°ãŒå…šã«åŠ ã‚ã‚Šã¾ã—ãŸã€‚`,
                    party.color
                );
                annualPoliticsLog.invited.push({ partyName: party.name, personName: target.name });
            }
        } else if (rand < 0.85) { // é™¤å (30%)
            // ä¿®æ­£ï¼šãƒ¡ãƒ³ãƒãƒ¼ãŒ3äººä»¥ä¸Šã€ã‹ã¤ã€Œä»£è¡¨ï¼ˆparty.leaderï¼‰ä»¥å¤–ã€ã‹ã‚‰é¸ã¶
            const candidatesForExpulsion = party.members.filter(m => m.id !== party.leader.id);

            if (candidatesForExpulsion.length > 0) {
                const target = candidatesForExpulsion[Math.floor(Math.random() * candidatesForExpulsion.length)];

                // å…šã®ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                party.members = party.members.filter(m => m.id !== target.id);
                if (!target.isPlayer) target.partyId = null;

                showToast(`ğŸš« æ”¿å…šé™¤å: ${party.name}`, `${target.name} æ°ãŒå…šã‹ã‚‰è¿½æ”¾ã•ã‚Œã¾ã—ãŸã€‚`, "#e74c3c");
                annualPoliticsLog.expelled.push({ partyName: party.name, personName: target.name });
            }

        } else if (rand < 0.90) { // çµ±åˆ (10%)
            const otherParty = activeParties.find(p => p.id !== party.id);

            if (otherParty) {
                // --- ğŸš€ ã€æ–°è¦ã€‘äºŒå¤§æ”¿å…šï¼ˆå…±å’Œå…šãƒ»æ°‘ä¸»å…šï¼‰ã¯çµ¶å¯¾ã«çµ±åˆã—ãªã„ã‚¬ãƒ¼ãƒ‰ ---
                const majorPartyNames = ["å…±å’Œå…š", "æ°‘ä¸»å…š"];
                const isMajorPartyInvolved = majorPartyNames.includes(party.name) || majorPartyNames.includes(otherParty.name);

                if (isMajorPartyInvolved) {
                    // äºŒå¤§æ”¿å…šãŒçµ¡ã‚€å ´åˆã¯çµ±åˆã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆä½•ã‚‚ã—ãªã„ï¼‰
                    return;
                }

                const aff = calculateAffinity(party.leader.ideology, otherParty.leader.ideology);
                const mergeChance = 0.1 + (aff / 500);

                if (Math.random() < mergeChance) {
                    const oldName = otherParty.name;
                    otherParty.members.forEach(m => {
                        if (!party.members.some(pm => pm.id === m.id)) {
                            party.members.push(m);
                            if (!m.isPlayer) m.partyId = party.id;
                        }
                    });
                    otherParty.active = false;
                    otherParty.disbandedDate = new Date(gameDate);
                    otherParty.members = [];
                    showToast(`ğŸ† æ”¿å…šçµ±åˆï¼`, `${oldName} ãŒ ${party.name} ã¸åˆæµã—ã¾ã—ãŸã€‚`, "#f1c40f");
                }
            }
        } else {
            processDailyPartyAction();
        }
    }

    function checkPartyDissolution(party) {
        if (!party.active) return;

        const memberCount = party.members.length;
        let dissolveChance = 0;

        // äººæ•°ã«å¿œã˜ãŸè§£æ•£ç¢ºç‡ã®è¨­å®š
        if (memberCount <= 0) dissolveChance = 1.0; // 0äººã¯æ¶ˆæ»…
        else if (memberCount === 1) dissolveChance = 0.20; // 1äººã‚‚å®Ÿè³ªè§£æ•£ï¼ˆ1000%ï¼‰
        else if (memberCount === 2) dissolveChance = 0.15; // 2äººã¯50%
        else if (memberCount === 3) dissolveChance = 0.10; // 3äººã¯30%
        else if (memberCount < 5) dissolveChance = 0.05; // 5äººæœªæº€ã¯10%
        else dissolveChance = 0.01; // ãã‚Œä»¥ä¸Šã¯å®‰å®šï¼ˆ2%ï¼‰

        if (Math.random() < dissolveChance) {
            // --- è§£æ•£å‡¦ç† ---
            const leaderName = party.leader ? party.leader.name : "å‰ä»£è¡¨";
            // ä»£è¡¨ä»¥å¤–ã®ãƒ©ãƒ³ãƒ€ãƒ ãªå…šå“¡ã‚’ä¸€äººé¸å‡ºï¼ˆã„ãªã‘ã‚Œã°ãƒªãƒ¼ãƒ€ãƒ¼ã®åå‰ã‚’æµç”¨ï¼‰
            const randomMember = party.members.length > 1
                ? party.members.filter(m => m.id !== party.leader.id)[Math.floor(Math.random() * (party.members.length - 1))].name
                : leaderName;
            const oldName = party.name;
            party.active = false;
            party.disbandedDate = new Date(gameDate);
            party.members.forEach(m => { if (!m.isPlayer) m.partyId = null; });
            const reasons = [
                `æ‰€å±è­°å“¡ã®æ¿€æ¸›ã«ã‚ˆã‚Šã€å…šã®é‹å–¶ãŒä¸å¯èƒ½ã¨ãªã‚Šã¾ã—ãŸã€‚`,
                `å…šé¦–ã®${leaderName}æ°ã¨${randomMember}æ°ã«ã‚ˆã‚‹æ¿€ã—ã„å†…éƒ¨å¯¾ç«‹ã®æœ«ã€å…šã¯åˆ†è£‚ã—ã¾ã—ãŸã€‚`,
                `${leaderName}ä»£è¡¨ãŒä¸ç¥¥äº‹ã®è²¬ä»»ã§ã€è§£æ•£ãŒæ±ºå®šã—ã¾ã—ãŸã€‚`,
                `å…šå†…ã®ä¸ç¥¥äº‹ã‚’å—ã‘ã€æ”¯æŒåŸºç›¤ãŒå®Œå…¨ã«å´©å£Šã—ã¾ã—ãŸã€‚`,
                `${randomMember}æ°ã‚‰ä¸»åŠ›ãƒ¡ãƒ³ãƒãƒ¼ã®ç›¸æ¬¡ãé›¢å…šã«ã‚ˆã‚Šã€æ”¿å…šè¦ä»¶ã‚’å¤±ã„ã¾ã—ãŸã€‚`,
                `å…šã®åŸºæœ¬ç†å¿µã‚’å·¡ã‚Š${leaderName}æ°ã®è§£ä»»æ¡ˆãŒå¯æ±ºã•ã‚Œã¾ã—ãŸã€‚`
            ];

            let j = reasons[Math.floor(Math.random() * reasons.length)];
            setGameSpeed(0);
            openUniversalModal("ğŸ›ï¸ æ”¿å…šè§£æ•£", `
            <div style="text-align:center;">
                <h2 style="color:#e74c3c;">${oldName} äº‹å®Ÿä¸Šã®è§£æ•£</h2>
                <p>${j}</p>
                <p style="font-size:0.8em;">æ®‹ã£ã¦ã„ãŸ ${memberCount} åã®è­°å“¡ã¯ç„¡æ‰€å±ã¨ãªã‚Šã¾ã™ã€‚</p>
            </div>
        `, [{ text: "ç¢ºèª", cb: () => { closeUniversalModal(); setGameSpeed(1); }, color: "#34495e" }]);
        } else {
            // --- ä»£è¡¨ãŒã„ãªã„å ´åˆã®ç¶™æ‰¿å‡¦ç† ---
            // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã«ç¾åœ¨ã®ãƒªãƒ¼ãƒ€ãƒ¼ãŒã„ãªã„å ´åˆï¼ˆä»–å…šã¸ç§»ç±ã€æ­»äº¡ã€é™¤åãªã©ï¼‰
            const leaderStillExists = party.members.some(m => m.id === party.leader.id);

            if (!leaderStillExists && memberCount > 0) {
                // ãƒŠãƒ³ãƒãƒ¼2ï¼ˆé…åˆ—ã®æœ€åˆã®äººï¼‰ã‚’æ–°ä»£è¡¨ã«æ˜‡æ ¼
                const newLeader = party.members[0];
                const oldLeaderName = party.leader.name;
                party.leader = newLeader;

                showToast(`ğŸ‘‘ ä»£è¡¨äº¤ä»£: ${party.name}`, `${oldLeaderName} æ°ã®ä¸åœ¨ã‚’å—ã‘ã€${newLeader.name} æ°ãŒæ–°ä»£è¡¨ã«å°±ä»»ã—ã¾ã—ãŸã€‚`, "#f1c40f");
            }
        }
    }

    function getContrastYIQ(hexcolor) {
        if (!hexcolor) return 'white';
        hexcolor = hexcolor.replace("#", "");
        const r = parseInt(hexcolor.substr(0, 2), 16);
        const g = parseInt(hexcolor.substr(2, 2), 16);
        const b = parseInt(hexcolor.substr(4, 2), 16);
        const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        return (yiq >= 128) ? 'black' : 'white';
    }
    // é€šçŸ¥ã‚’è¡¨ç¤ºã™ã‚‹æ±ç”¨é–¢æ•°
    function showToast(title, message, color = "#3498db") {
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            document.body.appendChild(container);
        }

        const toast = document.createElement('div');
        toast.className = 'toast-card';
        // èƒŒæ™¯è‰²ã¨ã€æ–‡å­—ã®èª­ã¿ã‚„ã™ã•ã‚’è‡ªå‹•èª¿æ•´
        toast.style.backgroundColor = color;
        toast.style.color = getContrastYIQ(color);
        toast.style.borderLeft = "none"; // è‰²ã¤ãã‚«ãƒ¼ãƒ‰ã«ã™ã‚‹ã®ã§ãƒœãƒ¼ãƒ€ãƒ¼ã¯ä¸è¦

        toast.innerHTML = `
        <span class="toast-close" style="color:${getContrastYIQ(color)}">&times;</span>
        <div style="font-weight: bold; margin-bottom: 3px; font-size: 1em;">${title}</div>
        <div style="font-size: 0.85em; opacity: 0.9;">${message}</div>
    `;
        addLog(`é€šçŸ¥: ${title} - ${message}`);

        const closeBtn = toast.querySelector('.toast-close');
        closeBtn.onclick = () => {
            toast.style.animation = "slideInRight 0.3s ease-in reverse forwards";
            setTimeout(() => toast.remove(), 300);
        };

        setTimeout(() => { if (toast.parentElement) closeBtn.click(); }, 5000);
        container.appendChild(toast);
    }

    // æ±ç”¨ç³» //
    /**
     * @param {string} title - ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«
     * @param {string} htmlContent - ä¸­èº«ã®HTMLï¼ˆæ–‡å­—åˆ—ã§OKï¼‰
     * @param {Array} buttons - ãƒœã‚¿ãƒ³ã®é…åˆ— [{text: "æ–‡å­—", cb: é–¢æ•°, color: "è‰²"}]
     */
    function openUniversalModal(title, htmlContent, buttons = []) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-body').innerHTML = htmlContent;

        const footer = document.getElementById('modal-footer');
        footer.innerHTML = ""; // ä»¥å‰ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªã‚¢

        buttons.forEach(btnInfo => {
            const btn = document.createElement('button');
            btn.innerText = btnInfo.text;
            btn.style.cssText = `padding:10px 20px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; background:${btnInfo.color || '#4ecca3'}; color:white;`;
            btn.onclick = () => {
                btnInfo.cb(); // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
            };
            footer.appendChild(btn);
        });

        document.getElementById('universal-modal').style.display = 'flex';
    }

    function closeUniversalModal() {
        document.getElementById('universal-modal').style.display = 'none';
    }
    // æ±ç”¨ã‚·ãƒªãƒ¼ã‚ºçµ‚ã‚ã‚Š //

    function generateComplexName() {
        const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
        const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
        const rand = Math.random(); // 0.0 ã€œ 1.0

        if (rand < 0.10) {
            // 10%ã®ç¢ºç‡ã§ã€Œã€‡ã€‡2ä¸–ã€
            const suffixes = ["2ä¸–", "Jr.", "3ä¸–", "å¿"];
            const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
            return `${lastName}ãƒ»${firstName}${suffix}`;
        } else if (rand < 0.20) {
            // æ¬¡ã®10%ã®ç¢ºç‡ã§ã€ŒãƒŸãƒ‰ãƒ«ãƒãƒ¼ãƒ ã€
            const middle = middleNames[Math.floor(Math.random() * middleNames.length)];
            return `${lastName}${middle}${firstName}`;
        } else {
            // æ®‹ã‚Š80%ã¯é€šå¸¸ã®ã€Œè‹—å­— åå‰ã€
            return `${lastName}ãƒ»${firstName}`;
        }
    }


    function createRandomNPC(name) {
        // ãƒ©ãƒ³ãƒ€ãƒ ãªã‚·ãƒ¼ãƒ‰æ–‡å­—åˆ—ã‚’ç”Ÿæˆ
        const randomSeed = Math.random().toString(36).substring(7);
        const icons = ["adventurer", "adventurer-neutral", "avataaars", "avataaars-neutral", "big-ears", "big-ears-neutral", "personas", "thumbs", "toon-head", "fun-emoji", "pixel-art", "pixel-art-neutral"];
        const icons1 = icons[Math.floor(Math.random() * icons.length)];

        return {
            id: Date.now() + Math.random(), // ğŸ’¥ å›ºæœ‰ã®IDã‚’è¿½åŠ 
            name: name,
            termCount: 0,
            // DiceBear APIã‚’ä½¿ç”¨ (seedã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«)
            icon: `https://api.dicebear.com/9.x/${icons1}/svg?seed=${randomSeed}`,
            ideology: {
                economy: Math.floor(Math.random() * 101),
                government: Math.floor(Math.random() * 101),
                diplomacy: Math.floor(Math.random() * 101)
            }
        };
    }

    // NPCã®ãƒ‡ãƒ¼ã‚¿é…åˆ—
    let npcs = [
    ];

    // æ€æƒ³ã®è¿‘ã•ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼ˆè¦ªå¯†åº¦ï¼‰
    function calculateAffinity(ideology1, ideology2) {
        // å„è»¸ã®å·®ã®çµ¶å¯¾å€¤ã‚’åˆè¨ˆã—ã€100ã‹ã‚‰å¼•ãï¼ˆå˜ç´”ãªè·é›¢è¨ˆç®—ï¼‰
        const diffEcon = Math.abs(ideology1.economy - ideology2.economy);
        const diffGov = Math.abs(ideology1.government - ideology2.government);
        const diffDipl = Math.abs(ideology1.diplomacy - ideology2.diplomacy);

        const avgDiff = (diffEcon + diffGov + diffDipl) / 3;
        return Math.round(100 - avgDiff); // 100ã«è¿‘ã„ã»ã©ä»²è‰¯ã—
    }
    let currentEditingIndex = null;

    function renderNPCs(filterText = "", playerIdeology) {
        const listElement = document.getElementById('npc-list');
        listElement.innerHTML = "";

        npcs.forEach((npc) => {
            const affinity = calculateAffinity(playerIdeology, npc.ideology);
            const title = getIdeologyTitle(npc.ideology);

            // --- ğŸš€ ã€æ–°è¦ã€‘æ‰€å±æ”¿å…šã®å–å¾— ---
            const party = parties.find(p => p.id === npc.partyId);
            const partyName = party ? party.name : "ç„¡æ‰€å±";
            const partyColor = party ? party.color : "#95a5a6"; // ç„¡æ‰€å±ã¯ã‚°ãƒ¬ãƒ¼
            const matchName = npc.name.includes(filterText);
            const matchParty = partyName.includes(filterText);

            if (!matchName && !matchParty) return;

            const card = document.createElement('div');
            card.className = "stat-card";
            card.style.cursor = "pointer";

            card.onclick = () => openNpcModal(npc.id);

            card.innerHTML = `
            <div style="display:flex; align-items:center; margin-bottom:5px;">
                <img src="${npc.icon}" style="width:40px; height:40px; border-radius:50%; margin-right:10px; background:#2c3e50; border: 2px solid ${partyColor};">
                <div>
                    <div style="font-weight:bold;">${npc.name}</div>
                    <div style="font-size:0.7em; color:${affinity > 55 ? '#4ecca3' : '#e74c3c'}">
                        é–¢ä¿‚: ${affinity}%
                    </div>
                </div>
            </div>
            
            <div style="display:flex; gap:4px; flex-wrap:wrap;">
                <div class="ideology-tag" style="font-size: 0.6em; padding: 2px 6px; background: #34495e; border-radius:3px; color:white;">
                    ${title}
                </div>
                <div class="party-tag" style="font-size: 0.6em; padding: 2px 6px; background: ${partyColor}; border-radius:3px; color:white; font-weight:bold;">
                    ${partyName}
                </div>
            </div>
        `;
            listElement.appendChild(card);
        });
    }

    // --- æ–°ã—ã„NPCã‚’è¿½åŠ ã™ã‚‹é–¢æ•° ---
    function addNewNPC() {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§æ–°ã—ã„NPCã‚’ä½œæˆ
        const newNpc = createRandomNPC("æ–°ã—ã„äººç‰©");
        // é…åˆ—ã®å…ˆé ­ã«è¿½åŠ 
        npcs.unshift(newNpc);

        // ãã®ã¾ã¾ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        const playerIdeology = JSON.parse(localStorage.getItem('political_game_data')).ideology;
        renderNPCs("", playerIdeology);
    }

    // ã‚¤ãƒ‡ã‚ªãƒ­ã‚®ãƒ¼å–å¾—
    // æ€æƒ³ã‚¹ã‚³ã‚¢ã‹ã‚‰ç§°å·ï¼ˆæ€æƒ³åï¼‰ã‚’è¿”ã™å…±é€šé–¢æ•°
    function getIdeologyTitle(ideology) {
        const { economy: econ, government: gov } = ideology;
        let title = "ä¸­é“";
        if (gov < 30 && econ < 30) title = "å¹³ç­‰ä¸»ç¾©ã®éæ¿€æ´¾"; // å…ƒï¼šå¹³ç­‰ä¸»ç¾©ã®éæ¿€æ´¾
        if (gov > 70 && econ < 30) title = "ç‹¬è£è€…";   // å…ƒï¼šç‹¬è£è€…
        if (gov < 30 && econ > 70) title = "è‡ªç”±ä¸»ç¾©"; // å…ƒï¼šè‡ªç”±ä¸»ç¾©è€…

        // ã•ã‚‰ã«ç´°ã‹ãåˆ†å²ã•ã›ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™
        return title;
    }

    // --- ä¿å­˜å‡¦ç†ã®ä¿®æ­£ (ä¿å­˜ãƒœã‚¿ãƒ³ã®onclickå†…) ---
    // --- 1. ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ¶å¾¡ (DiceBear & ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰) ---

    // ã‚·ãƒ¼ãƒ‰å€¤å…¥åŠ›

    // --- 2. ä¿å­˜å‡¦ç† (ä¸€ç®‡æ‰€ã«çµ±åˆ) ---
    // --- ä¿å­˜å‡¦ç†ï¼ˆã“ã‚Œ1ã¤ã ã‘ã«ã—ã¦ãã ã•ã„ï¼ï¼‰ ---
    document.getElementById('save-npc-btn').onclick = () => {
        // currentEditingIdã‚’ä½¿ã£ã¦ã€å…ƒã®é…åˆ—ã‹ã‚‰è©²å½“è€…ã‚’æ¢ã™
        const targetNpc = npcs.find(n => n.id === currentEditingId);
        if (!targetNpc) return;

        targetNpc.name = document.getElementById('edit-npc-name').value;
        targetNpc.icon = document.getElementById('edit-npc-preview').src;

        closeModal();

        // --- æ”¿å…šã®å¼·åˆ¶å¤‰æ›´ãƒ­ã‚¸ãƒƒã‚¯ ---
        const newPartyId = document.getElementById('edit-npc-party').value;

        // ä»¥å‰ã®æ”¿å…šã®ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ï¼ˆå¿…è¦ãªã‚‰ï¼‰
        if (targetNpc.partyId) {
            const oldParty = parties.find(p => p.id === targetNpc.partyId);
            if (oldParty) {
                oldParty.members = oldParty.members.filter(m => m.id !== targetNpc.id);
            }
        }

        // æ–°ã—ã„æ”¿å…šã‚’ã‚»ãƒƒãƒˆ
        targetNpc.partyId = newPartyId || null;

        // æ–°ã—ã„æ”¿å…šã®ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆå¿…è¦ãªã‚‰ï¼‰
        if (newPartyId) {
            const newParty = parties.find(p => p.id === newPartyId);
            if (newParty) {
                if (!newParty.members.find(m => m.id === targetNpc.id)) {
                    newParty.members.push(targetNpc);
                }
            }
        }
        const profile = JSON.parse(localStorage.getItem('political_game_data'));
        renderNPCs(document.getElementById('npc-search').value, profile.ideology);
    };

    // --- 3. æ¤œç´¢ã‚¤ãƒ™ãƒ³ãƒˆ ---
    document.getElementById('npc-search').addEventListener('input', (e) => {
        const profile = JSON.parse(localStorage.getItem('political_game_data'));
        renderNPCs(e.target.value, profile.ideology);
    });

    function closeModal() {
        document.getElementById('npc-modal').style.display = 'none';
    }
    // NPCã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

    // 1. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openNpcModal(targetId) {
        // IDãŒä¸€è‡´ã™ã‚‹äººã‚’ä¸€äººæ¢ã™
        const npc = npcs.find(n => n.id === targetId);
        if (!npc) return;

        currentEditingId = targetId; // currentEditingIndexã®ä»£ã‚ã‚Šã«Idã‚’ä½¿ã†

        document.getElementById('edit-npc-name').value = npc.name;
        const seedMatch = npc.icon.match(/seed=([^&]+)/);
        document.getElementById('edit-npc-seed').value = seedMatch ? seedMatch[1] : "";
        document.getElementById('edit-npc-preview').src = npc.icon;

        const partySelect = document.getElementById('edit-npc-party');
        partySelect.innerHTML = ''; // ä¸€æ—¦ã‚¯ãƒªã‚¢

        const optNone = document.createElement('option');
        optNone.value = "";
        optNone.textContent = "ç„¡æ‰€å±";
        partySelect.appendChild(optNone);

        parties.filter(p => p.active).forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name;
            // ç¾åœ¨ã®æ‰€å±ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠ
            if (npc.partyId === p.id) opt.selected = true;
            partySelect.appendChild(opt);
        });
        document.getElementById('npc-modal').style.display = 'flex';
    }

    // 2. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeModal() {
        document.getElementById('npc-modal').style.display = 'none';
    }

    // 3. ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    document.getElementById('edit-npc-seed').addEventListener('input', (e) => {
        const newSeed = e.target.value || "default";
        document.getElementById('edit-npc-preview').src = `https://api.dicebear.com/9.x/personas/svg?seed=${newSeed}`;
    });

    let gameTimer = null;
    let gameSpeed = 0; // 0: åœæ­¢, 1: é€šå¸¸, 3: æ—©é€ã‚Š

    // æ—¥ä»˜ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function updateDateDisplay() {
        const year = gameDate.getFullYear();
        const month = gameDate.getMonth() + 1;
        const day = gameDate.getDate();
        document.getElementById('display-date').innerText = `${year}å¹´ ${month}æœˆ ${day}æ—¥`;
    }
    let dayCounter = 0

    // ã‚²ãƒ¼ãƒ ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹é–¢æ•°
    function setGameSpeed(speed) {
        gameSpeed = speed;

        // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
        if (gameTimer) clearInterval(gameTimer);

        // ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒ0ã‚ˆã‚Šå¤§ãã„ãªã‚‰ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        if (gameSpeed > 0) {
            // é€šå¸¸ã¯1ç§’(1000ms)ã”ã¨ã«1æ—¥é€²ã‚€ã€‚ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒ3ãªã‚‰1/3ã®é€Ÿã•ã§é€²ã‚€
            gameTimer = setInterval(() => {
                gameDate.setDate(gameDate.getDate() + 1);
                updateDateDisplay();
                dayCounter++;

                // --- ã€100æ—¥å‘¨æœŸã€‘è»ã®å…¥é€€éšŠï¼ˆã“ã‚Œã¯é‡ã„ï¼†è¨­å®šé€šã‚Š200æ—¥åˆ¤å®šãŒã‚ã‚‹ã®ã§100æ—¥æ¯ã§OKï¼‰ ---
                if (dayCounter % 100 === 0) {
                    processMilitaryLifeCycle();
                }

                // --- ã€æ¯æ—¥åˆ¤å®šã€‘æ”¿å…šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå†…éƒ¨ã«1%ãªã©ã®ç¢ºç‡ãŒã‚ã‚‹ãŸã‚ã€æ¯æ—¥ãƒãƒ£ãƒ³ã‚¹ã‚’ä¸ãˆã‚‹ï¼‰ ---
                processDailyPartyAction();

                // --- ã€æ¯æ—¥åˆ¤å®šã€‘æ–°å…šçµæˆï¼ˆã“ã‚Œã‚‚å†…éƒ¨ã«ç¢ºç‡ã‚„æ¡ä»¶ãŒã‚ã‚‹ãªã‚‰æ¯æ—¥ã§OKï¼‰ ---
                checkPartyCreationEvent();

                // --- ã€æ¯æ—¥åˆ¤å®šã€‘é¸æŒ™ç®¡ç† ---
                updateElectionStatus();

                // æ¯æœˆ1æ—¥ã«ä½•ã‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’èµ·ã“ã™ãªã‚‰ã“ã“
                if (gameDate.getDate() === 1) {
                    updatePartyLeaders();
                    console.log("æœˆã®å§‹ã¾ã‚Šï¼äºˆç®—ã®æ›´æ–°ãªã©...");
                }
            }, 1000 / gameSpeed);
        }

        // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’å¤‰ãˆã‚‹ï¼ˆä»»æ„ï¼‰
        document.getElementById('btn-pause').style.opacity = speed === 0 ? "1" : "0.5";
        document.getElementById('btn-play').style.opacity = speed === 1 ? "1" : "0.5";
        document.getElementById('btn-fast').style.opacity = speed === 3 ? "1" : "0.5";
        document.getElementById('btn-skip').style.opacity = speed === 50 ? "1" : "0.5";

    }
    // é¸æŒ™
    // window.onloadã®å¤–ã‹ã€é©åˆ‡ãªå ´æ‰€ã«è¿½åŠ 
    let electionHistory = []; // æ­´ä»£ã®çµæœã‚’ä¿å­˜

    function updateElectionStatus() {
        // 1. ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®é€²è¡Œï¼ˆé¸æŒ™å‰ã®ã¿æ¸›ã‚‰ã™ï¼‰
        if (electionCountdown > 0) {
            electionCountdown--;
        }

        // 2. é¸æŒ™ã®ç™ºç«ï¼ˆ0ã«ãªã£ãŸç¬é–“ï¼‰
        if (electionCountdown === 0) {
            runElection();
            electionCountdown = -1; // å°±ä»»å¼ã¾ã§ã€Œå¾…æ©Ÿãƒ¢ãƒ¼ãƒ‰ã€ã¸
        }

        // 3. UIæ›´æ–°ï¼ˆãƒã‚¤ãƒŠã‚¹ã‚’è¡¨ç¤ºã•ã›ãªã„ã€100%ã§æ­¢ã‚ã‚‹ï¼‰
        const displayDays = Math.max(0, electionCountdown);
        document.getElementById('election-days-left').innerText = displayDays;

        // é¸æŒ™å¾Œã¯ãƒãƒ¼ã‚’100%ã§å›ºå®šã€é¸æŒ™å‰ã¯è¨ˆç®—
        let progress;
        if (electionCountdown <= 0) {
            progress = 100;
        } else {
            progress = ((1460 - electionCountdown) / 1460) * 100;
        }
        document.getElementById('election-progress').style.width = Math.min(100, progress) + "%";

        // 4. å°±ä»»å¼ã®ãƒã‚§ãƒƒã‚¯ (1æœˆ20æ—¥)
        if (gameDate.getMonth() === 0 && gameDate.getDate() === 20 && presidentElect) {
            holdInauguration();
            // â€»ã“ã®ä¸­ã®å‡¦ç†ã§ electionCountdown = 1460 ã«æˆ»ã‚‹
        }

        parliamentElectionCounter--;


        if (parliamentElectionCounter <= 0) {
            startParliamentElection();
            parliamentElectionCounter = 730; // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
        }

        updateParliamentUI();
    }

    // é–£åƒš
    function appointCabinet(newPresident) {
        // 1. å…¨NPCã¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å€™è£œè€…ã¨ã—ã¦ãƒªã‚¹ãƒˆåŒ–ï¼ˆå¤§çµ±é ˜æœ¬äººã¯é™¤ãï¼‰
        let candidates = [...npcs];
        if (typeof player !== 'undefined') {
            candidates.push({ ...player, isPlayer: true, id: "player" });
        }
        candidates = candidates.filter(c => c.id !== newPresident.id);

        // 2. å†…é–£ã‚’ä¸€åº¦ãƒªã‚»ãƒƒãƒˆ
        Object.keys(currentCabinet).forEach(key => currentCabinet[key] = null);

        // 3. ç›¸æ€§ãŒè‰¯ã„é †ã«ã‚½ãƒ¼ãƒˆ
        candidates.sort((a, b) => {
            const affA = calculateAffinity(newPresident.ideology, a.ideology);
            const affB = calculateAffinity(newPresident.ideology, b.ideology);
            return affB - affA;
        });

        // 4. å„ãƒã‚¹ãƒˆã«å‰²ã‚Šå½“ã¦
        let assignedCount = 0;
        const roles = Object.keys(currentCabinet);

        roles.forEach(role => {
            if (candidates.length > 0) {
                // å›½é˜²é•·å®˜ (defenseSecretary) ã®ç‰¹æ®Šãƒ«ãƒ¼ãƒ«
                if (role === "defenseSecretary") {
                    // è»äº‹çš„ãªæ€æƒ³(gov > 70)ã‚’æŒã¤äººã‚’å„ªå…ˆçš„ã«æ¢ã™
                    const militaryIndex = candidates.findIndex(c => c.ideology.gov > 70);
                    if (militaryIndex !== -1) {
                        currentCabinet[role] = candidates.splice(militaryIndex, 1)[0];
                        return;
                    }
                }

                // é€šå¸¸ã®ä»»å‘½ï¼ˆç›¸æ€§é †ï¼‰
                // ç›¸æ€§ãŒä¸€å®šä»¥ä¸‹ï¼ˆä¾‹: 30æœªæº€ï¼‰ãªã‚‰ã€Œç©ºå¸­ã€ã«ã™ã‚‹
                const topCandidate = candidates[0];
                if (calculateAffinity(newPresident.ideology, topCandidate.ideology) >= 30) {
                    currentCabinet[role] = candidates.shift();
                }
            }
        });
    }

    function holdInauguration() {
        setGameSpeed(0); // æ™‚é–“ã‚’æ­¢ã‚ã‚‹

        let farewellMessage = "";
        let isReelection = false;

        // å‰ä»»è€…ãŒå­˜åœ¨ã—ã€ã‹ã¤ä»Šå›ã®å½“é¸è€…ã¨åŒã˜äººç‰©ãªã‚‰ã€Œå†é¸ã€
        if (president && president.name === presidentElect.name) {
            isReelection = true;
            presidenttermcount += 1;
        } else {
            presidenttermcount = 1;
        };

        if (president) {
            // å‰å¤§çµ±é ˜ã¨æ–°å¤§çµ±é ˜ã®æ€æƒ³ç›¸æ€§ã‚’è¨ˆç®—
            const affinity = calculateAffinity(president.ideology, presidentElect.ideology);

            // ç›¸æ€§ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åˆ†å²
            if (affinity >= 80) {
                farewellMessage = `ã€Œ${presidentElect.name}ã€ã‚ãªãŸã¯ã€å¤§çµ±é ˜ã¨ã—ã¦è·å‹™ã‚’é ‘å¼µã£ã¦ãã ã•ã„ã€å¿œæ´ã—ã¦ã„ã¾ã™ã€‚ã€`;
            } else if (affinity >= 50) {
                farewellMessage = `ã€Œ${presidentElect.name}ã€ã“ã‚Œã‹ã‚‰ã¯ã‚ãªãŸã®æ™‚ä»£ã§ã™ã€é ‘å¼µã£ã¦ãã ã•ã„ã€å¿œæ´ã—ã¦ã¾ã™ã€‚ã€`;
            } else if (affinity >= 30) {
                farewellMessage = `ã€Œ${presidentElect.name}ã€ã‚ãªãŸãŒå¤§çµ±é ˜ã«ãªã‚‹ã¨ã¯æ€ã‚ãªã‹ã£ãŸã€ã“ã‚Œã‹ã‚‰ã®æ™‚ä»£ãŒã©ã†ãªã‚‹ã‹ã‚ã‹ã‚Šã¾ã›ã‚“ãŒã€é ‘å¼µã£ã¦ãã ã•ã„ã€‚ã€`;
            } else {
                farewellMessage = `ã€Œ${presidentElect.name}ã€ã‚ãªãŸãŒå¤§çµ±é ˜ã«ãªã‚‹ã¨ã¯ã ã‚Œã‚‚äºˆæƒ³ã—ã¦ã„ãªã‹ã£ãŸã€æ­£ç›´è¨€ã£ã¦ã“ã‚ŒãŒç¾å®Ÿã ã¨ã¯æ€ã„ãŸããªã„ã€‚ã€`;
            }
        }

        const isPlayer = presidentElect.isPlayer; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå½“é¸ã—ãŸã‹
        const title = isPlayer ? "ã‚ãªãŸã®å°±ä»»å¼" : `${presidentElect.name}å¤§çµ±é ˜å°±ä»»å¼`;
        let html
        if (isReelection) {
            html = `
        <div style="background:#1a2a6c; color:white; padding:30px; border-radius:10px; text-align:center; border: 5px solid #f1c40f;">
            <h1 style="margin-bottom:20px;">ğŸ›ï¸${presidenttermcount}æœŸç›®ã®é–‹å§‹ã¨å°±ä»»å¼</h1>
            <img src="${presidentElect.icon}" style="width:120px; height:120px; border-radius:50%; border:5px solid white; background:white;">
            <h2 style="margin-top:20px;">${presidentElect.name}</h2>
            <p style="font-style:italic; font-size:1.1em; margin:20px 0;">
                ç§ã¯å¤§çµ±é ˜ã¨ã—ã¦ã€å…¨åŠ›ã‚’å°½ãã™ã“ã¨ã‚’èª“ã„ã¾ã™ã€‚
            </p>
            <div style="font-size:0.9em; color:#bdc3c7;">
                ${gameDate.getFullYear()}å¹´1æœˆ20æ—¥ æ­£åˆ
            </div>
        </div>
    `;
        } else {
            html = `
        <div style="background:#1a2a6c; color:white; padding:30px; border-radius:10px; text-align:center; border: 5px solid #f1c40f;">
            <h1 style="margin-bottom:20px;">ğŸ›ï¸å°±ä»»å¼ã®æ—¥</h1>
            <img src="${presidentElect.icon}" style="width:120px; height:120px; border-radius:50%; border:5px solid white; background:white;">
            <h2 style="margin-top:20px;">${presidentElect.name}</h2>
            <p style="font-style:italic; font-size:1.1em; margin:20px 0;">
                "ç§ã¯å¤§çµ±é ˜ã«å°±ä»»ã—ã¾ã™ã€‚"
            </p>
            <div style="font-size:0.9em; color:#bdc3c7;">
                ${gameDate.getFullYear()}å¹´1æœˆ20æ—¥ æ­£åˆ
            </div>
        </div>
    `;
        }
        if (president && !isReelection) {
            html += `<div style="background:#1a2a6c; color:white; padding:30px; border-radius:10px; text-align:center; border: 5px solid #f1c40f;">
            <h1 style="margin-bottom:20px; font-size:1.5em;">ğŸ›ï¸å°±ä»»å¼ã®æ—¥</h1>
            
                        <img src="${president.icon}" style="width:120px; height:120px; border-radius:50%; border:5px solid white; background:white;">
            <h2 style="margin-top:20px;">${president.name}</h2>
                <div style="margin-bottom:20px; padding:10px; background:rgba(0,0,0,0.3); border-radius:5px;">
                    <small>å‰å¤§çµ±é ˜${president.name}ã®é€€ä»»:</small>
                    <p style="font-size:1.1em; color:#ecf0f1;">${farewellMessage}</p>
                </div>
            </div >`;
        }
        president = presidentElect

        openUniversalModal(title, html, [
            {
                text: "ãŠã‚ã§ã¨ã†ã€‚",
                cb: () => {
                    presidentElect = null;
                    appointCabinet(president); // å†…é–£ä»»å‘½å®Ÿè¡Œ
                    showCabinetAnnouncement(); // å†…é–£ç™ºè¡¨ç”»é¢ã¸
                },
                color: "#f1c40f"
            }
        ]);
    }
    function showCabinetAnnouncement() {
        if (!president) {
            openUniversalModal("ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚", "ã¾ã æ­£å¼ãªéƒ¨ä¸‹ã®ç™ºè¡¨ã¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", [
                {
                    text: "æ—©ãã—ã‚ï¼",
                    cb: () => {
                        closeUniversalModal();
                    },
                }
            ]);
            return
        }
        const stats = getMilitaryStats(); // è»äº‹æƒ…å ±ï¼ˆå›½é˜²é•·å®˜ã®åˆ¤å®šç”¨ãªã©ï¼‰

        // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼
        const getPersonUI = (person, roleName, size = "normal") => {
            const isVacant = !person;
            const isPlayer = person?.isPlayer || person?.id === "player";
            const name = isVacant ? "ï¼ˆç©ºå¸­ï¼‰" : person.name;
            const icon = isVacant ? "https://via.placeholder.com/100?text=?" : person.icon;

            // ã‚µã‚¤ã‚ºè¨­å®š
            const dim = size === "large" ? 120 : (size === "medium" ? 80 : 60);
            const fontSize = size === "large" ? "1.5em" : (size === "medium" ? "1.1em" : "0.9em");
            const borderColor = isPlayer ? "#f1c40f" : "#fff";

            return `
            <div style="text-align:center; padding:10px; transition: transform 0.3s;">
                <div style="position:relative; display:inline-block;">
                    <img src="${icon}" style="width:${dim}px; height:${dim}px; border-radius:50%; border:3px solid ${borderColor}; box-shadow: 0 4px 15px rgba(0,0,0,0.5); background:#2c3e50;">
                    ${isPlayer ? `<div style="position:absolute; bottom:0; right:0; background:#f1c40f; color:#000; font-size:10px; padding:2px 6px; border-radius:10px; font-weight:bold;">YOU</div>` : ''}
                </div>
                <div style="margin-top:8px;">
                    <div style="font-size:0.7em; color:#bdc3c7; text-transform:uppercase; letter-spacing:1px;">${roleName}</div>
                    <div style="font-size:${fontSize}; font-weight:bold; color:${isVacant ? '#e74c3c' : '#fff'};">${name}</div>
                </div>
            </div>
        `;
        };

        const html = `
    <div style="background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); padding:2px; border-radius:15px;">
        <div style="background:#1a1a2e; color:white; padding:30px; border-radius:13px; font-family:'Segoe UI', sans-serif;">
            
            <h2 style="text-align:center; margin-bottom:30px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">æ–°æ”¿æ¨©ãƒ»é–£åƒšåç°¿</h2>

            <div style="display:flex; justify-content:center; margin-bottom:20px;">
                ${getPersonUI(president, "å¤§çµ±é ˜", "large")}
            </div>

            <div style="display:flex; justify-content:center; margin-bottom:40px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:20px;">
                ${getPersonUI(currentCabinet.vicePresident, "å‰¯å¤§çµ±é ˜", "medium")}
            </div>

            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap:20px; justify-items:center;">
                ${getPersonUI(currentCabinet.stateSecretary, "å›½å‹™é•·å®˜")}
                ${getPersonUI(currentCabinet.defenseSecretary, "å›½é˜²é•·å®˜")}
                ${getPersonUI(currentCabinet.justiceSecretary, "å¸æ³•é•·å®˜")}
                ${getPersonUI(currentCabinet.commerceSecretary, "å•†å‹™é•·å®˜")}
                ${getPersonUI(currentCabinet.homelandSecretary, "å›½åœŸé–‹ç™ºé•·å®˜")}
            </div>

            <div style="margin-top:30px; padding:15px; background:rgba(255,255,255,0.05); border-radius:8px; font-size:0.85em; line-height:1.6; border-left:4px solid #f1c40f;">
                <strong>ğŸ“œã‚¢ãƒ‰ãƒã‚¤ã‚¹:</strong><br>
                ${currentCabinet.stateSecretary.name}ã€Œ${generateCabinetAnalysis()}ã€
            </div>
        </div>
    </div>
    `;

        openUniversalModal("é–£åƒšãŸã¡", html, [
            { text: "äº†è§£", cb: () => { closeUniversalModal(); setGameSpeed(1); }, color: "#4ecca3" }
        ]);
    }

    // å†…é–£ã®æ§‹æˆã«åŸºã¥ã„ãŸåˆ†æãƒ†ã‚­ã‚¹ãƒˆï¼ˆãŠã¾ã‘ï¼‰
    function generateCabinetAnalysis() {
        const emptyCount = Object.values(currentCabinet).filter(v => !v).length;
        if (emptyCount >= 3) return "ç©ºå¸­ãŒç›®ç«‹ã¤ç•°å¸¸äº‹æ…‹ã§ã™ã€‚æ”¿æ¨©é‹å–¶ã®éº»ç—ºãŒæ‡¸å¿µã•ã‚Œã¾ã™ã€‚";

        const isDefenseMilitary = currentCabinet.defenseSecretary?.ideology.gov > 70;
        if (isDefenseMilitary) return "å›½é˜²é•·å®˜ãŒå¼·ã„ã§ã™ã€è»éƒ¨ã¨ã®é€£æºã‚’é‡è¦–ã—ã¦ã„ã¾ã™ã€‚";

        return "ãƒãƒ©ãƒ³ã‚¹ãŒå–ã‚Œã¦ã„ã¾ã™ã€æ€æƒ³ã®è¿‘ã„é–£åƒšãŸã¡ãŒå¤§çµ±é ˜ã‚’æ”¯ãˆã¾ã™ã€‚";
    }

    function runElection() {
        setGameSpeed(0); // æ™‚é–“ã‚’æ­¢ã‚ã‚‹
        if (!gameSettings.skipPresidentialElection) {
            const profile = JSON.parse(localStorage.getItem('political_game_data'));

            // ç«‹å€™è£œç¢ºèªç”¨ã®HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„
            const htmlContent = `
            <div style = "text-align:center; padding:20px;" >
            <p style="font-size:1.2em;">ç¬¬${electionHistory.length + 1}å›å¤§çµ±é ˜é¸æŒ™ãŒå…¬ç¤ºã•ã‚Œã¾ã—ãŸã€‚</p>
            <p>ã“ã®é¸æŒ™ã«ç«‹å€™è£œã—ã¾ã™ã‹ï¼Ÿ</p>
            <div style="margin-top:20px; font-size:0.8em; color:#bdc3c7;">
                â€»ç«‹å€™è£œã™ã‚‹ã¨ã€ã‚ãªãŸã®æ”¯æŒè€…ãŒã€ã‚ãªãŸã«æŠ•ç¥¨ã—ã¾ã™ã€‚<br>
                ç«‹å€™è£œã—ãªã„å ´åˆã¯ã€ä»–ã®å€™è£œè€…ã¸ã®æŠ•ç¥¨æ¨©ã®ã¿æŒã¡ã¾ã™ã€‚
            </div>
        </div >
            `;

            // æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã€Œç«‹å€™è£œã™ã‚‹ã‹ã€ã‚’èã
            openUniversalModal(
                "ğŸ—³ï¸ é¸æŒ™ç«‹å€™è£œã®ç¢ºèª",
                htmlContent,
                [
                    {
                        text: "ç«‹å€™è£œã™ã‚‹ï¼",
                        color: "#4ecca3",
                        cb: () => {
                            proceedToVote(true),
                                isPlayerRunningForPresident = true
                        }
                    },
                    {
                        text: "ä»Šå›ã¯è¦‹é€ã‚‹",
                        color: "#e74c3c",
                        cb: () => {
                            proceedToVote(false),
                                isPlayerRunningForPresident = false
                        }
                    }
                ]
            );
        } else {
            // ã‚¹ã‚­ãƒƒãƒ—è¨­å®šãŒã‚ã‚‹å ´åˆã¯ã€å¼·åˆ¶çš„ã«ç«‹å€™è£œã›ãšã«é€²ã‚€
            proceedToVote(false);
            isPlayerRunningForPresident = false;
        }
    }

    let candidates = [];

    function proceedToVote(willRun) {
        closeUniversalModal(); // ä¸€æ—¦é–‰ã˜ã‚‹

        const profile = JSON.parse(localStorage.getItem('political_game_data'));
        candidates = [];

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å€™è£œè€…ã«è¿½åŠ 
        if (willRun) {
            candidates.push({
                id: 'player',
                name: profile.name,
                icon: profile.icon,
                isPlayer: true,
                termCount: 0,
                ideology: profile.ideology,
                votes: 0,
                supporters: []
            });
        }

        // NPCã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«3äººç«‹å€™è£œï¼ˆå…ˆè¡Œè€…åˆ©ç›Šæ ï¼‰
        const npcPotential = [...npcs].sort(() => 0.5 - Math.random()).slice(0, 3);
        npcPotential.forEach(n => {
            candidates.push({ ...n, votes: 0, supporters: [], isPlayer: false });
        });

        // æ¬¡ã®ã€ŒæŠ•ç¥¨å…ˆé¸æŠã€ã¸é€²ã‚€
        showVotingScreen(candidates, willRun);
    }

    function showVotingScreen(candidates, willRun) {
        const title = willRun ? "æŠ•ç¥¨ã™ã‚‹å€™è£œè€…ã‚’é¸ã‚“ã§ãã ã•ã„" : "æŠ•ç¥¨ã™ã‚‹å€™è£œè€…ã‚’é¸ã‚“ã§ãã ã•ã„";

        let html = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">`;
        candidates.forEach(cand => {
            // --- ğŸš€ ã€æ–°è¦ã€‘æ‰€å±æ”¿å…šã®å–å¾— ---
            // candidates[i].displayParty ãŒæ—¢ã«ã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã—ã€
            // ãã†ã§ãªã„å ´åˆã¯ parties é…åˆ—ã‹ã‚‰æ¤œç´¢ã—ã¾ã™
            let currentPartyId = cand.partyId;

            // ã‚‚ã—å€™è£œè€…ãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãªã‚‰ã€profile.partyId ã‚’å„ªå…ˆã—ã¦å‚ç…§ã™ã‚‹
            if (cand.isPlayer || cand.id === profile.id) {
                currentPartyId = profile.partyId;
            }
            const party = parties.find(p => p.id === currentPartyId);
            const partyName = cand.displayParty || (party ? party.name : "ç„¡æ‰€å±");
            const partyColor = cand.partyColor || (party ? party.color : "#7f8c8d");

            html += `
            <div id="vote-target-${cand.id}" class="stat-card" 
                 style="cursor:pointer; text-align:center; border: 2px solid ${partyColor}; position:relative; overflow:hidden;">
                
                <div style="background:${partyColor}; color:white; font-size:0.6em; padding:2px 0; margin-bottom:5px; font-weight:bold;">
                    ${partyName}
                </div>

                <img src="${cand.icon}" style="width:50px; height:50px; border-radius:50%; background:#2c3e50; border:1px solid #ddd;"><br>
                
                <div style="padding:5px;">
                    <strong style="font-size:0.9em;">${cand.name}</strong><br>
                    <small style="font-size:0.7em; color:#7f8c8d;">${getIdeologyTitle(cand.ideology)}</small>
                </div>

            </div>
            `;
        });
        html += `</div>`;

        // æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã§æŠ•ç¥¨å…ˆã‚’è¡¨ç¤º
        openUniversalModal(title, html, []); // ãƒœã‚¿ãƒ³ã¯JSã§å¾Œã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸

        // å„ã‚«ãƒ¼ãƒ‰ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»˜ä¸
        candidates.forEach(cand => {
            document.getElementById(`vote-target-${cand.id}`).onclick = () => {
                finalizeElection(candidates, cand.id);
            };
        });
    }
    function finalizeElection(candidates, playerVoteTargetId) {
        closeUniversalModal();
        document.getElementById('voting-modal').style.display = 'none';

        // æ”¯æŒè€…ã®è©³ç´°ã‚’ä¸€æ™‚çš„ã«æ ¼ç´ã™ã‚‹é…åˆ—ã‚’ç”¨æ„
        candidates.forEach(cand => {
            cand.temp_supporters_info = [];
        });

        // 1. NPCãŸã¡ã®è‡ªå‹•æŠ•ç¥¨
        npcs.forEach(npc => {
            let bestAffinity = -1;
            let voteTo = null;

            candidates.forEach(cand => {
                const aff = calculateAffinity(npc.ideology, cand.ideology);
                const priorityBonus = (candidates.indexOf(cand) === 0) ? 8 : 0;

                if ((aff + priorityBonus) > bestAffinity) {
                    bestAffinity = aff + priorityBonus;
                    voteTo = cand;
                }
            });

            if (voteTo) {
                voteTo.votes++;
                voteTo.supporters.push(npc.icon);
                // ã€é‡è¦ã€‘æ”¯æŒè€…ã®è©³ç´°ï¼ˆåå‰ã€ã‚¢ã‚¤ã‚³ãƒ³ã€æ‰€å±æ”¿å…šIDï¼‰ã‚’è¨˜éŒ²
                voteTo.temp_supporters_info.push({
                    name: npc.name,
                    icon: npc.icon,
                    partyId: npc.partyId
                });
            }
        });

        // 2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®1ç¥¨ã‚’åŠ ç®—
        const myChoice = candidates.find(c => String(c.id) === String(playerVoteTargetId));
        if (myChoice) {
            myChoice.votes++;

            // ã€ä¿®æ­£ã€‘profile ã§ã¯ãªãã€ç¾åœ¨ã‚²ãƒ¼ãƒ ã§å‹•ã„ã¦ã„ã‚‹ player ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã†
            // ã‚‚ã— player å¤‰æ•°ãŒæœªå®šç¾©ãªã‚‰ã€ prpl[0] ãªã©ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æŒ‡ã™å¤‰æ•°ã«ç½®ãæ›ãˆã¦ãã ã•ã„
            const currentPlayerStatus = (typeof player !== 'undefined') ? player : prpl.find(p => p.id === "player");

            myChoice.supporters.push(currentPlayerStatus.icon || "");

            // ã€é‡è¦ã€‘ã“ã“ã§ currentPlayerStatus.partyId ã‚’è¦‹ã‚Œã°ã€å…¥å…šå¾Œã®å…šåãŒåæ˜ ã•ã‚Œã‚‹
            let pPartyId = currentPlayerStatus.partyId || "independents";

            myChoice.temp_supporters_info.push({
                name: currentPlayerStatus.name || "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼",
                icon: currentPlayerStatus.icon || "",
                partyId: profile.partyId,
            });
            console.log(myChoice);
        }

        // 3. çµæœã®æ•´ç†ã¨å±¥æ­´ã¸ã®ä¿å­˜ï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆåŒ–ï¼‰
        candidates.sort((a, b) => b.votes - a.votes);
        presidentElect = candidates[0];

        const historyEntry = {
            date: new Date(gameDate),
            winner: presidentElect,
            totalVotes: npcs.length + 1,
            all: candidates.map(cand => {
                // --- ğŸ”´ ã“ã“ãŒæ±ºå®šçš„ãªä¿®æ­£ç®‡æ‰€ ğŸ”´ ---
                let currentPartyId = cand.partyId;

                if (cand.id === "player" || cand.isPlayer === true) {
                    currentPartyId = profile.partyId;
                }
                // -----------------------------------

                return {
                    id: cand.id,
                    name: cand.name,
                    icon: cand.icon,
                    // ğŸ”´ ä¿®æ­£ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãªã‚‰ profile.partyId ã‚’ã€ãã†ã§ãªã‘ã‚Œã°æœ¬äººã® partyId ã‚’ä½¿ã†
                    partyId: (cand.isPlayer || cand.id === "player" || cand.id === "player_manual") ? profile.partyId : cand.partyId,
                    votes: cand.votes,
                    // ğŸ”´ ä¿®æ­£ï¼šã“ã“ã‚‚åŒæ§˜ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¤å®šã‚’åºƒã’ã‚‹
                    isPlayer: (cand.isPlayer || cand.id === "player" || cand.id === "player_manual"),
                    supporters: [...cand.supporters],
                    supporters_data: [...cand.temp_supporters_info]
                };
            }),
            inaugurated: false
        };
        console.log(historyEntry);
        electionHistory.push(historyEntry);

        showElectionResult(candidates);
    }

    function showElectionResult(results) {
        const content = document.getElementById('election-content');
        const [first, second, ...others] = results;
        if (first.isPlayer) {
            isPlayerRunningForPresident = true
        } else {
            isPlayerRunningForPresident = false;
        }

        let html = `<h1 style="text-align:center; color:#f1c40f;">ğŸ—³ï¸ é¸æŒ™çµæœç™ºè¡¨</h1>`;

        // ä¸Šä½2åã®ç‰¹å¤§è¡¨ç¤º
        html += `
                    <div style="display:flex; justify-content:center; gap:20px; margin-top:30px;">
                        <div style="text-align:center; border:2px solid #f1c40f; padding:20px; border-radius:10px; width:45%;">
                            <h2>ğŸ¥‡ 1ä½ (å½“é¸)</h2>
                            <img src="${first.icon}" style="width:120px; height:120px; border-radius:50%; border:4px solid #f1c40f;">
                                <div style="font-size:1.5em; font-weight:bold; margin-top:10px;">${first.name}</div>
                                <div style="font-size:2em; color:#f1c40f;">${first.votes} ç¥¨</div>
                                <div style="margin-top:10px;">æ”¯æŒè€…:<br>${first.supporters.map(img => `<img src="${img}" style="width:25px; border-radius:50%;">`).join("")}</div>
                        </div>
                        <div style="text-align:center; border:2px solid #bdc3c7; padding:20px; border-radius:10px; width:40%;">
                            <h2>ğŸ¥ˆ 2ä½</h2>
                            <img src="${second.icon}" style="width:100px; height:100px; border-radius:50%; border:2px solid #bdc3c7;">
                                <div style="font-size:1.2em; margin-top:10px;">${second.name}</div>
                                <div style="font-size:1.8em; color:#bdc3c7;">${second.votes} ç¥¨</div>
                                <div style="margin-top:10px;">æ”¯æŒè€…:<br>${second.supporters.map(img => `<img src="${img}" style="width:20px; border-radius:50%;">`).join("")}</div>
                        </div>
                    </div>`;

        // æ®‹ã‚Šã®å€™è£œè€…ã‚’ä¸‹ã«å°ã•ã
        html += `<div style="display:flex; justify-content:center; gap:15px; margin-top:40px; flex-wrap:wrap;">`;
        others.forEach(cand => {
            html += `
        <div style="text-align:center; background:#34495e; padding:10px; border-radius:8px; width:100px; font-size:0.8em;">
            <img src="${cand.icon}" style="width:50px; border-radius:50%;">
            <div>${cand.name}</div>
            <div>${cand.votes} ç¥¨</div>
        </div>`;
        });
        html += `</div>`;
        html += `
                    <div style="text-align:center;">
                        <h2 style="color:#f1c40f;">é¸æŒ™é€Ÿå ±</h2>
                        <img src="${presidentElect.icon}" style="width:100px; border-radius:50%; border:4px solid #f1c40f;">
                            <p style="font-size:1.2em;"><strong>${presidentElect.name}</strong> æ°ã®å½“é¸ãŒç¢ºå®Ÿã¨ãªã‚Šã¾ã—ãŸï¼</p>
                            <p>1æœˆ20æ—¥ã®å°±ä»»å¼ã¾ã§ã€æ”¿æ¨©ç§»è¡ŒæœŸé–“ã«å…¥ã‚Šã¾ã™ã€‚</p>
                    </div>
                    `;

        content.innerHTML = html;
        document.getElementById('election-result-modal').style.display = 'block';
        setGameSpeed(0); // çµæœç™ºè¡¨æ™‚ã¯æ™‚é–“ã‚’æ­¢ã‚ã‚‹
        electionCountdown = 1460;

    }

    // é¸æŒ™çµæœã‚’é–‰ã˜ãŸã‚‰ãƒ‡ã‚£ãƒŠãƒ¼ä¼šã¸
    function closeElectionModal() {
        document.getElementById('election-result-modal').style.display = 'none';
        // é¸æŒ™çµæœã®é€Ÿå ±ã‚’è¡¨ç¤º
        // é–‹å‚¬ã•ã‚Œã‚‹å ´åˆ
        startPostElectionDinner();
    }

    function startPostElectionDinner() {
        // 1. ã¾ãš40%ã®ç¢ºç‡ã§ã‚¤ãƒ™ãƒ³ãƒˆè‡ªä½“ãŒæ¶ˆæ»…
        if (Math.random() < 0.4) {
            openUniversalModal(
                "ğŸ½ï¸ ãƒ‡ã‚£ãƒŠãƒ¼ä¼šä¸­æ­¢",
                `<div style="text-align:center;">å„å€™è£œè€…ã®è«¸äº‹æƒ…ã«ã‚ˆã‚Šã€æœ¬æ—¥ã®ãƒ‡ã‚£ãƒŠãƒ¼ä¼šã¯ä¸­æ­¢ã§ã™ã€‚</div>`,
                [{ text: "äº†è§£", cb: closeUniversalModal, color: "#7f8c8d" }]
            );
            return;
        }

        const lastElection = electionHistory[electionHistory.length - 1];
        const playerInElection = lastElection.all.some(cand => cand.isPlayer);

        if (playerInElection) {
            // ã€ç«‹å€™è£œã—ã¦ã„ãŸå ´åˆã€‘ã¾ãšå‚åŠ ã™ã‚‹ã‹ã©ã†ã‹ã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«èã
            openUniversalModal(
                "âœ‰ï¸ ãƒ‡ã‚£ãƒŠãƒ¼ã¸ã®æ‹›å¾…",
                `<div style="text-align:center;">
                é¸æŒ™ãŒçµ‚ã‚ã‚Šã€ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‹ã‚‰æ‹›å¾…çŠ¶ãŒå±Šãã¾ã—ãŸã€‚<br>
                ç”Ÿé…ä¿¡ãƒ©ã‚¤ãƒ–ãŒè¡Œã‚ã‚Œã‚‹äºˆå®šã§ã™ãŒã€å‡ºå¸­ã—ã¾ã™ã‹ï¼Ÿ
            </div>`,
                [
                    { text: "å‡ºå¸­ã™ã‚‹", cb: () => processDinner(true), color: "#4ecca3" },
                    { text: "ä¸å‚åŠ ", cb: () => processDinner(false), color: "#e74c3c" }
                ]
            );
        } else {
            // ã€è¦³å®¢ã®å ´åˆã€‘ãã®ã¾ã¾é…ä¿¡ã‚’è¦‹ã‚‹ç”»é¢ã¸
            processDinner(false, true);
        }
    }

    /**
     * å®Ÿéš›ã®ãƒ‡ã‚£ãƒŠãƒ¼å‡¦ç†
     * @param {boolean} playerAttending - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‡ºå¸­ã™ã‚‹ã‹
                    * @param {boolean} isSpectator - è¦³å®¢ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹
                    */
    function processDinner(playerAttending, isSpectator = false) {
        const lastElection = electionHistory[electionHistory.length - 1];
        let attendeesCount = 0;
        let html = `<div style="background:#000; color:#0f0; padding:5px; font-family:monospace; margin-bottom:10px;">ğŸ”´ LIVE:ã€ã”ã¯ã‚“ã€‘ã‚ªãƒ„ã‚«ãƒ¬ã•ã¾ãƒ‡ã‚£ãƒŠãƒ¼</div>`;
        html += `<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:15px;">`;

        lastElection.all.forEach(cand => {
            let statusText = "";
            let opacity = "1";
            let isAttending = false;

            if (cand.isPlayer) {
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆ¤å®š
                if (playerAttending) {
                    statusText = "âœ… å‚åŠ ";
                    isAttending = true;
                } else {
                    statusText = "ğŸ’¢ ä¸å‚åŠ ";
                    opacity = "0.3";
                }
            } else {
                // NPCã®åˆ¤å®š
                const rand = Math.random();
                if (rand < 0.15) { statusText = "ğŸ¤’ é¢¨é‚ªæ¬ å¸­"; opacity = "0.3"; }
                else if (rand < 0.3) { statusText = "ğŸ’¢ ä¸å‚åŠ "; opacity = "0.3"; }
                else {
                    statusText = "âœ… å‚åŠ ";
                    isAttending = true;
                }
            }

            if (isAttending) attendeesCount++;

            html += `
                        <div style="text-align:center; opacity:${opacity}; background:#2c3e50; padding:10px; border-radius:10px; border: 1px solid ${opacity === "1" ? '#4ecca3' : 'transparent'};">
                        <img src="${cand.icon}" style="width:60px; border-radius:50%;"><br>
                            <strong style="font-size:0.8em;">${cand.name}</strong><br>
                                <span style="font-size:0.65em;">${statusText}</span>
                            </div>
                            `;
        });
        html += `</div>`;

        // çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ
        let resultMessage = "";
        if (isSpectator) {
            resultMessage = "è¦–è´è€…ã¨ã—ã¦ãƒ©ã‚¤ãƒ–ã‚’è¦‹å®ˆã£ã¦ã„ã¾ã™ã€‚";
        } else if (playerAttending) {
            resultMessage = attendeesCount > 1 ? "è³‘ã‚„ã‹ãªä¼šé£Ÿã¨ãªã‚Šã¾ã—ãŸã€éå¸¸ã«æ¥½ã—ã„é£Ÿäº‹ã§ã—ãŸã€‚" : "å‚åŠ è€…ã¯ã‚ãªãŸä¸€äººã§ã—ãŸã€‚è±ªè¯ãªæ–™ç†ã‚’ç‹¬ã‚Šå ã‚ã§ã™ã€‚";
        } else {
            resultMessage = "ã‚ãªãŸã¯æ¬ å¸­ã—ã¾ã—ãŸã€‚ãƒ©ã‚¤ãƒ–é…ä¿¡ã®ãƒãƒ£ãƒƒãƒˆæ¬„ã§ã¯ã‚ãªãŸã®ä¸åœ¨ãŒå™‚ã•ã‚Œã¦ã„ã¾ã™ã€‚";
        }

        html += `<p style="margin-top:15px; font-size:0.9em; text-align:center; color:#bdc3c7;">${resultMessage}</p>`;

        // ãƒœã‚¿ãƒ³ã®è¨­å®š
        const buttons = [];
        if (isSpectator) {
            buttons.push({ text: "é£Ÿäº‹ãƒ©ã‚¤ãƒ–ã‚’æœ€å¾Œã¾ã§è¦‹ã‚‹", cb: closeUniversalModal, color: "#3498db" });
            buttons.push({ text: "é£Ÿäº‹ãƒ©ã‚¤ãƒ–ã‚’é–‰ã˜ã‚‹", cb: closeUniversalModal, color: "#7f8c8d" });
        } else {
            buttons.push({ text: playerAttending ? "ä¼šé£Ÿã‚’çµ‚ãˆã‚‹" : "ãƒ©ã‚¤ãƒ–é…ä¿¡ã‚’é–‰ã˜ã‚‹", cb: closeUniversalModal, color: "#4ecca3" });
        }

        openUniversalModal("ğŸ½ï¸ é¸æŒ™å¾Œãƒ‡ã‚£ãƒŠãƒ¼çµæœ", html, buttons);
    }

    function openElectionHistory() {
        setGameSpeed(0);

        if (electionHistory.length === 0) {
            openUniversalModal(
                "ğŸ“œ æ­´ä»£é¸æŒ™ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–",
                `<div style="text-align:center; padding:50px;">
                <h2>ã¾ã é¸æŒ™ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</h2>
                <p>æœ€åˆã®é¸æŒ™ãŒå®Ÿæ–½ã•ã‚Œã‚‹ã¾ã§å¾…ã¡ã¾ã—ã‚‡ã†ã€‚</p>
             </div>`,
                [{ text: "é–‰ã˜ã‚‹", cb: closeUniversalModal, color: "#7f8c8d" }]
            );
            return;
        }

        let html = `<div style="padding:10px;">`;
        // æœ€æ–°ã®å±¥æ­´ã‹ã‚‰é †ã«ç”Ÿæˆ
        [...electionHistory].reverse().forEach((record, index) => {
            const realIndex = electionHistory.length - 1 - index;
            const dateStr = `${record.date.getFullYear()}/${record.date.getMonth() + 1}/${record.date.getDate()}`;
            const isPlayerWinner = record.winner.isPlayer;

            html += `
                                <div onclick="showElectionDetail(${realIndex})"
                                    style="background:#34495e; padding:15px; border-radius:10px; margin-bottom:12px; border-left: 5px solid ${isPlayerWinner ? '#4ecca3' : '#e74c3c'}; cursor:pointer;">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <div>
                                            <div style="font-size:0.7em; color:#bdc3c7;">ç¬¬ ${realIndex + 1} æœŸ é¸æŒ™</div>
                                            <div style="font-weight:bold; font-size:1.1em;">å½“é¸è€…: ${record.winner.name}</div>
                                            <div style="font-size:0.75em;">${dateStr} å®Ÿæ–½</div>
                                        </div>
                                        <img src="${record.winner.icon}" style="width:45px; border-radius:50%; background:#2c3e50;">
                                    </div>
                                </div>`;
        });
        html += `</div>`;
        setGameSpeed(0);

        // æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã§å±¥æ­´ä¸€è¦§ã‚’è¡¨ç¤º
        openUniversalModal(
            "ğŸ“œ æ­´ä»£é¸æŒ™ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–",
            html,
            [{ text: "é–‰ã˜ã‚‹", cb: closeUniversalModal, color: "#34495e" }]
        );
    }

    // ã‚‚ã— getPartyInfo ãŒãªã‘ã‚Œã°ã€ã“ã® showElectionDetail ã®ç›´å‰ã«è¿½åŠ 
    function getPartyInfo(partyId) {
        // 1. ç„¡æ‰€å±ã®åˆ¤å®š
        if (!partyId || partyId === "independents" || partyId === "independent") {
            return { name: "ç„¡æ‰€å±", color: "#95a5a6" };
        }

        // 2. æ”¿å…šãƒªã‚¹ãƒˆã‹ã‚‰æ¤œç´¢
        const party = parties.find(p => p.id === partyId);

        // 3. è¦‹ã¤ã‹ã‚Œã°ãã®å…šã‚’ã€è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ã€Œè§£æ•£ã—ãŸå…šã€ã¾ãŸã¯ã€Œç„¡æ‰€å±ã€ã‚’è¿”ã™
        if (party) {
            return { name: party.name, color: party.color };
        } else {
            return { name: "ç„¡æ‰€å±(æ—§å…š)", color: "#bdc3c7" };
        }
    }

    /**
     * é¸æŒ™ã®å€‹åˆ¥è©³ç´°ã‚’è¡¨ç¤ºã™ã‚‹
     * @param {number} index - electionHistoryã®æ·»å­—
     */
    function showElectionDetail(index) {
        const record = electionHistory[index];
        if (!record || !record.all) return;

        const totalVotes = record.totalVotes || record.all.reduce((sum, c) => sum + c.votes, 0) || 1;
        const dateStr = record.date;

        let html = `
        <div style="background:#f8f9fa; color:#202122; padding:20px; border-radius:5px; font-family: sans-serif; max-height:80vh; overflow-y:auto;">
            <div style="text-align:center; border-bottom:1px solid #a2a9b1; margin-bottom:10px; padding-bottom:10px;">
                <h2 style="margin:0; font-size:1.2em;">ç¬¬ ${index + 1} æœŸ å¤§çµ±é ˜é¸æŒ™ è©³ç´°åˆ†æ</h2>
                <small>${dateStr} å®Ÿæ–½</small>
            </div>

            <table style="width:100%; border-collapse: collapse; text-align:center; table-layout: fixed; margin-bottom:20px;">
                <tr>
                    ${record.all.slice(0, 3).map((cand, i) => {
            const party = getPartyInfo(cand.partyId);
            const percentage = ((cand.votes / totalVotes) * 100).toFixed(1);
            return `
                        <td style="padding:5px; vertical-align: top; border-bottom: 4px solid ${party.color};">
                            <div style="font-size:0.75em; font-weight:bold; color:#555;">${i === 0 ? 'ğŸ† å½“é¸' : 'å€™è£œè€…'}</div>
                            <div style="background:${party.color}; color:${getContrastYIQ(party.color)}; font-size:0.7em; padding:2px 5px; border-radius:3px; display:inline-block; margin-bottom:5px;">${party.name}</div>
                            <img src="${cand.icon}" style="width:60px; height:60px; border-radius:50%; border:2px solid ${party.color}; display:block; margin:0 auto; background:white;">
                            <div style="font-weight:bold; margin-top:5px; font-size:0.85em;">${cand.name}</div>
                            <div style="font-size:1.1em; font-weight:bold; margin-top:3px;">${cand.votes} <span style="font-size:0.6em;">ç¥¨</span></div>
                            <div style="font-size:0.8em; color:#666;">(${percentage}%)</div>
                        </td>`;
        }).join('')}
                </tr>
            </table>

            <h3 style="font-size:0.9em; border-left:4px solid #34495e; padding-left:8px; margin-bottom:15px;">ğŸ“Š å€™è£œè€…åˆ¥ãƒ»æ”¯æŒæ”¿å…šã®å†…è¨³åˆ†æ</h3>
            <div style="display:flex; flex-direction:column; gap:15px;">
                ${record.all.slice(0, 3).map(cand => {
            const party = getPartyInfo(cand.partyId);
            const supData = cand.supporters_data || [];

            // --- æ”¿å…šã”ã¨ã®ç¥¨æ•°ã‚’é›†è¨ˆ ---
            const partyStats = {};
            supData.forEach(s => {
                const pName = getPartyInfo(s.partyId).name;
                partyStats[pName] = (partyStats[pName] || 0) + 1;
            });

            // ç¥¨æ•°ãŒå¤šã„é †ã«ã‚½ãƒ¼ãƒˆ
            const sortedParties = Object.entries(partyStats).sort((a, b) => b[1] - a[1]);

            return `
                    <div style="background:#fff; border:1px solid #c8ccd1; border-left: 8px solid ${party.color}; padding:12px; border-radius:4px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <strong style="font-size:0.9em;">${cand.name} ã¸ã®æŠ•ç¥¨å†…è¨³</strong>
                            <span style="font-size:0.75em; color:#666;">ç·æ”¯æŒè€…: ${supData.length}å</span>
                        </div>

                        <div style="display:flex; width:100%; height:12px; border-radius:6px; overflow:hidden; background:#eee; margin-bottom:10px;">
                            ${sortedParties.map(([pName, count]) => {
                // é›†è¨ˆå¯¾è±¡ã®æ”¿å…šã®è‰²ã‚’å–å¾—
                const pColor = parties.find(p => p.name === pName)?.color || "#95a5a6";
                return `<div style="width:${(count / supData.length * 100)}%; background:${pColor};" title="${pName}: ${count}ç¥¨"></div>`;
            }).join('')}
                        </div>

                        <div style="display:flex; flex-wrap:wrap; gap:10px;">
                            ${sortedParties.map(([pName, count]) => {
                const pColor = parties.find(p => p.name === pName)?.color || "#95a5a6";
                const pRatio = ((count / supData.length) * 100).toFixed(1);
                return `
                                <div style="font-size:0.7em; display:flex; align-items:center; gap:4px;">
                                    <span style="width:8px; height:8px; border-radius:50%; background:${pColor};"></span>
                                    <span style="font-weight:bold;">${pName}:</span> ${pRatio}% 
                                    <span style="color:#888;">(${count}äºº)</span>
                                </div>`;
            }).join('')}
                        </div>

                        <div style="display:flex; flex-wrap:wrap; gap:3px; margin-top:12px; padding-top:8px; border-top:1px dashed #eee;">
                            ${supData.map(s => {
                const sParty = getPartyInfo(s.partyId);
                return `<img src="${s.icon}" title="${s.name} (${sParty.name})" style="width:18px; height:18px; border-radius:50%; border:1.5px solid ${sParty.color}; background:#f0f0f0;">`;
            }).join('')}
                        </div>
                    </div>`;
        }).join('')}
            </div>

            <div style="margin-top:20px; font-size:0.7em; color:#54595d; line-height:1.4; background:#eee; padding:10px; border-radius:4px;">
                <strong>ğŸ’¡ åˆ†æã®ãƒ’ãƒ³ãƒˆ:</strong><br>
                å€™è£œè€…è‡ªèº«ã®æ‰€å±æ”¿å…šä»¥å¤–ã‹ã‚‰ã®ï¼…ãŒé«˜ã„å ´åˆã€ä»–å…šã‹ã‚‰ã®ã€Œç¥¨ã®æµå…¥ã€ãŒèµ·ãã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚ã“ã‚ŒãŒé«˜ã„å€™è£œè€…ã¯ã€æ€æƒ³ã¨ã‹é–¢ä¿‚ãªãæ”¯æŒã•ã‚Œã‚‹ã€Œè‹±é›„ã€ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
            </div>
        </div>
    `;

        openUniversalModal("Wikipedia: é¸æŒ™ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–", html, [
            { text: "ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’é–‰ã˜ã‚‹", cb: closeUniversalModal, color: "#34495e" }
        ]);
    }
    // æ”¿å…š //
    let parties = [];

    // æ”¿å…šã®åˆæœŸç”Ÿæˆï¼ˆAI/ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
    function createParty(name, color, leader) {
        const party = {
            id: "party-" + Date.now() + Math.random().toString(36).substr(2, 5),
            name: name,
            color: color,
            leader: leader, // NPCã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            members: leader ? [leader] : [], // åˆæœŸãƒ¡ãƒ³ãƒãƒ¼
            active: true, // ç¾å­˜ãƒ•ãƒ©ã‚°
            foundedDate: new Date(gameDate),
            dissolvedDate: null,
        };
        parties.push(party);
        return party;
    }
    function openPartyMenu() {
        const activeParties = parties.filter(p => p.active);
        const dissolvedParties = parties.filter(p => !p.active);
        const hasNoParty = !profile.partyId;

        let html = `
        <div style="max-height: 70vh; overflow-y: auto; text-align: left;">
        ${hasNoParty ? `
            <div style="background: linear-gradient(135deg, #4ecca3, #45b291); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; color: white; cursor: pointer;" onclick="openCreatePartyModal()">
                <strong style="font-size: 1.2em;">ï¼‹ æ–°ã—ã„æ”¿å…šã‚’çµæˆã™ã‚‹</strong><br>
                <small>ãƒ¡ãƒ³ãƒãƒ¼ã‚’é›†ã‚ã¦ã€ã‚ãªãŸã®ç†æƒ³ã‚’æ²ã’ã‚ˆã†</small>
            </div>
        ` : ""}

        <div style="max-height: 70vh; overflow-y: auto; text-align: left;">
            <h3 style="border-left: 5px solid #4ecca3; padding-left: 10px;">ç¾å­˜ã™ã‚‹æ”¿å…š</h3>
            <div id="active-party-list" style="display: grid; gap: 10px; margin-bottom: 20px;">
                ${activeParties.map(p => renderPartyCard(p)).join('')}
            </div>

            <h3 style="border-left: 5px solid #95a5a6; padding-left: 10px; color: #7f8c8d;">æ­´å²çš„ãªæ”¿å…šï¼ˆæ¶ˆæ»…ï¼‰</h3>
            <div id="dissolved-party-list" style="display: grid; gap: 10px; opacity: 0.7;">
                ${dissolvedParties.length > 0 ? dissolvedParties.map(p => renderPartyCard(p)).join('') : "<p>ãªã—</p>"}
            </div>
        </div>
    `;

        openUniversalModal("æ”¿å…šãƒãƒ¼ã‚¿ãƒ«", html, [
            { text: "é–‰ã˜ã‚‹", cb: () => closeUniversalModal(), color: "#34495e" }
        ]);
    }

    function openCreatePartyModal() {
        const player = profile
        // æ€æƒ³ãŒè¿‘ã„ï¼ˆAffinity > 60ï¼‰NPCã‚’å€™è£œã¨ã—ã¦ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
        const potentialAllies = npcs.filter(n => !n.isPlayer && n.active !== false && calculateAffinity(profile.ideology, n.ideology) >= 60);

        let allyHtml = potentialAllies.map(n => `
        <div style="display: flex; align-items: center; gap: 10px; padding: 5px; border-bottom: 1px solid #eee;">
            <input type="checkbox" name="party-invite" value="${n.id}" id="invite-${n.id}">
            <label for="invite-${n.id}" style="display: flex; align-items: center; gap: 5px; cursor: pointer; color: ${calculateAffinity(profile.ideology, n.ideology) >= 80 ? '#2ecc71' : '#f39c12'};">
                <img src="${n.icon}" style="width:24px; height:24px; border-radius:50%;">
                <span>${n.name} (è¦ªå’Œæ€§: ${calculateAffinity(profile.ideology, n.ideology)}%)</span>
            </label>
        </div>
    `).join('');

        const content = `
        <div style="text-align: left;">
            <label>æ”¿å…šå</label>
            <input type="text" id="new-party-name" placeholder="å…šåã‚’å…¥åŠ›..." style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ccc; border-radius:4px;">
            
            <label>ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚«ãƒ©ãƒ¼</label>
            <input type="color" id="new-party-color" value="#4ecca3" style="width:100%; height:40px; margin-bottom:15px; border:none; cursor:pointer;">

            <label>åˆæœŸãƒ¡ãƒ³ãƒãƒ¼æ‹›å¾…ï¼ˆæ€æƒ³ã®è¿‘ã„äººç‰©ï¼‰</label>
            <div style="max-height: 150px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 4px; border:1px solid #ddd;">
                ${allyHtml || "<p style='color:#999;'>æ€æƒ³ã®è¿‘ã„äººç‰©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“...</p>"}
            </div>
            <p style="font-size: 0.8em; color: #666; margin-top: 5px;">â€»æ‹›å¾…ã—ã¦ã‚‚ã€ç›¸æ‰‹ã¨ã®é–¢ä¿‚æ€§ã«ã‚ˆã£ã¦ã¯æ–­ã‚‰ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
        </div>
    `;

        openUniversalModal("æ–°å…šçµæˆ", content, [
            { text: "çµå…šã™ã‚‹ï¼", cb: () => executeCreateParty(), color: "#2ecc71" },
            { text: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", cb: () => openPartyMenu(), color: "#95a5a6" }
        ]);
    }

    function executeCreateParty() {
        const name = document.getElementById('new-party-name').value;
        const color = document.getElementById('new-party-color').value;
        const player = npcs.find(n => n.isPlayer);

        if (!name) return alert("æ”¿å…šåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

        // 1. æ–°å…šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
        const newPartyId = "party-" + Date.now();
        const newParty = {
            id: newPartyId,
            name: name,
            color: color,
            leader: profile,
            members: [profile], // æœ€åˆã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿
            active: true,
            foundedDate: new Date(gameDate),
            history: []
        };

        // 2. æ‹›å¾…ã®å‡¦ç†
        const checkboxes = document.querySelectorAll('input[name="party-invite"]:checked');
        let joinedCount = 0;

        checkboxes.forEach(cb => {
            const npc = npcs.find(n => n.id === cb.value);
            if (npc) {
                // åˆ¤å®šï¼šè¦ªå’Œæ€§ãŒé«˜ãã¦ã‚‚ã€ä»Šã®å…šã¸ã®å¿ èª å¿ƒãªã©ãŒã‚ã‚Œã°æ–­ã‚‹
                const affinity = calculateAffinity(profile.ideology, npc.ideology);
                if (Math.random() * 100 < affinity) {
                    if (npc.partyId) {
                        const oldParty = parties.find(p => p.id === npc.partyId);
                        if (oldParty) {
                            // å¤ã„æ”¿å…šã®ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‹ã‚‰ã“ã®NPCã‚’æ¶ˆã™
                            oldParty.members = oldParty.members.filter(m => m.id !== npc.id);
                            console.log(`${npc.name} ãŒ ${oldParty.name} ã‚’è„±é€€ã—ã¾ã—ãŸã€‚`);
                        }
                    }

                    // ç§»ç±æˆåŠŸ
                    npc.partyId = newPartyId;
                    newParty.members.push(npc);
                    joinedCount++;
                }
            }
        });

        // 3. å…¨ä½“ãƒ‡ãƒ¼ã‚¿ã«åæ˜ 
        parties.push(newParty);
        profile.partyId = newPartyId;

        alert(`ã€Œ${name}ã€ã‚’çµæˆã—ã¾ã—ãŸï¼\n${joinedCount}åã®ãƒ¡ãƒ³ãƒãƒ¼ãŒå‚åŠ ã—ã¾ã—ãŸã€‚`);
        closeUniversalModal();
        renderPartyCard(newParty); // ç”»é¢æ›´æ–°
    }

    // æ”¿å…šã‚«ãƒ¼ãƒ‰ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderPartyCard(party) {
        return `
        <div onclick="showPartyDetail('${party.id}')" style="background: #2c3e50; border: 2px solid ${party.color}; padding: 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; position: relative;">
            <div style="position: absolute; top: 0; left: 0; width: 10px; height: 100%; background: ${party.color}; border-radius: 8px 0 0 8px;"></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-left: 10px;">
                <strong style="font-size: 1.1em; color: white;">${party.name}</strong>
                <span style="font-size: 0.8em; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px;">ãƒ¡ãƒ³ãƒãƒ¼: ${party.members.length}å</span>
            </div>
            <div style="font-size: 0.9em; color: #bdc3c7; margin-top: 5px; margin-left: 10px;">
                ä»£è¡¨: ${party.leader ? party.leader.name : "ç©ºå¸­"}
            </div>
        </div>
    `;
    }

    function showPartyDetail(partyId) {
        const party = parties.find(p => p.id === partyId);
        if (!party) return;
        const isMember = profile.partyId === party.id;
        const isPlayerLeader = party.leader && party.leader.id === profile.id;
        const hasNoParty = !profile.partyId;

        let memberHtml = party.members.map(m => `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 5px; border-bottom: 1px solid #3d4e5f;">
            <span><img src="${m.icon}" style="width:24px; vertical-align:middle; border-radius:50%;"> ${m.name}</span>
            ${isPlayerLeader && !m.isPlayer && party.active ? `<button onclick="expelMember('${party.id}', '${m.id}')" style="background:#e74c3c; color:white; border:none; border-radius:3px; cursor:pointer; font-size:0.7em;">é™¤å</button>` : ""}
        </div>
    `).join('');

        let actionButtons = [];
        if (isPlayerLeader && party.active) {
            actionButtons.push({ text: "ä»–å…šã¨åˆæµäº¤æ¸‰", cb: () => proposeMerge(party.id), color: "#f1c40f" });
            actionButtons.push({ text: "æ–°ãƒ¡ãƒ³ãƒãƒ¼æ‹›å¾…", cb: () => inviteMember(party.id), color: "#27ae60" });
        }
        actionButtons.push({ text: "æˆ»ã‚‹", cb: () => openPartyMenu(), color: "#34495e" });
        let dateInfoHtml = `<small>çµæˆ: ${party.foundedDate.getFullYear()}å¹´</small>`;
        if (!party.active && party.disbandedDate) {
            dateInfoHtml += `<br><small style="color: #e74c3c;">è§£æ•£: ${party.disbandedDate.getFullYear()}å¹´</small>`;
        }
        if (party.active) {
            if (isMember) {
                // é›¢å…šãƒœã‚¿ãƒ³ï¼ˆä»£è¡¨æœ¬äººã¯é›¢å…šã§ã¯ãªãè§£å…šãƒ—ãƒ­ã‚»ã‚¹ã«ãªã‚‹ã®ãŒä¸€èˆ¬çš„ã§ã™ãŒã€ã“ã“ã§ã¯å˜ç´”é›¢å…šï¼‰
                if (!isPlayerLeader) {
                    actionButtons.push({ text: "é›¢å…šã™ã‚‹", cb: () => leaveParty(party.id), color: "#e67e22" });
                }
                if (isPlayerLeader) {
                    actionButtons.push({ text: "è§£æ•£", cb: () => kaisan(), color: "#e67e22" });
                }
            } else if (hasNoParty) {
                // å…¥å…šç”³è«‹ãƒœã‚¿ãƒ³ï¼ˆç„¡æ‰€å±ã®å ´åˆã®ã¿ï¼‰
                actionButtons.push({ text: "å…¥å…šç”³è«‹ã‚’é€ã‚‹", cb: () => applyToParty(party.id), color: "#2ecc71" });
            }
        }
        const detailHtml = `
        <div style="text-align: left;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <div style="width: 50px; height: 50px; background: ${party.color}; border-radius: 10px;"></div>
                ${dateInfoHtml}
                </div>
            </div>
            <h4>ä»£è¡¨</h4>
            <div style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                ${party.leader ? `<img src="${party.leader.icon}" style="width:30px; border-radius:50%;"> ${party.leader.name}` : "ç©ºå¸­"}
            </div>
            <h4>ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ (${party.members.length}å)</h4>
            <div style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px;">
                ${memberHtml}
            </div>
        </div>
    `;

        openUniversalModal(`${party.name} è©³ç´°`, detailHtml, actionButtons);
    }

    function kaisan() {
        if (!confirm("æœ¬å½“ã«ã“ã®æ”¿å…šã‚’è§£æ•£ã—ã¾ã™ã‹ï¼Ÿ")) return;

        const party = parties.find(p => p.id === profile.partyId);
        if (party) {
            party.active = false;
            party.disbandedDate = new Date(gameDate);
            party.members.forEach(m => {
                if (m.id !== profile.id) m.partyId = null; // ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã¯ç„¡æ‰€å±ã«
            });
            profile.partyId = null; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚‚ç„¡æ‰€å±ã«
            alert(`${party.name} ã‚’è§£æ•£ã—ã¾ã—ãŸã€‚`);
            openPartyMenu(); // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
        }
    }

    function runPartyElection(partyId) {
        const party = parties.find(p => p.id === partyId);
        const candidates = party.members.slice(0, 3); // ä¸Šä½3åãŒç«‹å€™è£œã¨ä»®å®š

        let winner = null;
        let maxVotes = -1;

        candidates.forEach(cand => {
            let votes = 0;
            party.members.forEach(member => {
                // å…šå†…ãƒ¡ãƒ³ãƒãƒ¼ã¨ã®ç›¸æ€§ã§æŠ•ç¥¨
                const aff = calculateAffinity(member.ideology, cand.ideology);
                if (aff > 50) votes++;
            });

            if (votes > maxVotes) {
                maxVotes = votes;
                winner = cand;
            }
        });

        party.leader = winner;
        console.log(`${party.name}ã®æ–°ä»£è¡¨ã¯ ${winner.name} ã«æ±ºå®šï¼`);
    }

    function applyToParty(partyId) {
        const party = parties.find(p => p.id === partyId);
        const leader = party.leader;

        if (!leader) {
            alert("ä»£è¡¨ãŒä¸åœ¨ã®ãŸã‚ã€ç¾åœ¨ç”³è«‹ã‚’å—ã‘ä»˜ã‘ã¦ã„ã¾ã›ã‚“ã€‚");
            return;
        }

        // å‹å¥½åº¦ï¼ˆrelationshipï¼‰ã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ0ï¼‰
        const relation = calculateAffinity(profile.ideology, leader.ideology);

        // 2. å€‹äººçš„ãªå‹å¥½åº¦ï¼ˆé¢è«‡ã‚„è³„è³‚ãªã©ã§å¤‰å‹•ã™ã‚‹å€¤ï¼‰ã‚’åŠ å‘³
        const baseRelation = leader.relationship || 0;

        // æœ€çµ‚çš„ãªã€Œåˆæ ¼ã‚¹ã‚³ã‚¢ã€ï¼šè¦ªå’Œæ€§ã¨å‹å¥½åº¦ã®å¹³å‡
        const totalScore = (relation + baseRelation) / 2;
        let success = false;
        let message = "";

        if (relation < 50) {
            // 50æœªæº€ï¼šçµ¶å¯¾ç„¡ç†
            success = false;
            message = `${leader.name}ä»£è¡¨: ã€Œå›ã®ã‚ˆã†ãªè€ƒãˆã®æŒã¡ä¸»ã‚’å…¥ã‚Œã‚‹ã¤ã‚‚ã‚Šã¯ãªã„ã‚ˆã€‚ãŠå¼•ãå–ã‚Šé¡˜ãŠã†ã€‚ã€`;
        } else if (relation >= 70) {
            // 70ä»¥ä¸Šï¼šç¢ºå®Ÿ
            success = true;
            message = `${leader.name}ä»£è¡¨: ã€Œå›ãªã‚‰å¤§æ­“è¿ã ï¼æˆ‘ã€…ã®å…šã«æ–°ã—ã„é¢¨ã‚’å¹ã‹ã›ã¦ãã‚Œã€‚ã€`;
        } else {
            // 50ã€œ70ï¼šä½ç¢ºç‡ï¼ˆã“ã“ã§ã¯20%ã«è¨­å®šï¼‰
            if (Math.random() < 0.2) {
                success = true;
                message = `${leader.name}ä»£è¡¨: ã€Œå°‘ã—è¿·ã£ãŸãŒ...å›ã®ç†±æ„ã«å…ã˜ã¦å—ã‘å…¥ã‚Œã‚ˆã†ã€‚æœŸå¾…ã—ã¦ã„ã‚‹ã‚ˆã€‚ã€`;
            } else {
                success = false;
                message = `${leader.name}ä»£è¡¨: ã€Œæ‚ªãã¯ãªã„ãŒã€ã¾ã ä¿¡é ¼ãŒè¶³ã‚Šãªã„ãªã€‚ã‚‚ã£ã¨å®Ÿç¸¾ã‚’ç©ã‚“ã§ã‹ã‚‰æ¥ãŸã¾ãˆã€‚ã€`;
            }
        }

        if (success) {
            alert(message);
            profile.partyId = partyId;
            party.members.push(profile); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
            showPartyDetail(partyId); // å†æç”»
        } else {
            alert(message);
        }
    }

    // --- é›¢å…šãƒ­ã‚¸ãƒƒã‚¯ ---
    function leaveParty(partyId) {
        if (!confirm("æœ¬å½“ã«ã“ã®æ”¿å…šã‚’é›¢ã‚Œã¾ã™ã‹ï¼Ÿ")) return;

        const party = parties.find(p => p.id === partyId);
        if (party) {
            party.members = party.members.filter(m => m.id !== profile.id);
            profile.partyId = null;
            alert(`${party.name} ã‚’é›¢å…šã—ã¾ã—ãŸã€‚`);
            openPartyMenu(); // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
        }
    }

    // æ”¿å…šåˆæµã®åˆ¤å®š
    function proposeMerge(myPartyId) {
        const myParty = parties.find(p => p.id === myPartyId);
        const otherParties = parties.filter(p => p.active && p.id !== myPartyId);

        let html = `<p>åˆæµã‚’æ‰“è¨ºã™ã‚‹æ”¿å…šã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆæˆåŠŸç‡ã¯ä»£è¡¨åŒå£«ã®ç›¸æ€§ã«ä¾å­˜ã—ã¾ã™ï¼‰</p>`;
        otherParties.forEach(p => {
            const aff = calculateAffinity(myParty.leader.ideology, p.leader.ideology);
            html += `<button onclick="processMerge('${myParty.id}', '${p.id}')" style="display:block; width:100%; margin:5px 0; padding:10px; text-align:left; background:#34495e; color:white; border:none; border-radius:5px;">
            ${p.name} (ä»£è¡¨: ${p.leader.name} / ç›¸æ€§: ${aff}%)
        </button>`;
        });

        openUniversalModal("æ”¿å…šåˆæµäº¤æ¸‰", html, [{ text: "æˆ»ã‚‹", cb: () => showPartyDetail(myPartyId) }]);
    }

    function processMerge(targetId, otherId) {
        const target = parties.find(p => p.id === targetId);
        const other = parties.find(p => p.id === otherId);
        const aff = calculateAffinity(target.leader.ideology, other.leader.ideology);

        // æˆåŠŸç¢ºç‡: åŸºæœ¬3% + ç›¸æ€§ãƒœãƒ¼ãƒŠã‚¹(æœ€å¤§12%) = æœ€å¤§15% ã®ä½ç¢ºç‡è¨­å®š
        const chance = 0.03 + (aff > 80 ? (aff - 80) * 0.006 : 0);
        const success = Math.random() < chance;

        if (success) {
            alert(`${target.name} ã¨ ${other.name} ãŒåˆæµã—ã€å·¨å¤§æ”¿å…šãŒèª•ç”Ÿã—ã¾ã—ãŸï¼`);
            target.name = target.name + "ãƒ»" + other.name;
            target.members = [...target.members, ...other.members];
            other.active = false; // æ¶ˆæ»…
            other.dissolvedDate = new Date(gameDate);
            showPartyDetail(target.id);
        } else {
            alert(`${other.name} ã®ä»£è¡¨ ${other.leader.name} ã«æ‹’çµ¶ã•ã‚Œã¾ã—ãŸã€‚ã€Œæˆ‘ã€…ã®èª‡ã‚Šã¯é‡‘ã§ã¯è²·ãˆãªã„ã€ã¨ã®ã“ã¨ã§ã™ã€‚`);
        }
    }
    // æ”¿å…šçµæˆ
    // æ—¥æ¬¡å‡¦ç†ã®ä¸­ã§å‘¼ã¶
    function checkPartyCreationEvent() {
        // 200æ—¥ã«1å›ã€10%ã®ç¢ºç‡ã§ç™ºç”Ÿ (Math.random() < 0.1)
        // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³å¤‰æ•° eventCounter ãªã©ã‚’ä½œã£ã¦ç®¡ç†ã™ã‚‹ã¨æ­£ç¢ºã§ã™
        if (dayCounter % 200 === 0 && Math.random() < 0.3) {
            dayCounter = 0;
            startPartyFoundingEvent();
        }
    }

    function initializeTwoPartySystem() {
        // --- 1. æ€æƒ³è»¸ã‚’ calculateAffinity ã«åˆã‚ã›ã‚‹ ---
        const partyTemplates = [
            { name: "å…±å’Œå…š", color: "#E91D2E", ideology: { economy: 80, government: 70, diplomacy: 70 } }, // ä¿å®ˆ
            { name: "æ°‘ä¸»å…š", color: "#004684", ideology: { economy: 20, government: 30, diplomacy: 30 } }, // ãƒªãƒ™ãƒ©ãƒ«
            { name: "ãƒªãƒã‚¿ãƒªã‚¢ãƒ³å…š", color: "#FFD100", ideology: { economy: 95, government: 10, diplomacy: 50 } }
        ];

        const numParties = Math.random() < 0.1 ? 3 : 2;
        parties = [];

        for (let i = 0; i < numParties; i++) {
            const temp = partyTemplates[i];
            const leader = npcs[i]; // ãƒ©ãƒ³ãƒ€ãƒ ã§ã¯ãªããƒªã‚¹ãƒˆã®æœ€åˆã®æ–¹ã‹ã‚‰ç¢ºå®Ÿã«é¸å‡º
            const newParty = {
                id: `party_${i}`,
                name: temp.name,
                color: temp.color,
                leader: leader,
                members: [leader],
                ideology: temp.ideology,
                active: true,
                foundedDate: new Date(gameDate) // getFullYearã‚¨ãƒ©ãƒ¼å¯¾ç­–
            };
            leader.partyId = newParty.id;
            leader.title = "å…šä»£è¡¨";
            parties.push(newParty);
        }

        // --- 2. æ‰€å±ã®æŒ¯ã‚Šåˆ†ã‘ (æ‹®æŠ—ã•ã›ã‚‹ãŸã‚ã®é‡ã¿ä»˜ã‘) ---
        npcs.forEach(npc => {
            if (npc.partyId) return;

            if (Math.random() < 0.90) { // 90%ã‚’ã©ã“ã‹ã®å…šã«å…¥ã‚Œã‚‹
                let bestParty = null;
                let maxAff = -Infinity;

                parties.forEach(p => {
                    // ã“ã“ã§ã‚ãªãŸã® calculateAffinity ã‚’ä½¿ç”¨
                    const aff = calculateAffinity(npc.ideology, p.ideology);

                    // å‹¢åŠ›ãŒæ¥µç«¯ã«åã‚‰ãªã„ã‚ˆã†ã€ãƒ¡ãƒ³ãƒãƒ¼ãŒå¤šã„å…šã«ã¯ã‚ãšã‹ã«ãƒã‚¤ãƒŠã‚¹è£œæ­£(ã‚½ãƒ•ãƒˆãƒãƒ©ãƒ³ã‚¹)
                    const balanceScore = aff - (p.members.length / npcs.length * 10);

                    if (balanceScore > maxAff) {
                        maxAff = balanceScore;
                        bestParty = p;
                    }
                });

                if (bestParty) {
                    npc.partyId = bestParty.id;
                    bestParty.members.push(npc);
                }
            } else {
                npc.partyId = null; // 10%ã¯å®Œå…¨ç„¡æ‰€å±
            }
        });

        console.log(`æ”¿å…šã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†: ${parties.length}å…šä½“åˆ¶ã€‚å‡è¡¡åŒ–å‡¦ç†ã‚’é©ç”¨ã—ã¾ã—ãŸã€‚`);
    }

    function startPartyFoundingEvent() {
        // 1. ç™ºèµ·äººã‚’ãƒ©ãƒ³ãƒ€ãƒ ãªNPCã‹ã‚‰é¸ã¶
        const founder = npcs[Math.floor(Math.random() * npcs.length)];

        // 2. æ‹›å¾…å€™è£œã‚’é¸å‡º (2äººã€œ50äºº)
        const inviteCount = Math.floor(Math.random() * 49) + 2;
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å«ã‚€å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦æŠ½å‡º
        let potentialMembers = [...npcs, { isPlayer: true, name: profile.name, icon: profile.icon, id: "player" }];
        potentialMembers = potentialMembers.sort(() => 0.5 - Math.random()).slice(0, inviteCount);

        const invitedNames = potentialMembers.map(m => m.name).join(', ');
        console.log(`ç™ºèµ·äºº ${founder.name} ãŒæ–°å…šçµæˆã‚’å‘¼ã³ã‹ã‘ã¾ã—ãŸï¼æ‹›å¾…: ${invitedNames}`);

        // 3. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ‹›å¾…ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const playerInvited = potentialMembers.find(m => m.isPlayer);

        if (playerInvited) {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ã®æ‹›å¾…ãƒ¢ãƒ¼ãƒ€ãƒ«
            setGameSpeed(0);
            openUniversalModal(
                "æ–°å…šçµæˆã®èª˜ã„",
                `<div style="text-align:center;">
                <img src="${founder.icon}" style="width:80px; border-radius:50%;">
                <p><strong>${founder.name}</strong> ãŒæ–°ã—ã„æ”¿å…šã‚’ç«‹ã¡ä¸Šã’ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚</p>
                <p>ã‚ãªãŸã‚‚å‰µè¨­ãƒ¡ãƒ³ãƒãƒ¼ã¨ã—ã¦å‚åŠ ã—ã¾ã›ã‚“ã‹ï¼Ÿ</p>
                <small>ï¼ˆä»– ${potentialMembers.length - 1} åã«ã‚‚æ‹›å¾…ãŒé€ã‚‰ã‚Œã¦ã„ã¾ã™ï¼‰</small>
            </div>`,
                [
                    { text: "å‚åŠ ã™ã‚‹", cb: () => finalizeNewParty(founder, potentialMembers, true), color: "#2ecc71" },
                    { text: "æ‹’å¦ã™ã‚‹", cb: () => finalizeNewParty(founder, potentialMembers, false), color: "#e74c3c" }
                ]
            );
        } else {
            // NPCã®ã¿ã§é€²è¡Œ
            finalizeNewParty(founder, potentialMembers, false);
        }
    }

    function showlog() {

        if (document.getElementById('log-window').style.display === 'flex') {
            document.getElementById('log-window').style.display = 'none';
        } else {
            document.getElementById('log-window').style.display = 'flex';
        }
    }

    function finalizeNewParty(founder, invitees, playerJoined) {
        closeUniversalModal();

        let joinedMembers = [];

        // NPCã®æ‰¿è«¾åˆ¤å®š (ç›¸æ€§ã‚„æ€§æ ¼ã§æ±ºã‚ã‚‹ãŒã€ä»Šå›ã¯ç°¡æ˜“çš„ã«50%ã§æ‰¿è«¾)
        invitees.forEach(m => {
            if (m.isPlayer || m.id === "player") {
                if (playerJoined) joinedMembers.push(profile);
            } else {
                const aff = calculateAffinity(founder.ideology, m.ideology);
                if (Math.random() * 100 < aff) joinedMembers.push(m);
            }
        });

        // ç™ºèµ·äººã¯å¿…ãšå‚åŠ 
        if (!joinedMembers.find(m => m.id === founder.id)) {
            joinedMembers.push(founder);
        }

        if (joinedMembers.length >= 2) {
            // 2. ã€å¿…é ˆã€‘å…¨æ”¿å…šã®ãƒªã‚¹ãƒˆã‹ã‚‰è‡ªåˆ†ã‚’æ¶ˆã—å»ã‚‹ï¼ˆäºŒé‡å…šç±é˜²æ­¢ï¼‰
            joinedMembers.forEach(member => {
                parties.forEach(p => {
                    p.members = p.members.filter(em => em.id !== member.id);
                });
            });

            joinedMembers.forEach(member => {
                // ã‚‚ã—æ—¢ã«ã©ã“ã‹ã®å…šã«æ‰€å±ã—ã¦ã„ãŸã‚‰ã€ãã®å…šã®ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‹ã‚‰è‡ªåˆ†ã‚’æ¶ˆã™
                if (member.partyId) {
                    const oldParty = parties.find(p => p.id === member.partyId);
                    if (oldParty && oldParty.members) {
                        oldParty.members = oldParty.members.filter(m => m.id !== member.id);
                    }
                }
            });
            const generatedName = generateDynamicPartyName();
            let color = Math.floor(Math.random() * 16777215).toString(16);
            let colors = "#" + color.padStart(6, '0');
            const newParty = createParty(
                generatedName,
                colors,
                founder
            );

            newParty.members = joinedMembers;
            joinedMembers.forEach(m => {
                m.partyId = newParty.id; // ã“ã‚Œã§ player.partyId ãŒæ›´æ–°ã•ã‚Œã‚‹
            });
            setGameSpeed(0);

            // æ±ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’è¡¨ç¤º
            const newsHtml = `
        <div style="text-align:center; padding: 20px;">
            <div style="background:${newParty.color}; color:white; padding:15px; border-radius:10px; margin-bottom:20px;">
                <h2 style="margin:0;">${newParty.name}</h2>
                <small>çµæˆã®å£°æ˜</small>
            </div>
            <img src="${founder.icon}" style="width:80px; border-radius:50%; border:3px solid ${newParty.color};">
            <p style="font-size:1.1em; margin-top:10px;">
                <strong>${founder.name}</strong> æ°ã‚’ä¸­å¿ƒã¨ã™ã‚‹ ${joinedMembers.length} åãŒã€<br>
                æ–°ãŸãªã€Œ<strong>${newParty.name}</strong>ã€ã®çµæˆã‚’å®£è¨€ã—ã¾ã—ãŸã€‚
            </p>
            <div style="background:rgba(0,0,0,0.05); padding:10px; border-radius:5px; font-size:0.9em; color:#666;">
                ã€Œæ–°ã—ã„${newParty.name.replace('å…š', '')}ã®ç†æƒ³ã‚’æ²ã’ã‚‹ï¼ã€
            </div>
        </div>
    `;

            openUniversalModal("ğŸ“° é€Ÿå ±", newsHtml, [
                { text: "ç¢ºèª", cb: () => closeUniversalModal(), color: "#34495e" }
            ]);
        } else {
            setGameSpeed(0);
            showToast("çµæˆæ–­å¿µ", `${founder.name}ã«ã‚ˆã‚‹å…šã®çµæˆã¯ã€è³›åŒè€…ãŒé›†ã¾ã‚‰ãšå¤±æ•—ã—ã¾ã—ãŸã€‚`);
        }
    }
    // æ”¿å…šåãƒ¡ãƒ¼ã‚«ãƒ¼
    function generateDynamicPartyName() {
        const prefixes = ["è‡ªç”±", "æ—¥æœ¬", "å›½æ°‘", "é©æ–°", "æ°‘ä¸»", "åŠ´åƒ", "ä¸–ç•Œ", "ç¤¾ä¼š", "ä¿å®ˆ", "æœªæ¥", "å¹³å’Œ", "ãƒ•ãƒ­ãƒ³ãƒ†ã‚£ã‚¢", "æ–°", "æ”¹é©", "é€²æ­©", "å…±å’Œ", "å…±ã«", "ã¿ã‚“ãªã§", "ç„¡åŠ¹åŒ–", "å", "ã‚¢ãƒ³ãƒ", "SNS"];
        const middles = ["é€²æ­©", "å…±ç”Ÿ", "æ­£ç¾©", "å¹³å’Œ", "æ°‘ä¸»", "åŠ´åƒ", "ç¤¾ä¼š", "ãƒ•ãƒ­ãƒ³ãƒ†ã‚£ã‚¢", "æ”¹é©", "é€£å¸¯", "å¸Œæœ›", "ã®", "ãŒ", "ã ã£ãŸ"];
        const suffixes = ["å…š", "é€£åˆ", "ä¼š", "ã®ä¼š", "å…š", "é€£ç›Ÿ", "æ”¿æ²»é€£ç›Ÿ", "æ´¾", "å…š", "ã‚¯ãƒ©ãƒ–", "æ–°å…š", "å…š"]; // "å…š"ã‚’å¤šã‚ã«

        const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
        const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];

        // 50%ã®ç¢ºç‡ã§ãƒŸãƒ‰ãƒ«ãƒãƒ¼ãƒ ï¼ˆåè©ï¼‰ãŒå…¥ã‚‹
        if (Math.random() < 0.5) {
            const middle = middles[Math.floor(Math.random() * middles.length)];
            return prefix + middle + suffix;
        } else {
            return prefix + suffix;
        }
    }
    // è»éšŠ
    // 100æ—¥ã”ã¨ã«å®Ÿè¡Œã•ã‚Œã‚‹è»äº‹ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«
    function processMilitaryLifeCycle() {
        console.log("è»æ›´æ–°")

        npcs.forEach(n => {
            const gov = n.ideology.gov;
            const econ = n.ideology.econ;

            // åˆ¤å®šç”¨ã®ç§°å·ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            const isMilitarist = (gov > 70 && econ < 30) || (gov > 70 && econ > 70);

            if (n.military) {
                // é€€éšŠåˆ¤å®š: 200æ—¥ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹å ´åˆ20%ã§è¾ã‚ã‚‹
                const serviceDays = Math.floor((new Date(gameDate) - new Date(n.military.joinedDate)) / (1000 * 60 * 60 * 24));
                if (serviceDays >= 200 && Math.random() < 0.20) {
                    n.military = null;
                }
            } else {
                // å…¥éšŠåˆ¤å®š: è»å›½/æ¨©å¨ã¯60%ã€ãã®ä»–ã¯25%
                const joinChance = isMilitarist ? 0.60 : 0.25;
                if (Math.random() < joinChance) {
                    const branches = ["é™¸è»", "æµ·è»", "ç©ºè»"];
                    n.military = {
                        branch: branches[Math.floor(Math.random() * branches.length)],
                        joinedDate: new Date(gameDate),
                        power: Math.floor(Math.random() * 50) + 10 // å€‹äººã®å½±éŸ¿åŠ›
                    };
                }
            }
        });
    }
    let stats
    function getMilitaryStats() {
        stats = {
            é™¸è»: { members: [], totalPower: 0, color: "#5d6d31" },
            æµ·è»: { members: [], totalPower: 0, color: "#2980b9" },
            ç©ºè»: { members: [], totalPower: 0, color: "#7f8c8d" },
            totalSoldiers: 0
        };

        npcs.forEach(n => {
            if (n.military) {
                stats[n.military.branch].members.push(n);
                stats[n.military.branch].totalPower += n.military.power;
                stats.totalSoldiers++;
            }
        });

        // å„è»ã®ãƒªãƒ¼ãƒ€ãƒ¼ã‚’é¸å‡ºï¼ˆãã®è»ã§æœ€ã‚‚å½±éŸ¿åŠ›ãŒé«˜ã„NPCï¼‰
        ["é™¸è»", "æµ·è»", "ç©ºè»"].forEach(b => {
            stats[b].leader = stats[b].members.sort((a, b) => b.military.power - a.military.power)[0];
        });

        // ç·è»ãƒªãƒ¼ãƒ€ãƒ¼ï¼ˆå…¨è»ã§æœ€ã‚‚ãƒ‘ãƒ¯ãƒ¼ãŒã‚ã‚‹NPCï¼‰
        const allMilitary = [...stats.é™¸è».members, ...stats.æµ·è».members, ...stats.ç©ºè».members];
        stats.grandLeader = allMilitary.sort((a, b) => b.military.power - a.military.power)[0];

        return stats;
    }
    function showMilitaryModal() {
        const stats = getMilitaryStats();

        let html = `
    <div style="background:#2c3e50; color:#ecf0f1; padding:20px; border-radius:8px; font-family:sans-serif;">
        <div style="text-align:center; border-bottom:2px solid #34495e; padding-bottom:15px; margin-bottom:20px;">
            <h2 style="margin:0; letter-spacing:2px;">ğŸ›¡ï¸ å›½å®¶æœ€é«˜è»äº‹ä¼šè­°</h2>
            <small>å…¨è»ç·æ•°: ${stats.totalSoldiers} å / å›½å†…å½±éŸ¿åŠ›: ${((stats.totalSoldiers / npcs.length) * 100).toFixed(1)}%</small>
        </div>

        ${stats.grandLeader ? `
        <div style="background:#c0392b; padding:15px; border-radius:5px; margin-bottom:20px; display:flex; align-items:center; gap:15px; border:2px solid #e74c3c;">
            <img src="${stats.grandLeader.icon}" style="width:60px; height:60px; border-radius:50%; border:2px solid white;">
            <div>
                <div style="font-size:0.8em; opacity:0.8;">çµ±åˆå‚è¬€æœ¬éƒ¨ ç·è»ãƒªãƒ¼ãƒ€ãƒ¼</div>
                <div style="font-size:1.2em; font-weight:bold;">${stats.grandLeader.name}</div>
                <div style="font-size:0.7em;">æ‰€å±: ${stats.grandLeader.military.branch}</div>
            </div>
            <div style="margin-left:auto; text-align:right;">
                <div style="font-size:0.7em;">ã‚¯ãƒ¼ãƒ‡ã‚¿ãƒ¼è­¦æˆ’</div>
                <div style="font-size:1.2em; font-weight:bold;">            ${stats.é™¸è».members.length > stats.æµ·è».members.length && stats.é™¸è».members.length > stats.ç©ºè».members.length
                    ? 'ğŸš¨ é«˜' : 'âœ… ä½'}</div>
            </div>
        </div>
        ` : ''}

        <div style="display:flex; height:30px; border-radius:15px; overflow:hidden; margin-bottom:25px; border:1px solid #fff;">
            ${["é™¸è»", "æµ·è»", "ç©ºè»"].map(b => {
                        const width = stats.totalSoldiers ? (stats[b].members.length / stats.totalSoldiers) * 100 : 0;
                        return `<div style="width:${width}%; background:${stats[b].color}; transition: width 0.5s;" title="${b}"></div>`;
                    }).join('')}
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
            ${["é™¸è»", "æµ·è»", "ç©ºè»"].map(b => {
                        const branch = stats[b];
                        const leader = branch.leader;
                        const powerRatio = stats.totalSoldiers ? (branch.members.length / stats.totalSoldiers * 100).toFixed(0) : 0;

                        return `
                <div style="background:#34495e; padding:10px; border-radius:5px; border-top:5px solid ${branch.color};">
                    <div style="font-weight:bold; border-bottom:1px solid #555; margin-bottom:8px;">${b}</div>
                    <div style="font-size:0.7em; margin-bottom:10px;">
                        å‹¢åŠ›æ¯”: ${powerRatio}%<br>
                        äººå“¡: ${branch.members.length}å
                    </div>
                    ${leader ? `
                        <div style="text-align:center;">
                            <img src="${leader.icon}" style="width:40px; height:40px; border-radius:50%; background:#eee;">
                            <div style="font-size:0.75em; font-weight:bold; margin-top:5px;">${leader.name.split(' ')[0]}</div>
                            <small style="font-size:0.6em; color:#bdc3c7;">æœ€é«˜æŒ‡æ®å®˜</small>
                        </div>
                    ` : '<small>æŒ‡æ®å®˜ä¸åœ¨</small>'}
                </div>`;
                    }).join('')}
        </div>

        <div style="margin-top:20px; font-size:0.7em; background:rgba(0,0,0,0.2); padding:10px; border-radius:4px;">
            <strong>ğŸ“Œ å‹¢åŠ›æ¦‚æ³:</strong><br>
            ${stats.é™¸è».members.length > stats.æµ·è».members.length && stats.é™¸è».members.length > stats.ç©ºè».members.length
                ? "ç¾åœ¨ã€é™¸è»ãŒå›½å†…ã®æ²»å®‰æ¨©é™ã‚’æŒæ¡ã—ã¦ã„ã¾ã™ã€‚ã‚¯ãƒ¼ãƒ‡ã‚¿ãƒ¼ã¸ã®è­¦æˆ’ãŒå¿…è¦ã§ã™ã€‚"
                : "ä¸‰è»ã®å‡è¡¡ãŒä¿ãŸã‚Œã¦ã„ã¾ã™ã€‚æ–‡æ°‘çµ±åˆ¶ã¯æ¯”è¼ƒçš„å®¹æ˜“ã§ã™ã€‚"}
        </div>
    </div>
    `;

        openUniversalModal("è»äº‹æƒ…å ±ãƒ»å‹¢åŠ›å›³", html, [
            { text: "é–‰ã˜ã‚‹", cb: closeUniversalModal, color: "#7f8c8d" }
        ]);
    }
    // è­°ä¼šé¸æŒ™
    function updateParliamentUI() {
        const container = document.getElementById('parliament-status-container');
        if (!container) return;

        // é¸æŒ™å½“æ—¥ã‹ã©ã†ã‹
        const isElectionDay = parliamentElectionCounter <= 0;

        let html = `
    <div style="background:#174777; border:1px solid #a2a9b1; padding:10px; margin-top:10px; font-size:0.9em; color:white;">
        <strong>ğŸ›ï¸ è­°ä¼šé¸æŒ™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</strong>
        <div style="margin:5px 0;">${isElectionDay ? '<span style="color:#f1c40f;">æœ¬æ—¥æŠ•é–‹ç¥¨æ—¥</span>' : `ã‚ã¨ ${parliamentElectionCounter}æ—¥`}</div>
    `;

        if (isPlayerRunningForParliament) {
            html += `<div style="color:#2ecc71; font-weight:bold;">âœ… ç«‹å€™è£œæ¸ˆã¿</div>`;
        } else if (isElectionDay) {
            html += `<div style="color:#bdc3c7; font-size:0.8em;">â€»å—ä»˜çµ‚äº†</div>`;
        } else if (isPlayerRunningForPresident) {
            html += `<div style="color:#bdc3c7; font-size:0.8em;">â€»å¤§çµ±é ˜é¸ã«å‡ºé¦¬ä¸­ã®ãŸã‚ç«‹å€™è£œä¸å¯</div>`;
        } else {
            html += `
        <button onclick="runForParliament()" 
            style="width:100%; background:#3366cc; color:white; border:none; padding:8px; cursor:pointer; border-radius:2px; font-weight:bold;">
            è­°ä¼šé¸æŒ™ã«ç«‹å€™è£œã™ã‚‹
        </button>`;
        }

        html += `</div>`;
        container.innerHTML = html;
    }
    function runForParliament() {
        if (parliamentElectionCounter <= 0) return showToast("ä¸å¯", "é¸æŒ™å½“æ—¥ã®å±Šå‡ºã¯ã§ãã¾ã›ã‚“ã€‚");
        if (isPlayerRunningForPresident) return showToast("ä¸å¯", "å¤§çµ±é ˜é¸ã¨é‡è¤‡ç«‹å€™è£œã¯ã§ãã¾ã›ã‚“ã€‚");

        isPlayerRunningForParliament = true;
        updateParliamentUI(); // å³åº§ã«ãƒœã‚¿ãƒ³ã‚’æ¶ˆã™
        showToast("å±Šå‡ºå—ç†", "è­°ä¼šç·é¸æŒ™ã¸ã®ç«‹å€™è£œãŒå—ç†ã•ã‚Œã¾ã—ãŸã€‚");
    }

    // è­°ä¼šé¸æŒ™ãƒ»æŠ•ç¥¨ç³»
    let parliamentSize = null
    function startParliamentElection() {
        setGameSpeed(0); // æ™‚é–“ã‚’æ­¢ã‚ã‚‹


        // 1. å®šæ•°ã®æ±ºå®šï¼ˆç·äººæ•°ã®åŠåˆ†ã€æœ€å¤§100ç¨‹åº¦ï¼‰
        const totalPopulation = npcs.length + 1;
        parliamentSize = Math.floor(totalPopulation / 3);
        const targetCandidateCount = Math.floor(parliamentSize * 1.8);

        let electionCandidates = [];

        // --- æ—¢å­˜ã®ã€Œæ„æ¬²ã‚ã‚‹å±¤ã€ã®æŠ½å‡º ---
        const potentialNpcs = npcs.filter(npc => {
            const isMilitary = npc.military || (npc.job && (npc.job.includes("è»") || npc.job.includes("å…µ")));
            return !isMilitary;
        });

        potentialNpcs.forEach(npc => {
            let runRate = 0.05;
            if (npc.title === "è­°å“¡") runRate = 0.8; // ç¾è·ã¯ã»ã¼ç¢ºå®Ÿã«å‡ºã‚‹
            if (npc.title === "å…ƒè­°å“¡") runRate = 0.4;

            // æ‰€å±æ”¿å…šãŒã‚ã‚‹å ´åˆã€å…šã®å‹¢åŠ›æ‹¡å¤§ã®ãŸã‚ã«å°‘ã—å‡ºã‚„ã™ããªã‚‹
            if (npc.partyId) runRate += 0.1;

            if (Math.random() < runRate) {
                const party = parties.find(p => p.id === npc.partyId);
                electionCandidates.push({
                    ...npc,
                    displayParty: party ? party.name : "ç„¡æ‰€å±",
                    partyColor: party ? party.color : "#95a5a6",
                    votes: 0
                });
            }
        });

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒã‚§ãƒƒã‚¯
        if (isPlayerRunningForParliament) {
            const pParty = parties.find(p => p.id === profile.partyId);
            electionCandidates.push({
                ...profile, id: "player",
                displayParty: pParty ? pParty.name : "ç„¡æ‰€å±",
                partyColor: pParty ? pParty.color : "#95a5a6", votes: 0
            });
        }

        // --- ğŸš€ ã€æ–°è¦ã€‘å®šå“¡å‰²ã‚Œé˜²æ­¢ãƒ»ç«¶äº‰ç‡ç¶­æŒãƒ­ã‚¸ãƒƒã‚¯ ---
        // ç«‹å€™è£œè€…ãŒç›®æ¨™æ•°ã«è¶³ã‚Šãªã„å ´åˆã€ä¸€èˆ¬NPCã‹ã‚‰ã€Œæ–°äººã€ã‚’ã‚¹ã‚«ã‚¦ãƒˆã—ã¦è£œå……
        // --- ğŸš€ å®šå“¡å‰²ã‚Œé˜²æ­¢ãƒ»ç«¶äº‰ç‡ç¶­æŒãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå…šç±å„ªå…ˆç‰ˆï¼‰ ---
        if (electionCandidates.length < targetCandidateCount) {
            const needed = targetCandidateCount - electionCandidates.length;

            // ã¾ã ç«‹å€™è£œã—ã¦ã„ãªã„NPCã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const nonCandidates = potentialNpcs.filter(n => !electionCandidates.find(c => c.id === n.id));

            // ã€é‡è¦ã€‘ã‚½ãƒ¼ãƒˆé †ã‚’ã€Œå…šç±ã‚ã‚Š(partyIdãŒå­˜åœ¨ã™ã‚‹)ã€ã‚’æœ€å„ªå…ˆã«å¤‰æ›´
            nonCandidates.sort((a, b) => {
                const aHasParty = a.partyId ? 1 : 0;
                const bHasParty = b.partyId ? 1 : 0;

                // 1. ã¾ãšå…šç±ã®æœ‰ç„¡ã§æ¯”è¼ƒ (1 - 0 = 1 ãªã®ã§ aHasParty ãŒé«˜ã„æ–¹ã‚’å„ªå…ˆ)
                if (bHasParty !== aHasParty) return bHasParty - aHasParty;

                // 2. åŒã˜æ¡ä»¶ãªã‚‰ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼‰
                return 0.5 - Math.random();
            });

            // è£œå……å®Ÿè¡Œ
            for (let i = 0; i < Math.min(needed, nonCandidates.length); i++) {
                const npc = nonCandidates[i];
                const party = parties.find(p => p.id === npc.partyId);
                electionCandidates.push({
                    ...npc,
                    displayParty: party ? party.name : "ç„¡æ‰€å±",
                    partyColor: party ? party.color : "#95a5a6",
                    votes: 0,
                    isNewbie: true
                });
            }
        }

        showParliamentVotingModal(electionCandidates, parliamentSize);
    }
    async function showParliamentVotingModal(candidates, size) {
        openUniversalModal("ğŸ—³ï¸ æŠ•ç¥¨é›†è¨ˆä¸­...", `
        <div style="text-align:center;">
            <div id="polling-status" style="font-size:1.5em; font-weight:bold; margin-bottom:10px;">0 / ${npcs.length + 1} ç¥¨é›†è¨ˆæ¸ˆ</div>
            <div style="width:100%; height:10px; background:#eee; border-radius:5px; overflow:hidden;">
                <div id="polling-bar" style="width:0%; height:100%; background:#3498db; transition:width 0.1s;"></div>
            </div>
            <p id="latest-vote" style="font-size:0.8em; color:#666; margin-top:10px;">æœ‰æ¨©è€…ãŒæŠ•ç¥¨æ‰€ã«ç§»å‹•ä¸­...</p>
        </div>
    `, []);

        for (let i = 0; i < npcs.length; i++) {
            const npc = npcs[i];
            let bestAff = -1;
            let choice = null;

            candidates.forEach(cand => {
                const aff = calculateAffinity(npc.ideology, cand.ideology);
                if (aff > bestAff) { bestAff = aff; choice = cand; }
            });

            if (choice) {
                choice.votes++;
                // 5ç¥¨ã«1å›ãã‚‰ã„è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆé€Ÿã™ãã‚‹ã¨è¦‹ãˆãªã„ãŸã‚ï¼‰
                if (i % 5 === 0 || i === npcs.length - 1) {
                    document.getElementById('polling-status').innerText = `${i + 1} / ${npcs.length + 1} ç¥¨é›†è¨ˆæ¸ˆ`;
                    document.getElementById('polling-bar').style.width = `${((i + 1) / npcs.length) * 100}%`;
                    document.getElementById('latest-vote').innerText = `æœ€æ–°ã®æŠ•ç¥¨: ${npc.name} â” ${choice.name} (${choice.displayParty})`;
                    await new Promise(r => setTimeout(r, 10)); // é›†è¨ˆã®ã€Œã‚¿ãƒ¡ã€ã‚’ä½œã‚‹
                }
            }
        }
        const modalContent = `
        <div style="padding:10px;">
            <p style="margin-bottom:10px;">å®šæ•°: <strong>${size} è­°å¸­</strong> / æœ‰æ¨©è€…: ${npcs.length + 1} å</p>
            <input type="text" id="candSearch" placeholder="å€™è£œè€…åãƒ»æ”¿å…šåã§æ¤œç´¢..." 
                style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px;">
            <div id="candList" style="max-height:400px; overflow-y:auto; border:1px solid #eee; background:#fff;">
                </div>
        </div>
    `;

        openUniversalModal("ğŸ›ï¸ è­°ä¼šç·é¸æŒ™ æŠ•é–‹ç¥¨", modalContent, []);

        const updateList = (filter = "") => {
            const list = document.getElementById('candList');
            list.innerHTML = candidates
                .filter(c => c.name.includes(filter) || c.displayParty.includes(filter))
                .map(c => `
                <div style="display:flex; align-items:center; padding:8px; border-bottom:1px solid #eee;">
                    <img src="${c.icon}" style="width:30px; height:30px; border-radius:50%; margin-right:10px;">
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:0.9em;">${c.name}</div>
                        <div style="font-size:0.7em; color:${c.partyColor};">${c.displayParty}</div>
                    </div>
                    <button onclick="processParliamentBallot('${c.id}')" 
                        style="padding:5px 10px; cursor:pointer; background:#2ecc71; color:white; border:none; border-radius:3px;">æŠ•ç¥¨</button>
                </div>
            `).join('');
        };

        document.getElementById('candSearch').oninput = (e) => updateList(e.target.value);
        updateList();

        // å†…éƒ¨é–¢æ•°ã¨ã—ã¦ã€æŠ•ç¥¨å¾Œã®é›†è¨ˆã¸
        window.processParliamentBallot = (targetId) => {
            closeUniversalModal();
            finalizeParliamentElection(candidates, targetId, size);
        };
    }
    let lastParliamentSeats = {};
    async function finalizeParliamentElection(candidates, playerVoteId, parliamentSize) {
        // --- 1. æŠ•ç¥¨é›†è¨ˆ (æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯) ---
        npcs.forEach(npc => {
            let bestAff = -1; let choice = null;
            if (npc.termCount === undefined) npc.termCount = 0;
            candidates.forEach(cand => {
                const aff = calculateAffinity(npc.ideology, cand.ideology);
                if (aff > bestAff) { bestAff = aff; choice = cand; }
            });
            if (choice) choice.votes++;
        });
        const pChoice = candidates.find(c => c.id === playerVoteId);
        if (pChoice) pChoice.votes++;

        // --- 2. ãƒ‰ãƒ³ãƒˆæ–¹å¼ (æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯) ---
        const partiesList = parties.filter(p => p.active);
        let partyTotalVotes = {};
        partiesList.forEach(p => {
            const pCands = candidates.filter(c => c.partyId === p.id).sort((a, b) => b.votes - a.votes);
            p.tempCandidates = pCands;
            partyTotalVotes[p.id] = pCands.reduce((sum, c) => sum + c.votes, 0);
        });

        const independentCandidates = candidates.filter(c => !c.partyId || c.partyId === "independents").sort((a, b) => b.votes - a.votes);
        partyTotalVotes["independents"] = independentCandidates.reduce((sum, c) => sum + c.votes, 0);

        let dHondtTable = [];
        partiesList.forEach(p => {
            for (let i = 1; i <= p.tempCandidates.length; i++) {
                dHondtTable.push({
                    party: p,
                    score: partyTotalVotes[p.id] / i,
                    member: p.tempCandidates[i - 1]
                });
            }
        });
        independentCandidates.forEach(cand => {
            dHondtTable.push({
                party: { name: "ç„¡æ‰€å±", color: "#95a5a6", id: "independents" },
                score: cand.votes,
                member: cand
            });
        });

        dHondtTable.sort((a, b) => b.score - a.score);
        const winningSeats = dHondtTable.slice(0, parliamentSize);

        // --- 3. UIã®æº–å‚™ ---
        openUniversalModal("ğŸ›ï¸ è­°ä¼šç·é¸æŒ™ é–‹ç¥¨é€Ÿå ±", `
            <div style="text-align:center; max-height:80vh; overflow-y:auto;">
                <div style="position:relative; margin-top:25px;">
                    <div class="majority-label" style="font-size:0.7em; position:absolute; top:-15px; left:50%; transform:translateX(-50%);">éåŠæ•° (${Math.ceil(parliamentSize / 2) + 1})</div>
                    <div class="majority-line" style="position:absolute; left:50%; top:0; bottom:0; width:2px; background:rgba(231, 76, 60, 0.5); z-index:10;"></div>
                    <div id="election-bar" style="display:flex; width:100%; height:20px; background:#eee; border-radius:10px; overflow:hidden;"></div>
                </div>
                <h2 id="live-count" style="margin:10px 0;">0 / ${parliamentSize} è­°å¸­ç¢ºå®š</h2>
                <div id="elected-list" style="margin-top:20px;"></div>
            </div>
        `, []);

        const electedListDiv = document.getElementById('elected-list');
        const electionBarDiv = document.getElementById('election-bar');
        let partyContainers = {};
        let partyBars = {};
        let currentSeats = [];

        // --- 4. 1è­°å¸­ã”ã¨ã«ç¢ºå®šã•ã›ã‚‹ (è¶…è»½é‡ç‰ˆ) ---
        for (let i = 0; i < winningSeats.length; i++) {
            const seat = winningSeats[i];
            if (!seat || !seat.member) continue;

            await new Promise(r => setTimeout(r, 3)); // å°‘ã—é«˜é€ŸåŒ–

            const winner = seat.member;
            currentSeats.push(seat);
            winner.title = "è­°å“¡";

            // æ”¿å…šã‚³ãƒ³ãƒ†ãƒŠã®ä½œæˆ
            if (!partyContainers[seat.party.id]) {
                const container = document.createElement('div');
                container.style.cssText = `margin-bottom:10px; padding:5px; border-left:3px solid ${seat.party.color}; background:rgba(0,0,0,0.02); text-align:left;`;
                container.innerHTML = `<div style="font-weight:bold; font-size:0.75em; color:${seat.party.color};">${seat.party.name}</div><div class="member-icons"></div>`;
                electedListDiv.appendChild(container);
                partyContainers[seat.party.id] = container.querySelector('.member-icons');

                // ãƒãƒ¼è¦ç´ ã®ä½œæˆ
                const bar = document.createElement('div');
                bar.style.cssText = `height:100%; background:${seat.party.color}; transition:width 0.2s ease-out; width:0%;`;
                electionBarDiv.appendChild(bar);
                partyBars[seat.party.id] = bar;
            }

            // ã‚¢ã‚¤ã‚³ãƒ³è¦ç´ ã®è¿½åŠ  (ä½è§£åƒåº¦è¨­å®š)
            const seatEl = document.createElement('div');
            seatEl.style.cssText = "display:inline-block; margin:2px; text-align:center; width:45px; vertical-align:top;";
            seatEl.innerHTML = `
                <img src="${winner.icon}" 
                     loading="lazy" 
                     decoding="async" 
                     style="width:30px; height:30px; border-radius:50%; border:1px solid ${seat.party.color}; background:#fff; object-fit:cover;"
                     onclick="alert(${winner.name}: ${winner.votes}ç¥¨)">
                <div style="font-size:10px; color:#ffffff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${winner.votes}ç¥¨</div>
            `;
            partyContainers[seat.party.id].appendChild(seatEl);

            // ãƒãƒ¼ã®å¹…æ›´æ–°
            const summary = {};
            currentSeats.forEach(s => summary[s.party.id] = (summary[s.party.id] || 0) + 1);
            Object.keys(partyBars).forEach(pid => {
                partyBars[pid].style.width = `${((summary[pid] || 0) / parliamentSize) * 100}%`;
            });

            document.getElementById('live-count').innerText = `${i + 1} / ${parliamentSize} è­°å¸­ç¢ºå®š`;
        }

        // 5. äº‹å¾Œå‡¦ç†ãƒ»çµ±è¨ˆ (æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯)
        candidates.forEach(c => {
            if (!winningSeats.find(w => w.member.id === c.id)) {
                c.title = c.title === "è­°å“¡" ? "å…ƒè­°å“¡" : (c.title || "ä¸€èˆ¬");
            }
        });

        // --- ğŸš€ ã€æ–°è¦ã€‘ä¸å…šãƒ»é‡å…šã®åˆ¤å®šã¨ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ— ---
        const seatCounts = {}; // å„å…šã®è­°å¸­æ•°
        winningSeats.forEach(s => {
            seatCounts[s.party.name] = (seatCounts[s.party.name] || 0) + 1;
        });

        const partyOnlyResults = Object.entries(seatCounts)
            .filter(([name]) => name !== "ç„¡æ‰€å±") // ç„¡æ‰€å±ã‚’å€™è£œã‹ã‚‰å¤–ã™
            .sort((a, b) => b[1] - a[1]); // è­°å¸­æ•°é †ã«ã‚½ãƒ¼ãƒˆ

        // --- ğŸš€ ã€æ–°è¦ã€‘å½“é¸ãƒ»è½é¸ãƒ»å¼•é€€ã®ä»•åˆ†ã‘ ---
        const electedIds = new Set(winningSeats.map(s => s.member.id));
        const candidateIds = new Set(candidates.map(c => c.id));

        const report = {
            newlyElected: [], // åˆå½“é¸
            reElected: [],    // å†é¸ï¼ˆ2æœŸä»¥ä¸Šï¼‰
            defeated: [],     // è½é¸ï¼ˆç¾è·ã ã£ãŸãŒè½ã¡ãŸï¼‰
            out: [],        // è½é¸ï¼ˆç¾è·ã§ã¯ãªã„ãŒå‡ºã¦è½ã¡ãŸï¼‰
            retired: []       // ä¸å‡ºé¦¬ï¼ˆç¾è·ã ã£ãŸãŒå‡ºãªã‹ã£ãŸï¼‰
        };

        // å…¨NPCã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦çŠ¶æ…‹ã‚’æ›´æ–°
        npcs.forEach(npc => {
            const isWinner = electedIds.has(npc.id);
            const wasIncumbent = (npc.title === "è­°å“¡");
            const ranInElection = candidateIds.has(npc.id);

            if (isWinner) {
                npc.termCount++; // å½“é¸å›æ•°ã‚¢ãƒƒãƒ—
                if (npc.termCount === 1) {
                    report.newlyElected.push(`${npc.name} (åˆ)`);
                } else {
                    report.reElected.push(`${npc.name} (${npc.termCount}æœŸ)`);
                }
                npc.title = "è­°å“¡";
            } else {
                if (ranInElection && !wasIncumbent) {
                    npc.title = "è½é¸è€…";
                    if (!wasIncumbent) report.out.push(npc.name);
                }
                if (wasIncumbent && ranInElection) {
                    report.defeated.push(npc.name);
                    npc.title = "å…ƒè­°å“¡";
                } else if (wasIncumbent && !ranInElection) {
                    report.retired.push(npc.name);
                    npc.termCount = 0; // å¼•é€€ã—ãŸè­°å“¡ã¯å½“é¸å›æ•°ãƒªã‚»ãƒƒãƒˆ
                    npc.title = "å…ƒè­°å“¡ï¼ˆå¼•é€€ï¼‰";
                }
            }
        });

        if (isPlayerRunningForParliament) {

            const playerObj = (typeof player !== 'undefined') ? player : profile; // ç’°å¢ƒã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„
            const isPlayerWinner = electedIds.has("player") || electedIds.has(playerObj.id);
            const wasPlayerIncumbent = (playerObj.title === "è­°å“¡");

            if (isPlayerWinner) {
                playerObj.termCount = (playerObj.termCount || 0) + 1; // å½“é¸å›æ•°ã‚¢ãƒƒãƒ—
                if (playerObj.termCount === 1) {
                    report.newlyElected.push(`${playerObj.name} (åˆ) â˜…`);
                } else {
                    report.reElected.push(`${playerObj.name} (${playerObj.termCount}æœŸ) â˜…`);
                }
                playerObj.title = "è­°å“¡";
            } else {
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè½é¸ã—ãŸå ´åˆ
                if (wasPlayerIncumbent) {
                    report.defeated.push(`${playerObj.name} â˜…`);
                    playerObj.title = "å…ƒè­°å“¡";
                } else {
                    report.out.push(`${playerObj.name} â˜…`);
                    playerObj.title = "è½é¸è€…";
                }
            }
        } else {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç«‹å€™è£œã—ã¦ã„ãªã„å ´åˆã€ç¾è·ã ã£ãŸã‚‰å¼•é€€æ‰±ã„ã«ã™ã‚‹
            const playerObj = (typeof player !== 'undefined') ? player : profile; // ç’°å¢ƒã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„
            if (playerObj.title === "è­°å“¡") {
                report.retired.push(`${playerObj.name} â˜…`);
                playerObj.termCount = 0; // å¼•é€€ã—ãŸè­°å“¡ã¯å½“é¸å›æ•°ãƒªã‚»ãƒƒãƒˆ
                playerObj.title = "å…ƒè­°å“¡ï¼ˆå¼•é€€ï¼‰";
            }
        }

        // è­°å¸­æ•°é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ç¬¬1å…šã‚’ç‰¹å®š
        const sortedPartyResults = Object.entries(seatCounts).sort((a, b) => b[1] - a[1]);
        const rulingPartyName = sortedPartyResults[0][0]; // ç¬¬1å…šã‚’ä¸å…šã¨ã™ã‚‹
        const rulingSeats = sortedPartyResults[0][1];

        const oppositionParties = sortedPartyResults.slice(1); // 2ä½ä»¥ä¸‹ã®å…š
        const totalOppositionSeats = oppositionParties.reduce((sum, p) => sum + p[1], 0);

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç«‹å ´ã‚’åˆ¤å®š
        const playerParty = parties.find(p => p.id === profile.partyId);
        const playerPartyName = playerParty ? playerParty.name : "ç„¡æ‰€å±";
        const isPlayerInRuling = (playerPartyName === rulingPartyName);

        // è¨˜éŒ²ç”¨ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
        const sortedCandidates = [...candidates].sort((a, b) => b.votes - a.votes);
        const lowestWinner = winningSeats[winningSeats.length - 1];
        const topVoter = sortedCandidates[0];
        const myPartySeats = winningSeats.filter(s => s.party.id === (profile.partyId)).length;
        const isMajority = myPartySeats > (parliamentSize / 2);

        const stats = {
            date: new Date(gameDate),
            seats: parliamentSize,
            mvp: topVoter.name,
            mvpVotes: topVoter.votes,
            luckyWinner: lowestWinner.member.name,
            luckyVotes: lowestWinner.member.votes,
            partyDetails: {},
            partyBases: {} // äº’æ›æ€§ã®ãŸã‚ã«ä¿æŒ
        };

        // å…¨å¾—ç¥¨æ•°ã®åˆè¨ˆï¼ˆå¾—ç¥¨ç‡è¨ˆç®—ç”¨ï¼‰
        let totalSystemVotes = 0;

        const activeParties = parties.filter(p => p.active);

        activeParties.forEach(p => {
            // 1. ã“ã®æ”¿å…šã®å½“é¸è€…æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const currentSeats = winningSeats.filter(s => s.party.id === p.id).length;
            const isPlayerInThisParty = (profile.partyId === p.id);
            const isPlayerWinner = electedIds.has("player") || electedIds.has(profile.id);

            // winningSeatsã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã®ã¿ã€è¡¨ç¤ºä¸Šã®è­°å¸­ã‚’èª¿æ•´
            const playerInSeats = winningSeats.some(s => s.member.id === "player" || s.member.id === profile.id);
            if (isPlayerInThisParty && isPlayerWinner && !playerInSeats) {
                currentSeats += 1;
            }

            // 2. å‰å›ã®è­°å¸­æ•°ã¨æ¯”è¼ƒ
            const lastSeats = lastParliamentSeats[p.name] || 0;

            // 3. ã“ã®æ”¿å…šã®å€™è£œè€…å…¨å“¡ã®å¾—ç¥¨åˆè¨ˆ
            let partyTotalVotes = candidates
                .filter(c => c.partyId === p.id)
                .reduce((sum, c) => sum + (c.votes || 0), 0);

            totalSystemVotes += partyTotalVotes;

            // 4. è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            stats.partyDetails[p.name] = {
                seats: currentSeats,
                change: currentSeats - lastSeats,
                votes: partyTotalVotes,
                leaderName: p.leader ? p.leader.name : "ä¸æ˜",
                leaderIcon: p.leader ? p.leader.icon : ""
            };

            // 5. è­°å¸­æ•°ã®ã¿ã®ç°¡æ˜“ãƒ‡ãƒ¼ã‚¿ï¼ˆ2é‡åŠ ç®—ã‚’é¿ã‘ã‚‹ãŸã‚ã“ã“ã§ä»£å…¥ï¼‰
            stats.partyBases[p.name] = currentSeats;
        });

        // å…¨ä½“ã®å¾—ç¥¨ç‡ã‚’å„å…šã«å‰²ã‚ŠæŒ¯ã‚‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        Object.keys(stats.partyDetails).forEach(name => {
            const p = stats.partyDetails[name];
            p.voteRate = totalSystemVotes > 0 ? ((p.votes / totalSystemVotes) * 100).toFixed(2) : "0.00";
        });


        parhistory.push(stats);

        const seatChanges = {};
        const currentPartyNames = Object.keys(stats.partyBases);

        currentPartyNames.forEach(name => {
            const current = stats.partyBases[name] || 0;
            const last = lastParliamentSeats[name] || 0; // å‰å›ã®å€¤ã‚’å‚ç…§
            const change = current - last;

            // å¤‰åŒ–ãŒã‚ã‚Œã°è¡¨ç¤ºã€ãªã‘ã‚Œã°Â±0
            seatChanges[name] = change > 0 ? `(+${change})` : (change < 0 ? `(${change})` : " (Â±0)");
        });

        // æ¬¡å›ã®ãŸã‚ã«ä»Šå›ã®è­°å¸­æ•°ã‚’ä¿å­˜
        lastParliamentSeats = { ...stats.partyBases };

        // ãƒœã‚¿ãƒ³ã®è¿½åŠ 
        const footer = document.getElementById('elected-list');
        const btn = document.createElement('button');
        btn.innerText = "æœ€çµ‚çµæœã‚’æ‰¿èª";
        btn.style.cssText = "width:100%; padding:12px; margin-top:15px; background:#2ecc71; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;";

        // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆawardHTMLï¼‰ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆ
        btn.onclick = () => {
            closeUniversalModal();

            // é‡å…šãƒªã‚¹ãƒˆã®æ–‡å­—åˆ—ã‚’ä½œæˆ
            const rulingChange = seatChanges[rulingPartyName] || "";
            let awardHTML = `
    <div style="background:#f1c40f; padding:10px; border-radius:5px; margin-bottom:10px; color:#000;">
        <strong>ğŸ† ä¸å…š: ${rulingPartyName} ${rulingSeats}è­°å¸­ <span style="font-size:0.8em;">${rulingChange}</span></strong>
    </div>
`;

            const oppositionListHTML = oppositionParties.map(p => {
                const change = seatChanges[p[0]] || "";
                return `<li>${p[0]}: ${p[1]}è­°å¸­ <span style="font-size:0.8em;">${change}</span></li>`;
            }).join('');

            awardHTML += `
                    
                    <div style="background:#ecf0f1; padding:10px; border-radius:5px; margin-bottom:10px; color:#2c3e50;">
                        <strong>ğŸ›¡ï¸ é‡å…š (è¨ˆ ${totalOppositionSeats}è­°å¸­):</strong>
                        <ul style="margin:5px 0; padding-left:20px;">
                            ${oppositionListHTML}
                        </ul>
                    </div>

                    <hr>
                    <p>ğŸ¥‡ <strong>æœ€å¤šå¾—ç¥¨:</strong> ${stats.mvp} (${stats.mvpVotes}ç¥¨)</p>
                    <p>ğŸ›ï¸ <strong>ã‚ãªãŸã®çŠ¶æ³:</strong> 
                        <span style="color:${isPlayerInRuling ? '#27ae60' : '#e74c3c'}; font-weight:bold;">
                            ${isPlayerInRuling ? 'ä¸å…šã®ä¸€å“¡' : 'é‡å…š'}
                        </span> (${playerPartyName}: ${seatCounts[playerPartyName] || 0}è­°å¸­)
                    </p>
                </div>
<div style="font-size:0.8em; text-align:left; background:#f9f9f9; padding:10px; border-radius:5px; max-height:300px; overflow-y:auto;">
        <h4 style="color:#27ae60; border-bottom:1px solid #27ae60;">ğŸ‰ å½“é¸è€… (${report.reElected.length + report.newlyElected.length}å)</h4>
        <p style="color:#2c3e50;"><strong>å†é¸:</strong> ${report.reElected.join('ã€') || 'ãªã—'}</p>
        <p style="color:#2c3e50;"><strong>æ–°äºº:</strong> ${report.newlyElected.join('ã€') || 'ãªã—'}</p>

        <h4 style="color:#e74c3c; border-bottom:1px solid #e74c3c; margin-top:15px;">âŒ è½é¸ï¼ˆç¾è·ï¼‰</h4>
        <p style="color:#7f8c8d;">${report.defeated.join('ã€') || 'ãªã—'}</p>

        <h4 style="color:#e74c3c; border-bottom:1px solid #e74c3c; margin-top:15px;">âŒ è½é¸</h4>
        <p style="color:#7f8c8d;">${report.out.join('ã€') || 'ãªã—'}</p>

        <h4 style="color:#7f8c8d; border-bottom:1px solid #7f8c8d; margin-top:15px;">ğŸ‘´ å¼•é€€ãƒ»ä¸å‡ºé¦¬</h4>
        <p style="color:#7f8c8d;">${report.retired.join('ã€') || 'ãªã—'}</p>
    </div>
            `;
            openUniversalModal("ğŸ“Š é¸æŒ™çµæœç·æ‹¬", awardHTML, [{ text: "è­°ä¼šã‚’é–‰ã˜ã‚‹", cb: () => { closeUniversalModal(); setGameSpeed(1); } }]);
        };
        footer.appendChild(btn);
        isPlayerRunningForParliament = false;
        updateParliamentUI();
    }

    function updateElectedDisplay(currentSeats) {
        const container = document.getElementById('elected-list');
        const grouped = {};
        currentSeats.forEach(s => {
            if (!grouped[s.party.name]) grouped[s.party.name] = { color: s.party.color, members: [] };
            grouped[s.party.name].members.push(s.member);
        });

        container.innerHTML = Object.entries(grouped).map(([pName, data]) => `
                <div class= "party-block" style = "border-left: 5px solid ${data.color}" >
            <strong style="font-size:0.8em;">${pName} (${data.members.length})</strong><br>
            ${data.members.map(m => `
                <img src="${m.icon}" class="elected-member-icon" 
                    style="border-color:${data.color}" 
                    onclick="alert('${m.name}\\næ‰€å±: ${pName}\\nå¾—ç¥¨æ•°: ${m.votes}ç¥¨')"
                    title="${m.name}">
            `).join('')}
        </div>
    `).join('');
    }

    // Wikié¢¨ //
    // Wikipedia/ãƒ‹ãƒ¥ãƒ¼ã‚¹é¢¨ã®é¸æŒ™çµæœãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function generateWikiStyleTable(partyResults, totalSeats) {
        // 3ã¤ãšã¤ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†å‰²ã™ã‚‹é–¢æ•°
        const chunk = (arr, size) =>
            Array.from({ length: Math.ceil(arr.length / size) }, (v, i) =>
                arr.slice(i * size, i * size + size)
            );

        const partyChunks = chunk(partyResults, 3); // 3å…šã”ã¨ã«åˆ†å‰²

        let fullHtml = "";

        partyChunks.forEach((chunk, chunkIndex) => {
            // å„è¡Œã®åˆæœŸåŒ–ï¼ˆå·¦ç«¯ã®è¦‹å‡ºã—åˆ—ï¼‰
            let headerRow = `<th style="width:100px; background:#f0f0f0; border:1px solid #ccc; color:black;">å…šé †</th>`;
            let imageRow = `<th style="background:#f0f0f0; border:1px solid #ccc; color:black;">ç”»åƒ</th>`;
            let infoRow = `<th style="background:#f0f0f0; border:1px solid #ccc; color:black;">å…šåãƒ»å…šé¦–</th>`;
            let seatsRow = `<th style="background:#f0f0f0; border:1px solid #ccc; color:black;">ç²å¾—è­°å¸­</th>`;
            let changeRow = `<th style="background:#f0f0f0; border:1px solid #ccc; color:black;">å¢—æ¸›</th>`;
            let voteRow = `<th style="background:#f0f0f0; border:1px solid #ccc; color:black;">å¾—ç¥¨ç‡</th>`;

            chunk.forEach((p, index) => {
                const rank = (chunkIndex * 3) + index + 1;
                const rankColor = rank === 1 ? '#0000ff' : (rank === 2 ? '#0000cd' : '#4169e1');

                let changeHtml = `<span style="color:#999;">Â±0</span>`;
                if (p.change > 0) changeHtml = `<span style="color:#2ecc71; font-weight:bold;">â–²${p.change}</span>`;
                if (p.change < 0) changeHtml = `<span style="color:#e74c3c; font-weight:bold;">â–¼${Math.abs(p.change)}</span>`;

                headerRow += `<th style="color:${rankColor}; font-size:1.1em; padding:10px; border:1px solid #ccc; width:30%;">ç¬¬${rank}å…š</th>`;

                imageRow += `
                <td style="text-align:center; border:1px solid #ccc; padding:5px;">
                    <img src="${p.leaderImage}" style="width:70px; height:90px; object-fit:cover; border:1px solid #ccc; background:#eee;">
                </td>`;

                infoRow += `
                <td style="text-align:center; border:1px solid #ccc; vertical-align:top; padding:10px 5px;">
                    <div style="height:5px; background:${p.color}; width:80%; margin:0 auto 5px auto;"></div>
                    <div style="font-weight:bold; color:${p.color}; font-size:1em;">${p.name}</div>
                    <div style="font-size:0.85em; color:#555;">${p.leaderName}</div>
                </td>`;

                seatsRow += `
                <td style="text-align:center; font-size:1.4em; font-weight:bold; border:1px solid #ccc; padding:10px; color:black;">
                    ${p.seats}
                </td>`;

                changeRow += `
                <td style="text-align:center; border:1px solid #ccc; padding:10px; font-size:1em;">
                    ${changeHtml}
                </td>`;

                voteRow += `
                <td style="text-align:center; border:1px solid #ccc; padding:10px; color:black;">
                    <div style="font-size:0.85em;">${p.votes.toLocaleString()}ç¥¨</div>
                    <div style="font-size:0.75em; color:#666;">(${p.voteRate}%)</div>
                </td>`;
            });

            // 3å…šã«æº€ãŸãªã„å ´åˆã®ç©ºã‚»ãƒ«åŸ‹ã‚ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œé˜²æ­¢ï¼‰
            for (let i = chunk.length; i < 3; i++) {
                const emptyCell = `<td style="border:1px solid #ccc; background:#f9f9f9;"></td>`;
                headerRow += `<th style="border:1px solid #ccc; background:#f9f9f9;">-</th>`;
                imageRow += emptyCell;
                infoRow += emptyCell;
                seatsRow += emptyCell;
                changeRow += emptyCell;
                voteRow += emptyCell;
            }

            fullHtml += `
            <table style="width:100%; border-collapse:collapse; background:white; font-family:sans-serif; margin-bottom:20px; table-layout:fixed;">
                <tr style="background:#f0f0f0;">${headerRow}</tr>
                <tr>${imageRow}</tr>
                <tr>${infoRow}</tr>
                <tr>${seatsRow}</tr>
                <tr>${changeRow}</tr>
                <tr>${voteRow}</tr>
            </table>
        `;
        });

        return `
        <div style="overflow-x:auto; padding:5px;">
            <div style="background:#008000; color:white; padding:8px; font-weight:bold; text-align:center; border-radius:4px 4px 0 0; margin-bottom:-1px;">
                é¸æŒ™çµæœè©³ç´°ï¼ˆå„å…šå‹¢åŠ›ï¼‰
            </div>
            ${fullHtml}
        </div>
    `;
    }

    /* ä»£è¡¨é¸æŒ™ */
    function holdPartyLeaderElection(party) {
        // 1. å€™è£œè€…ã®é¸å®šï¼ˆè­°å“¡ã‚’å„ªå…ˆã€ã„ãªã‘ã‚Œã°å…¨ãƒ¡ãƒ³ãƒãƒ¼ï¼‰
        let mpMembers = party.members.filter(m => m.title === "è­°å“¡");
        let candidates = mpMembers.length > 0 ? mpMembers : party.members;

        if (candidates.length === 0) return; // ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„

        // 2. é¸å‡ºãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå¾—ç¥¨æ•°ã‚„è¦ªå’Œæ€§ã€ã‚ã‚‹ã„ã¯ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒ¡ãƒ³ãƒãƒ¼ã«ã„ã‚‹å ´åˆã¯ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¾—ç¥¨ã‚‚å«ã‚ã¦è¨ˆç®—
        candidates.sort((a, b) => {
            const scoreA = (a.votes || 0) + (a.prestige || 0);
            const scoreB = (b.votes || 0) + (b.prestige || 0);
            return scoreB - scoreA;
        });

        const newLeader = candidates[0];
        const oldLeader = party.leader;
        party.leader = newLeader;
        party.leaderTerm = 0; // ä»»æœŸãƒªã‚»ãƒƒãƒˆ
        party.nextLeaderElection = gameDate.getFullYear() + 3; // 3å¹´å¾Œ

        addLog(`${party.name}ã§ä»£è¡¨é¸ãŒè¡Œã‚ã‚Œã€${newLeader.name}ãŒé¸å‡ºã•ã‚Œã¾ã—ãŸã€‚`, "politics");
    }

    function addLog(message, type = "info") {
        const logContainer = document.getElementById('game-log'); // ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹HTMLè¦ç´ 
        if (!logContainer) return;

        const dateStr = `[${gameDate.getFullYear()}/${gameDate.getMonth() + 1}]`;
        const logEntry = document.createElement('div');

        // ç¨®é¡ã«ã‚ˆã£ã¦è‰²ã‚’å¤‰ãˆã‚‹
        let color = "#fff";
        if (type === "news") color = "#f1c40f";      // é»„è‰²ï¼ˆãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼‰
        if (type === "politics") color = "#3498db";  // é’ï¼ˆæ”¿æ²»ï¼‰
        if (type === "emergency") color = "#e74c3c"; // èµ¤ï¼ˆç·Šæ€¥ï¼‰
        if (type === "success") color = "#2ecc71";   // ç·‘ï¼ˆæˆåŠŸï¼‰

        logEntry.style.color = color;
        logEntry.style.marginBottom = "5px";
        logEntry.style.fontSize = "0.9em";
        logEntry.innerHTML = `<span style="color:#888;">${dateStr}</span> ${message}`;

        // ãƒ­ã‚°ã‚’è¿½åŠ ï¼ˆæ–°ã—ã„ã‚‚ã®ã‚’ä¸Šã«ï¼‰
        logContainer.prepend(logEntry);

        // ãƒ­ã‚°ãŒå¤šã™ãã‚‹ã¨é‡ããªã‚‹ã®ã§ã€100ä»¶è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ã‚’æ¶ˆã™
        if (logContainer.childNodes.length > 100) {
            logContainer.removeChild(logContainer.lastChild);
        }
    }

    function updatePartyLeaders() {
        if (isMajorElectionMonth()) return;

        const currentYear = gameDate.getFullYear();
        const currentMonth = gameDate.getMonth();

        parties.filter(p => p.active).forEach(party => {
            let needsElection = false;

            // A. ä»»æœŸæº€äº†ï¼ˆ3å¹´ï¼‰
            if (currentYear >= party.nextLeaderElection && currentMonth === 0) {
                needsElection = true;
            }

            // B. è­°å“¡è½é¸ã«ã‚ˆã‚‹è‡ªå‹•å¤±è·
            // å›½æ”¿æ”¿å…šï¼ˆè­°å¸­ã‚ã‚Šï¼‰ãªã®ã«ã€ä»£è¡¨ãŒè­°å“¡ã§ãªã„å ´åˆï¼ˆè½é¸ï¼‰
            const hasSeats = npcs.filter(n => n.partyId === party.id && n.title === "è­°å“¡").length > 0;
            if (hasSeats && party.leader && party.leader.title !== "è­°å“¡") {
                addLog(`${party.name}ã®${party.leader.name}ä»£è¡¨ã¯ã€è½é¸ã«ä¼´ã„ä»£è¡¨ã‚’è¾ä»»ã—ã¾ã—ãŸã€‚`, "news");
                needsElection = true;
            }

            // C. ãƒ©ãƒ³ãƒ€ãƒ ãªè¾ä»»ï¼ˆã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«ã€ç—…æ°—ã€å…šå†…æŠ—äº‰ãªã©ï¼‰
            // 1/200ã®ç¢ºç‡ã§ç™ºç”Ÿ
            if (!needsElection && Math.random() < 0.005) {
                const reasons = ["å¥åº·ä¸Šã®ç†ç”±", "ä¸ç¥¥äº‹ã®è²¬ä»»", "å…šå†…å¯¾ç«‹ã®æ¿€åŒ–", "æ”¯æŒç‡ä½è¿·"];
                const reason = reasons[Math.floor(Math.random() * reasons.length)];
                addLog(`${party.name}ã®${party.leader ? party.leader.name : 'ä»£è¡¨'}ãŒ${reason}ã§çªå¦‚è¾ä»»ã—ã¾ã—ãŸï¼`, "emergency");
                needsElection = true;
            }

            if (needsElection) {
                if (party.id === profile.partyId) {
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ‰€å±ã—ã¦ã„ã‚‹å…šã®å ´åˆï¼šå‡ºé¦¬ç¢ºèª
                    openCandidateDecisionModal(party);
                } else {
                    // ä»–å…šã®å ´åˆï¼šè‡ªå‹•ã§é¸å‡º
                    holdPartyLeaderElection(party);
                }
            }
        });
    }

    function openCandidateDecisionModal(party) {
        setGameSpeed(0); // ã‚²ãƒ¼ãƒ ã‚’ä¸€æ™‚åœæ­¢
        if (gameSettings.skipPartyElection) {
            // é€šçŸ¥ã‚ªãƒ•ãªã‚‰ã€Œç«‹å€™è£œã—ãªã„ï¼ˆfalseï¼‰ã€ã§å³é–‹å§‹
            startPartyElection(party, false);
            return;
        } else {
            const content = `
        <div style="text-align: center; padding: 10px;">
            <p style="font-size: 1.1em;"><b>${party.name}</b> ã®ä»£è¡¨ä»»æœŸãŒæº€äº†ã—ã¾ã—ãŸã€‚</p>
            <p>ã‚ãªãŸã¯ã“ã®ä»£è¡¨é¸æŒ™ã«ç«‹å€™è£œã—ã¾ã™ã‹ï¼Ÿ</p>
            <small style="color: #666;">ï¼ˆå½“é¸ã«ã¯å…šå†…ã§ã®å®Ÿç¸¾ã‚„æ”¯æŒãŒå¿…è¦ã§ã™ï¼‰</small>
        </div>
    `;

            openUniversalModal("ä»£è¡¨é¸ã¸ã®å‡ºé¦¬", content, [
                { text: "ç«‹å€™è£œã™ã‚‹", cb: () => startPartyElection(party, true), color: "#2ecc71" },
                { text: "ç«‹å€™è£œã—ãªã„", cb: () => startPartyElection(party, false), color: "#95a5a6" }
            ]);
        }
    }

    function startPartyElection(party, playerRunning) {
        // 1. æœ‰åŠ¹ãªå€™è£œè€…ã®æŠ½å‡º
        let playerObj = npcs.find(n => n.isPlayer || profile.id && String(n.id) === String(profile.id));
        if (!playerObj && playerRunning) {
            // é‡è¦ï¼šprofileã«IDãŒãªã„å ´åˆã‚‚è€ƒæ…®ã—ã¦ 'player' ã¨ã„ã†æ–‡å­—åˆ—ã‚’IDã«ã™ã‚‹
            playerObj = {
                ...profile,
                isPlayer: true,
                id: 'player', // å¼·åˆ¶çš„ã«IDã‚’å‰²ã‚ŠæŒ¯ã‚‹
                title: "å…šå“¡" // ã‚¿ã‚¤ãƒˆãƒ«ãŒãªãã¦è½ã¡ã‚‹ã®ã‚’é˜²ã
            };
        }
        const pid = (playerObj && 'id' in playerObj && playerObj.id) ? String(playerObj.id) : 'player';
        let potentialCands = (party.members || []).filter(m => m && typeof m === 'object');
        if (potentialCands.length < 2) potentialCands = [...party.members];
        let npcPool = potentialCands.filter(m => {
            // ã“ã“ãŒã‚¨ãƒ©ãƒ¼ã®ç¾å ´ï¼šm ã®å­˜åœ¨ã¯ä¸Šã§ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã ãŒã€å¿µã®ãŸã‚
            if (!m || m.id === undefined || m.id === null) {
                console.warn("ä¸æ­£ãªãƒ¡ãƒ³ãƒãƒ¼è¦ç´ ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ:", m);
                return false;
            }
            const mid = String(m.id);
            return mid !== pid && !m.isPlayer;
        });
        let mps = potentialCands.filter(m => m.title === "è­°å“¡");
        let pool = mps.length >= 2 ? mps : npcPool;
        let electionCands = pool
            .sort((a, b) => (b.votes || 0) - (a.votes || 0))
            .slice(0, 3);

        if (playerRunning === true) {
            // é‡è¤‡ãŒãªã„ã‹ç¢ºèªã—ã¦å…ˆé ­ã«è¿½åŠ 
            if (!electionCands.find(c => String(c.id) === String(playerObj.id))) {
                electionCands.unshift(playerObj);
            }
        } else {
            console.log("Player is not running in this election.");
        }

        if (electionCands.length === 0) {
            showToast("ã“ã®å…šã«ã¯ä»£è¡¨é¸ã®å€™è£œè€…ãŒã„ã¾ã›ã‚“ã€‚", "warning", "#e67e22");
            return;
        }

        // 3. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æŠ•ç¥¨ãƒ¢ãƒ¼ãƒ€ãƒ«
        let candButtons = electionCands.map(c => {
            const safeId = (c.isPlayer || !c.id) ? "player" : c.id;
            return `
        <button onclick="processPartyVote('${party.id}', '${c.id}', ${JSON.stringify(electionCands.map(cand => cand.id)).replace(/"/g, "'")})" 
                style="width: 100%; padding: 12px; margin-bottom: 8px; border: 1px solid #3498db; border-radius: 8px; background: white; cursor: pointer; display: flex; align-items: center; gap: 10px;">
            <img src="${c.icon}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">
            <div style="text-align: left;">
                <strong>${c.name} ${c.isPlayer ? "(ã‚ãªãŸ)" : ""}</strong><br>
                <small style="color: #666;">å½±éŸ¿åŠ›: ${Math.floor(c.votes || 0)}</small>
            </div>
        </button>
    `}).join('');

        openUniversalModal(`${party.name} ä»£è¡¨é¸ãƒ»æŠ•ç¥¨`, `
        <div style="text-align:left;">
            <p style="margin-bottom:15px; font-weight:bold;">ã‚ãªãŸã®1ç¥¨ã‚’èª°ã«æŠ•ã˜ã¾ã™ã‹ï¼Ÿ</p>
            ${candButtons}
        </div>
    `, []);
    }

    // 4. æŠ•ç¥¨å‡¦ç†ã¨ã€Œä»–å…šå“¡ã®ç¥¨ã€ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    function processPartyVote(partyId, playerVotedId, candIds) {
        const getPersonById = (id) => {
            // IDãŒ 'player' ã¾ãŸã¯ profile.id ã¨ä¸€è‡´ã™ã‚‹å ´åˆ
            if (id === "player" || (profile.id && String(id) === String(profile.id))) {
                return { name: profile.name, isPlayer: true, ideology: profile.ideology, votes: profile.votes || 0 };
            }
            return npcs.find(n => n && String(n.id) === String(id));
        };
        const party = parties.find(p => p.id === partyId);
        openUniversalModal("é–‹ç¥¨ä¸­...", `<div id="counting-area" style="text-align:left; line-height:1.8;"></div>`, []);

        const countingArea = document.getElementById('counting-area');

        // 1. æŠ•ç¥¨ç®±ã®åˆæœŸåŒ– (ã“ã“ã§NaNã‚’é˜²ã)
        let voteCounts = {};
        candIds.forEach(id => {
            voteCounts[String(id)] = 0; // IDã‚’æ–‡å­—åˆ—ã§çµ±ä¸€ã—ã¦ã‚­ãƒ¼ã«ã™ã‚‹
        });

        // 3. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®1ç¥¨ã‚’æŠ•ã˜ã‚‹
        if (voteCounts.hasOwnProperty(String(playerVotedId))) {
            voteCounts[String(playerVotedId)]++;
        }

        // 4. ä»–ã®å…šå“¡ï¼ˆNPCï¼‰ã®æŠ•ç¥¨
        const otherMembers = party.members.filter(m => String(m.id) !== String(profile.id));
        otherMembers.forEach(member => {
            let bestTarget = String(candIds[0]);
            let maxScore = -1;

            candIds.forEach(candId => {
                const cand = getPersonById(candId);
                if (!cand) return;

                // ã‚¹ã‚³ã‚¢è¨ˆç®— (æ€æƒ³ã®è¿‘ã• + å®Ÿç¸¾)
                const affinity = calculateAffinity(member.ideology, cand.ideology);
                const score = (cand.votes || 0) * 0.5 + affinity + (Math.random() * 50);

                if (score > maxScore) {
                    maxScore = score;
                    bestTarget = String(candId);
                }
            });
            voteCounts[bestTarget]++;
        });

        // 5. è¡¨ç¤ºã®ç”Ÿæˆ
        let logHtml = `<strong>ğŸ—³ï¸ é›†è¨ˆçµæœ:</strong><br><hr>`;
        const sortedResults = Object.entries(voteCounts).sort((a, b) => b[1] - a[1]);

        sortedResults.forEach(([id, count]) => {
            const person = getPersonById(id);
            const displayName = person ? (person.isPlayer ? `${person.name} (ã‚ãªãŸ)` : person.name) : `ä¸æ˜ãªå€™è£œè€…(ID:${id})`;

            // åˆ†æ¯ãŒ0ã§NaNã«ãªã‚‰ãªã„ã‚ˆã†ã‚¬ãƒ¼ãƒ‰
            const totalVotes = party.members.length || 1;
            const barWidth = (count / totalVotes) * 100;

            logHtml += `
            <div style="margin-bottom: 10px;">
                <div style="display:flex; justify-content:space-between; font-size:0.9em;">
                    <span>${displayName}</span><span>${count}ç¥¨</span>
                </div>
                <div style="width:100%; background:#eee; height:8px; border-radius:4px;">
                    <div style="width:${barWidth}%; background:${party.color}; height:100%; border-radius:4px; transition: width 1s;"></div>
                </div>
            </div>
        `;
        });

        // 6. çµæœã®ç¢ºå®š
        setTimeout(() => {
            countingArea.innerHTML = logHtml;
            const winnerId = sortedResults[0][0];
            const winner = getPersonById(winnerId);

            if (winner) {
                const btn = document.createElement('button');
                btn.innerText = "çµæœã‚’ç¢ºèª";
                btn.style = "width:100%; padding:10px; margin-top:10px; background:#34495e; color:white; border:none; border-radius:5px; cursor:pointer;";
                btn.onclick = () => finishPartyElection(party, winner);
                countingArea.appendChild(btn);
            }
        }, 1000);
    }

    function finishPartyElection(party, winner) {
        party.leader = winner;
        party.leaderTerm = 0;
        party.nextLeaderElection = gameDate.getFullYear() + 3;

        const isPlayer = winner.isPlayer;
        const speeches =
            [
                "ã¿ãªã•ã‚“ã€ç§ã¸ã®æŠ•ç¥¨ã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€å…šã®æœªæ¥ã‚’å…±ã«åˆ‡ã‚Šé–‹ã„ã¦ã„ãã¾ã—ã‚‡ã†ï¼",
                "éå¸¸ã«é‡ã„è²¬ä»»ã‚’æ„Ÿã˜ã¦ãŠã‚Šã¾ã™ã€‚ä¸€æ­©ãšã¤é€²ã¿ã¾ã—ã‚‡ã†ã€‚",
                "ã“ã®çµæœã¯ã€æŠ•ç¥¨ã—ã¦ãã‚ŒãŸçš†ã•ã‚“ã®ä¿¡é ¼ã®è¨¼ã ã¨å—ã‘æ­¢ã‚ã¦ã„ã¾ã™ã€‚å…¨åŠ›ã§é ‘å¼µã‚Šã¾ã™ï¼",
                "æ¥½ã—ã„ï¼ã“ã‚Œã‹ã‚‰ã¯ã¿ã‚“ãªã§ãƒ¯ã‚¤ãƒ¯ã‚¤ã‚„ã£ã¦ã„ãã¾ã—ã‚‡ã†ï¼",
                "ã“ã®çµæœã¯ã€ç§ãŸã¡ã®å›£çµã®åŠ›ã®è¡¨ã‚Œã§ã™ã€‚ã“ã‚Œã‹ã‚‰ã‚‚ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼",
                "çš†æ§˜ã€æœ¬å½“ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã“ã‚Œã‹ã‚‰ã¯ã€çš†æ§˜ã®æœŸå¾…ã«å¿œãˆã‚‰ã‚Œã‚‹ã‚ˆã†å…¨åŠ›ã‚’å°½ãã—ã¾ã™ï¼"
            ];

        const speech = speeches[Math.floor(Math.random() * speeches.length)];

        const resultHtml = `
        <div style="text-align: center;">
            <h2 style="color: #f1c40f;">å½“é¸ï¼š${winner.name}</h2>
            <img src="${winner.icon}" style="width:100px; height:100px; border-radius:50%; border:4px solid #f1c40f; margin:10px 0; object-fit:cover;">
            <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; border-left: 5px solid #ccc; font-style: italic;">
                ã€Œ${speech}ã€
            </div>
        </div>
    `;

        addLog(`${party.name}ã®ä»£è¡¨é¸ã§${winner.name}ãŒé¸å‡ºã•ã‚Œã¾ã—ãŸã€‚`, "politics");

        openUniversalModal("æ–°ä»£è¡¨å°±ä»»", resultHtml, [
            { text: "ä»Šå¾Œã®æ´»èºã‚’æœŸå¾…ã™ã‚‹", cb: () => closeUniversalModal(), color: "#34495e" }
        ]);
    }

    function isMajorElectionMonth() {
        // è­°ä¼šé¸æŒ™ã‚„å¤§çµ±é ˜é¸æŒ™ãŒã‚ã‚‹æœˆã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹æ—¢å­˜ã®ãƒ•ãƒ©ã‚°ã‚’ãƒã‚§ãƒƒã‚¯
        return typeof isElectionYear !== 'undefined' && isElectionYear && gameDate.getMonth() === 0;
    }
</script>

</html>